function Euterpe(){}function Euterpe(){}function Euterpe(){}Euterpe.TrebleClef=function(){function e(t){this.realWidth=36.8,t.location=0,e.super.call(this,"Euterpe.TrebleClef",t)}return Euterpe.extend(Euterpe.Node,e,{realHeight:[26.3,82],render:function(e,t,n){this.startX=e,this.startY=t-27*n,this.scale=.125*n;var r=this,i=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(159,3),e.quadraticCurveTo(129,50,117,93),e.quadraticCurveTo(107,126,102,167),e.quadraticCurveTo(101,192,102,210),e.quadraticCurveTo(107,255,116,297),e.quadraticCurveTo(63,351,44,375),e.quadraticCurveTo(24,401,15,429),e.quadraticCurveTo(2,464,3,503),e.quadraticCurveTo(5,540,20,575),e.quadraticCurveTo(29,596,48,615),e.quadraticCurveTo(62,630,87,645),e.quadraticCurveTo(113,660,150,666),e.quadraticCurveTo(177,668,194,665),e.quadraticCurveTo(204,720,213,776),e.quadraticCurveTo(216,795,216,813),e.quadraticCurveTo(203,849,158,857),e.quadraticCurveTo(132,857,120,842),e.quadraticCurveTo(152,845,166,813),e.quadraticCurveTo(165,821,168,802),e.quadraticCurveTo(166,775,151,765),e.quadraticCurveTo(132,750,107,758),e.quadraticCurveTo(86,768,78,789),e.quadraticCurveTo(71,818,90,840),e.quadraticCurveTo(105,857,129,865),e.quadraticCurveTo(149,872,177,865),e.quadraticCurveTo(194,860,209,846),e.quadraticCurveTo(231,828,230,803),e.quadraticCurveTo(221,735,207,662),e.quadraticCurveTo(248,650,267,626),e.quadraticCurveTo(293,599,296,566),e.quadraticCurveTo(300,527,285,494),e.quadraticCurveTo(270,462,234,444),e.quadraticCurveTo(215,435,189,435),e.quadraticCurveTo(177,435,164,438),e.quadraticCurveTo(155,396,146,354),e.quadraticCurveTo(183,315,203,275),e.quadraticCurveTo(219,243,222,210),e.quadraticCurveTo(227,167,221,137),e.quadraticCurveTo(213,93,192,51),e.quadraticCurveTo(180,29,159,3),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),s=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(191,93),e.quadraticCurveTo(179,83,171,93),e.quadraticCurveTo(126,162,131,281),e.quadraticCurveTo(188,239,203,188),e.quadraticCurveTo(209,162,204,135),e.quadraticCurveTo(200,111,191,93),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),o=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(171,473),e.quadraticCurveTo(188,555,206,648),e.quadraticCurveTo(237,639,255,620),e.quadraticCurveTo(283,588,283,558),e.quadraticCurveTo(285,525,269,501),e.quadraticCurveTo(252,476,216,470),e.quadraticCurveTo(194,465,171,473),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),u=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,446),e.quadraticCurveTo(141,411,132,369),e.quadraticCurveTo(90,401,68,435),e.quadraticCurveTo(45,467,39,503),e.quadraticCurveTo(30,540,45,576),e.quadraticCurveTo(60,612,92,633),e.quadraticCurveTo(123,651,161,654),e.quadraticCurveTo(174,654,188,653),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,444),e.quadraticCurveTo(120,456,101,480),e.quadraticCurveTo(83,504,84,536),e.quadraticCurveTo(86,567,107,588),e.quadraticCurveTo(114,597,126,605),e.quadraticCurveTo(116,593,107,581),e.quadraticCurveTo(95,560,99,537),e.quadraticCurveTo(105,509,132,491),e.quadraticCurveTo(143,482,164,476),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),f=[i,s,o,u,a];return Euterpe.bind(this,f),f}}),e}(),Euterpe.Column=function(){function e(t){e.super.call(this,"Euterpe.Column",t)}return Euterpe.extend(Euterpe.Container,e,{getRealWidth:function(e,t){var n=Euterpe.getMargins(this,e),r=this.collectItems(),i=_.max(_.map(r,function(n){var r=0,i=0;return n.isNode&&(r=n.getLeftWidth(e),i=n.getRightWidth(e)),n.getRealWidth(e,t)+(t?0:r+i)}));return i+(t?0:n)},getRealHeight:function(e,t){var n=this.collectItems();return Euterpe.getRealHeight(this,n,e,t)},collectItems:function(){var e=this.items;return _.isArray(this.config.aboveItems)&&(e=this.config.aboveItems.concat(this.items)),_.isArray(this.config.belowItems)&&(e=e.concat(this.config.belowItems)),e},render:function(e,t,n){var r=[],i,s,o=0,u=this.collectItems(),a=this.renderSideItems(u,n,r,e,t,!0);e+=a;for(s=0;s<u.length;s++)i=u[s],i.X=e,i.Y=Euterpe.getY(i,n,t),r.push(i.render(i.X,i.Y,n)),a=i.getRealWidth(n),a>o&&(o=a);return this.renderSideItems(this.items,n,r,e+o,t,!1),r},renderSideItems:function(e,t,n,r,i,s){var o=[],u=0,a=0;if(s)for(f=0;f<e.length;f++)e[f].isNode?(c=e[f].getLeftWidth(t),o.push(c),c>u&&(u=c)):o.push(0);for(var f=0;f<e.length;f++){var l=e[f],c=0,h=0;typeof o[f]!="undefined"&&o[f]!==u&&(h=u-o[f]);var p=s?l.leftItems:l.rightItems;for(var d=0;d<p.length;d++){var v=p[d];typeof v.config.location=="undefined"&&(v.config.location=l.config.location),v.X=r+v.leftMargin*t+h+c,v.Y=Euterpe.getY(v,t,i),n.push(v.render(v.X,v.Y,t)),c+=v.getRealWidth(t)}c>a&&(a=c)}return a},reduceWidth:function(e,t){return _.reduce(e,function(e,n){return e+n.getRealWidth(t)},0)}}),e}(),Euterpe.ContainerDepth=0,Euterpe.Container=function(){var e=function(e,t){this.id=Euterpe.randomString(20),this.items=[],this.name=this.name||e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=[],this.rightItems=[];if(typeof t!="undefined"&&_.isArray(t.items))for(var n=0;n<t.items.length;n++)this.add(t.items[n])};return e.prototype={getRealWidth:function(e,t){var n=t?0:Euterpe.getMargins(this,e);for(var r=0;r<this.items.length;r++)n+=this.items[r].getRealWidth(e,t);return n},getRealHeight:function(e,t){return Euterpe.getRealHeight(this,this.items,e,t)},isContainer:!0,getLeftWidth:function(e){var t=_.map(this.items,function(t){return t.getLeftWidth(e)});return _.max(t)},getRightWidth:function(e){var t=_.map(this.items,function(t){return t.getRightWidth(e)});return _.max(t)},clear:function(){this.items.length=0},size:function(){return this.items.length},add:function(e){var t=this;if(_.isArray(e))return _.each(e,function(e){t.add(e)});e.parent=this,this.items.push(e)},prepend:function(e){e.parentContainer=this,this.items.unshift(e)},insertBefore:function(e,t){for(var n=0;n<this.items.length;n++){var r=this.items[n];if(r.id===e)return this.items.splice(n,0,t)}},baseRender:function(e,t,n,r,i){Euterpe.ContainerDepth+=1;var s=[],o=function(e,t,n,r,i){var s=Euterpe.getY(e,r,n);return e.Y=s,e.render(t,s,r,i)};r=r||o,i=i||o;for(var u=0;u<this.items.length;u++){var a=this.items[u],f=0;Euterpe.log.debug((new Array(Euterpe.ContainerDepth)).join("  "),a),a.isContainer?(a.parentContainer=this,f=a.getRealWidth(n),a.X=e+a.leftMargin*n,a.Y=t,s.push(i(a,a.X,a.Y,n,u)),e+=f):(a.parentContainer=this,f=a.getRealWidth(n),a.X=e+a.leftMargin*n,a.Y=t,s.push(r(a,a.X,a.Y,n,u)),e+=f)}return Euterpe.ContainerDepth-=1,s},render:function(e,t,n){return Euterpe.baseRender(this.items,e,t,n)}},e}(),Euterpe.const={LOG_DEBUG:1,LOG_INFO:2,LOG_WARNING:3,LOG_ERROR:4},Euterpe.global={loglevel:Euterpe.const.LOG_INFO},Euterpe.plugins={plugins:[],add:function(){var e=this;_.each(arguments,function(t){e.plugins.push(t)})},fold:function(e,t,n){return _.reduce(this.plugins,function(e,r){return r.process(e,t,n)},e)}},Euterpe.getConfig=function(e,t,n){return typeof e=="undefined"?n:typeof e[t]=="undefined"?n:e[t]},Euterpe.getY=function(e,t,n){var r;if(typeof e=="number")r=e;else{if(typeof e.config=="undefined"||typeof e.config.location=="undefined")return n;r=e.config.location}if(typeof r=="function")return r(t,n);var i=Euterpe.global.linePadding/2+Euterpe.global.lineWidth/2,s,o,u;return r>=0?(o=Math.floor(r),u=Math.ceil(r)>r?i:0,s=Euterpe.global.linePadding*o+Euterpe.global.lineWidth*o,n+s+u):r<0?(o=Math.ceil(r),u=Math.floor(r)<r?i:0,s=Euterpe.global.linePadding*-o+Euterpe.global.lineWidth*-o,n+s*-1-u):n},Euterpe.initNode=function(e,t){e.isNode=!0,e.nodeName=t},Euterpe.extend=function(e,t,n){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t,t.super=e,typeof n=="object"&&_.extend(t.prototype,n)},Euterpe.render=function(e,t,n,r,i,s){Euterpe.initLog(),Euterpe.global.root=e,Euterpe.global.background=new Kinetic.Layer({}),Euterpe.global.foreground=new Kinetic.Layer({}),Euterpe.global.linePadding=13*i,Euterpe.global.lineWidth=i;var o=[],u=Euterpe.plugins.fold(e,i,o),a=u.getRealHeight(i,!0);n+=a[0];var f=n+a[1];Euterpe.stage=new Kinetic.Stage({container:s,width:r,height:f}),Euterpe.stage.add(Euterpe.global.foreground),Euterpe.stage.add(Euterpe.global.background);var l=_.flatten(u.render(t+e.leftMargin*i,n,i));for(var c=0;c<l.length;c++)l[c].layer2draw==="background"?Euterpe.global.background.add(l[c]):Euterpe.global.foreground.add(l[c]);for(var h=0;h<o.length;h++){var p=o[h],d=p(u,i);if(typeof d=="undefined")continue;d.layer2draw==="background"?Euterpe.global.background.add(d):Euterpe.global.foreground.add(d)}return Euterpe.stage},Euterpe.getMargins=function(e,t){return e.leftMargin*t+e.rightMargin*t},Euterpe.randomString=function(e){return(new Array(e+1)).join((Math.random().toString(36)+"00000000000000000").slice(2,18)).slice(0,e)},Euterpe.select=function(e,t){var n=function(t){return e[0]==="#"?t.id===e.slice(1,e.length):t.name===e};t=t||Euterpe.global.root;var r=[];if(t.isNode&&n(t))r.push(t);else if(t.isContainer)for(var i=0;i<t.items.length;i++){var s=t.items[i];n(s)&&r.push(s),s.isContainer&&r.push(Euterpe.select(e,s))}return _.flatten(r)},Euterpe.replace=function(e,t,n){for(var r=0;r<e.items.length;r++){var i=e.items[r];if(i.id==t)return n.parentContainer=e,e.items[r]=n,!0;if(i.isContainer&&Euterpe.replace(i,t,n))break}return!1},Euterpe.initLog=function(){var e=window.console||{},t=function(){};Euterpe.log={debug:t,info:t,warn:t,error:t},Euterpe.const.LOG_DEBUG>=Euterpe.global.loglevel&&e.log&&(Euterpe.log.debug=e.debug.bind(e)),Euterpe.const.LOG_INFO>=Euterpe.global.loglevel&&e.info&&(Euterpe.log.info=e.info.bind(e)),Euterpe.const.LOG_WARNING>=Euterpe.global.loglevel&&e.warn&&(Euterpe.log.warn=e.warn.bind(e)),Euterpe.const.LOG_ERROR>=Euterpe.global.loglevel&&e.error&&(Euterpe.log.error=e.error.bind(e))},Euterpe.getDistance=function(e,t,n){var r=0;for(var i=0;i<e.items.length;i++){var s=e.items[i];if(s.id===t.id)break;if(s.isContainer&&Euterpe.select("#"+t.id,s).length>0){r+=s.leftMargin*n,r+=Euterpe.getDistance(s,t,n);break}r+=s.getRealWidth(n)}return r},Euterpe.getRealHeight=function(e,t,n,r){var i=0,s,o,u,a,f;typeof e.realHeight!="undefined"&&(f=Euterpe.getY(e,n,i),s=e.realHeight[0]*n,o=e.realHeight[1]*n);for(var l=0;l<t.length;l++){var c=t[l],h=c.getRealHeight(n,!0);f=Euterpe.getY(c,n,i),u=f-h[0],a=f+h[1];if(typeof s=="undefined"||u<s)s=u;if(typeof o=="undefined"||a>o)o=a}return r?[s*-1,o]:o-s},Euterpe.baseRender=function(e,t,n,r){var i=[],s,o;for(o=0;o<e.length;o++)s=e[o],s.X=t,s.Y=Euterpe.getY(s,r,n),i.push(s.render(s.X,s.Y,r)),t+=s.getRealWidth(r);return i},Euterpe.getGroups=function(e){var t=[],n=null,r=null,i=null,s=[],o=null;for(var u=0;u<e.length;u++){var a=e[u];typeof a.group!="undefined"?(n!==a.group&&(n!==null&&t.push({first:i,last:o,groupType:r,items:_.clone(s)}),i=a.id,n=a.group,r=a.groupType,s.length=0),s.push(a)):t.push({first:undefined,last:undefined,groupType:undefined,items:[a]}),o=a.id}return s.length>0&&t.push({first:i,last:o,groupType:r,items:s}),t},Euterpe.bind=function(e,t){if(typeof e.config.on=="undefined")return;_.isArray(t)?t=_.flatten(t):t=[t];var n={},r=function(r,i){return function(){i.call(r,e,t,n)}},i=_.keys(e.config.on);for(var s=0;s<i.length;s++){var o=i[s];_.each(t,function(t){t.on(o,r(t,e.config.on[o]))})}},Euterpe.Flat=function(){function e(t){this.realWidth=12.25,this.realHeight=[16.3,9],e.super.call(this,"Euterpe.Flat",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=(this.realHeight[0]+this.realHeight[1])*n;this.barWidth=1.5*n,t-=16.25*n;var i=new Kinetic.Line({points:[0,0,0,r],stroke:"black",strokeWidth:this.barWidth,x:e,y:t}),s=t+r,o=e+this.barWidth/2,u=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,s),e.lineTo(o+7*n,s-5.25*n),e.bezierCurveTo(o+12*n,s-8.75*n,o+12.5*n,s-19.75*n,o,s-13.75*n),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,s-1.25*n),e.bezierCurveTo(o+9.75*n,s-6.75*n,o+8.25*n,s-17.25*n,o,s-12.75*n),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),f=[i,u,a];return Euterpe.bind(this,f),f}}),e}(),Euterpe.helpers={},Euterpe.helpers.events={highlight:function(e,t){function n(n,r,i){typeof i.fill=="undefined"&&(i.fill={}),typeof i.stroke=="undefined"&&(i.stroke={});for(var s=0;s<r.length;s++){var o=r[s];o.fill()===e&&(i.fill[o._id]=e,o.fill(t)),o.stroke()===e&&(i.stroke[o._id]=e,o.stroke(t))}Euterpe.global.background.draw(),Euterpe.global.foreground.draw()}function r(e,t,n){for(var r=0;r<t.length;r++){var i=t[r];typeof n.fill[i._id]!="undefined"&&i.fill(n.fill[i._id]),typeof n.stroke[i._id]!="undefined"&&i.stroke(n.stroke[i._id])}Euterpe.global.background.draw(),Euterpe.global.foreground.draw()}return[n,r]}},Euterpe.KeySignature=function(){function e(t){this.type=Euterpe.getConfig(t,"type"),this.amount=Euterpe.getConfig(t,"amount");if(this.type!=="sharp"&&this.type!=="flat")throw"Invalid type argument";if(typeof this.amount!="number"||this.amount<1||this.amount>7)throw"amount should be >= 1 and <= 7";e.super.call(this,t);var n={sharp:[0,1.5,-0.5,1,2.5,.5,2],flat:[2,.5,2.5,1,3,1.5,3.5]};for(var r=0;r<this.amount;r++){var i={location:n[this.type][r]};this.add(this.type==="sharp"?new Euterpe.Sharp(i):new Euterpe.Flat(i))}}return Euterpe.extend(Euterpe.Container,e),e}(),Euterpe.Natural=function(){function e(t){this.realWidth=11.5,this.realHeight=[20.5,21.5],e.super.call(this,"Euterpe.Natural",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=1.5*n,i=28*n,s=10*n,o=2.5*n,u=1.5*n;t-=i/2+i/4;var a=new Kinetic.Rect({width:r,height:i,fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1,x:e,y:t}),f=a.clone({x:e+s,y:t+i/2}),l,c,h=new Kinetic.Shape({sceneFunc:function(n){l=e,c=t+i/2,n.beginPath(),n.moveTo(l,c),n.lineTo(l+s+r,c-u),n.lineTo(l+s+r,c+o),n.lineTo(l,c+o+u),n.lineTo(l,c),n.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1}),p=h.clone({sceneFunc:function(n){l=e,c=t+i-o,n.beginPath(),n.moveTo(l,c),n.lineTo(l+s+r,c-u),n.lineTo(l+s+r,c+o),n.lineTo(l,c+o+u),n.lineTo(l,c),n.fillStrokeShape(this)}}),d=[a,f,h,p];return Euterpe.bind(this,d),d}}),e}(),Euterpe.Node=function(){var e=function(e,t){this.id=Euterpe.randomString(20),this.name=e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=Euterpe.getConfig(t,"leftItems",[]),this.rightItems=Euterpe.getConfig(t,"rightItems",[])};return e.prototype.isNode=!0,e.prototype.getLeftWidth=function(e){return this.reduceWidth(this.leftItems,e)},e.prototype.getRightWidth=function(e){return this.reduceWidth(this.rightItems,e)},e.prototype.getRealWidth=function(e,t){var n=Euterpe.getMargins(this,e);return this.realWidth*e+(t?0:n)},e.prototype.getRealHeight=function(e,t){return typeof this.realHeight=="undefined"?t?[0,0]:0:t?[this.realHeight[0]*e,this.realHeight[1]*e]:this.realHeight[0]*e+this.realHeight[1]*e},e.prototype.clone=function(){var e=new this.constructor(this.config);return e.parentContainer=this.parentContainer,e},e.prototype.reduceWidth=function(e,t){return _.reduce(e,function(e,n){return e+n.getRealWidth(t)},0)},e}(),Euterpe.Note=function(){function e(t){this.type=Euterpe.getConfig(t,"type","quarter"),this.beamDir=Euterpe.getConfig(t,"beamDirection",undefined),this.flags=Euterpe.getConfig(t,"flags",0),this.dots=Euterpe.getConfig(t,"dots",0),this.beam=undefined,e.super.call(this,"Euterpe.Note",t),this.headHeight=13.3,this.realHeight=[this.headHeight/2,this.headHeight/2],this.type==="whole"?this.realWidth=this.headWidth=21.2:this.realWidth=this.headWidth=13.6,this.dotWidth=4.5,this.dotMargin=2.5,this.calculateSize()}return Euterpe.extend(Euterpe.Node,e,{beamRealHeight:35,calculateSize:function(){this.beamDir==="up"?this.realHeight=[this.beamRealHeight,this.headHeight/2]:this.beamDir==="down"&&(this.realHeight=[this.headHeight/2,this.beamRealHeight]),this.realWidth+=(this.dotMargin+this.dotWidth)*this.dots,this.flags>0&&(this.realWidth+=13.3)},render:function(e,t,n){this.beamWidth=1.3*n,this.beamHeight=this.beamRealHeight*n,this.scale=n,this.startX=e+this.headWidth*n/2,this.startY=t;var r=[];switch(this.type){case"whole":r=this.initWhole();break;default:r=this.initHalfQuarter()}if(this.dots>0){var i=0,s=this.location;s%1===0&&(i=3*n);var o=e+this.headWidth*n;for(var u=this.dots;u>0;u--)o+=this.dotMargin*n+this.dotWidth*n/2,r.push(new Kinetic.Ellipse({x:o,y:this.Y-i,radius:{x:2*this.scale,y:2*this.scale},fill:"black"})),o+=this.dotWidth*n/2}return Euterpe.bind(this,r),r},initWhole:function(){var e=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:10.5*this.scale,y:6.5*this.scale},fill:"black"}),t=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:5.5*this.scale,y:4*this.scale},fill:"white"});return t.rotation(45),[e,t]},initHalfQuarter:function(){var e=[],t=this,n=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:7.6*this.scale,y:5.6*this.scale},fill:"black"});n.rotation(140),e.push(n);if(this.type==="half"){var r=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:6.6*this.scale,y:2.5*this.scale},fill:"white"});r.rotation(140),e.push(r)}var i,s;if(typeof this.beamDir=="string"){this.beamDir==="up"?(i=n.x()+n.width()/2-this.beamWidth-this.beamWidth/3,s=n.y(),this.beam=new Kinetic.Line({points:[0,0,0,-this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:i,y:s}),e.push(this.beam)):this.beamDir==="down"&&(i=n.x()-n.width()/2+this.beamWidth+this.beamWidth/3,s=n.y(),this.beam=new Kinetic.Line({points:[0,0,0,this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:i,y:s}),e.push(this.beam));if(this.flags==1){var o=this.beam.x(),u=this.beam.y()-this.beamHeight,a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,u),e.bezierCurveTo(o+6.2*t.scale,u+11.8*t.scale,o+21.4*t.scale,u+10.4*t.scale,o+10*t.scale,u+26.4*t.scale),e.bezierCurveTo(o+19.6*t.scale,u+12.4*t.scale,o+5.4*t.scale,u+10.4*t.scale,o-.2*t.scale,u+7.4*t.scale),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:1});e.push(a)}}return Euterpe.bind(this,e),e}}),e}(),Euterpe.PluginAboveBelow=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAboveBelow",t)};return Euterpe.extend(Euterpe.Plugin,e,{roundLine:function(e){var t,n;return e<0?(t=e-Math.ceil(e),t===0?n=e:t>=-0.5?n=Math.ceil(e)-.5:n=Math.floor(e),n):(t=e-Math.floor(e),t===0?n=e:t<=.5?n=Math.floor(e)+.5:n=Math.ceil(e),n)},place:function(e,t,n,r){var i=0,s,o,u,a;typeof r=="number"?s=r:n==="above"?s=0:n==="below"&&(s=4);for(var f=0;f<e.length;f++){var l=e[f];o=l.getRealHeight(t,!0),u=o[0]/this.lineH,a=o[1]/this.lineH,n==="above"?(i=s-this.roundLine(a),s=i-this.roundLine(u)):n==="below"&&(i=s+this.roundLine(a),s=i+this.roundLine(u)),l.config.location=i}},process:function(e,t){this.lineH=Euterpe.global.linePadding+Euterpe.global.lineWidth;var n=Euterpe.select("Euterpe.Column",e);for(var r=0;r<n.length;r++){var i=n[r],s=i.config,o=i.getRealHeight(t,!0),u=this.roundLine(o[0]/this.lineH*-1),a=this.roundLine(o[1]/this.lineH);a<4&&(a=4),_.isArray(s.aboveItems)&&this.place(s.aboveItems,t,"above",u),_.isArray(s.belowItems)&&this.place(s.belowItems,t,"below",a)}return e}}),e}(),Euterpe.PluginAccidentals=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAccidentals",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){var t=Euterpe.select("Euterpe.Note",e);for(var n=0;n<t.length;n++){var r=t[n];if(typeof r.config.sharp=="undefined"&&typeof r.config.flat=="undefined")continue;var i=r.config.sharp||r.config.flat;for(var s=0;s<i;s++)typeof r.config.sharp!="undefined"?r.leftItems.push(new Euterpe.Sharp({})):typeof r.config.flat!="undefined"&&r.leftItems.push(new Euterpe.Flat({}))}return e}}),e}(),Euterpe.PluginAlign=function(){var e=function(t){this.totalWidth=Euterpe.getConfig(t,"totalWidth"),this.nodeMargin=Euterpe.getConfig(t,"nodeMargin",5),this.sideMargin=Euterpe.getConfig(t,"sideMargin",3),e.super.call(this,"Euterpe.PluginAlign",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t){var n,r;for(n=0;n<e.items.length;n++){r=e.items[n];var i,s=this.collectNodes(r);for(i=0;i<s.length;i++)s[i].leftMargin=this.nodeMargin;this.alignSideItems(r)}var o=Euterpe.getGroups(e.items);for(n=0;n<o.length;n++)this.processGroup(o[n],t);return e},alignSideItems:function(e){var t=Euterpe.select("Euterpe.Column",e);for(var n=0;n<t.length;n++){var r=t[n];for(var i=0;i<r.items.length;i++){var s=r.items[i],o;for(o=0;o<s.leftItems.length;o++)s.leftItems[o].rightMargin=this.sideMargin;for(o=0;o<s.rightItems.length;o++)s.rightItems[o].leftMargin=this.sideMargin}}},getColsBars:function(e){var t=[];for(var n=1;n<e.items.length;n++){var r=e.items[n];(r.name==="Euterpe.Column"||r.name==="Euterpe.Bar")&&t.push(r)}return t},stretchAlign:function(e,t){var n=e.getRealWidth(t),r=this.getColsBars(e),i=this.totalWidth-n,s=i/r.length/t;for(var o=0;o<r.length;o++)r[o].leftMargin+=s},getCols:function(e,t){return _.map(e,function(e){return e[t]})},cleanGroup:function(e){var t=[];for(var n=0;n<e.items.length;n++)t[n]=this.getColsBars(e.items[n]);return t},processGroup:function(e,t){var n=this.cleanGroup(e),r,i,s,o,u=_.max(_.map(n,function(e){return e.length}));for(r=0;r<u;r++){o=this.getCols(n,r);var a={},f={},l={};for(i=0;i<o.length;i++){s=o[i];if(typeof s=="undefined")continue;a[s.id]=Euterpe.getDistance(s.parent,s,t)+s.leftMargin*t+s.getLeftWidth(t),f[s.id]=s.getRealWidth(t,!0),l[s.id]=s.getRightWidth(t)}var c=_.max(_.values(a)),h=_.max(_.values(f)),p=_.max(_.values(l));for(i=0;i<o.length;i++){s=o[i];if(typeof s=="undefined")continue;var d=a[s.id],v=f[s.id],m=l[s.id];d<c&&(s.leftMargin+=(c-d)/t),v<h&&(s.rightMargin+=(h-v)/t),m<p&&(s.rightMargin+=(p-m)/t)}}var g=this;_.each(e.items,function(e){g.stretchAlign(e,t)})},collectNodes:function(e){return _.filter(e.items,function(e){return e.name!=="Euterpe.Bar"&&e.name!=="Euterpe.Column"})}}),e}(),Euterpe.Plugin=function(){var e=function(e,t){this.name=e,this.config=t||{}};return e.prototype.isPlugin=!0,e.prototype.process=function(e){return e},e}(),Euterpe.PluginNoteBar=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteBar",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t,n){var r=Euterpe.select("Euterpe.Column",e),i=[],s=[],o=1,u={};for(var a=0;a<r.length;a++){var f=r[a];for(var l=0;l<f.items.length;l++){var c=f.items[l],h=c.config||{};if(h.bar==="begin"||h.bar==="cont"||h.bar==="end")o=h.beamDirection==="down"?-1:1,u[i.length]=o,c.flags=0,s.push(c.id),h.bar==="end"&&(this.adjustBeamHeight(s,o),i.push(_.clone(s)),s.length=0)}}for(var p=0;p<i.length;p++)n.push(this.bind(i[p],u[p]));return e},getTopTwo:function(e,t){var n=_.clone(e);return n.sort(function(e,n){return t===1?e.config.location-n.config.location:n.config.location-e.config.location}),n.length>2?[n[0],n[1]]:n},adjustBeamHeight:function(e,t){e=_.map(e,function(e){return Euterpe.select("#"+e)[0]});if(e.length>2){var n=this.getTopTwo(e,t),r=function(e,n){return Euterpe.getY(e,scale,n)-e.beamRealHeight*scale*t},i=n[0],s=n[1],o=i.parent.parent,u=Euterpe.getDistance(o,i,scale),a=Euterpe.getDistance(o,s,scale);for(var f=0;f<e.length;f++){var l=Math.abs(Euterpe.getY(e[f],scale,0)),c=r(i,l),h=r(s,l),p=(h-c)/(a-u),d=Euterpe.getDistance(o,e[f],scale),v=r(e[f],l),m=p*(d-u)+c,g=v-m;g!==0&&(e[f].beamRealHeight+=g*t/scale,e[f].calculateSize())}}},bind:function(e,t){return function(n,r){var i=Euterpe.select("#"+e[0])[0],s=Euterpe.select("#"+e[e.length-1])[0],o=i.beam.x(),u=i.beam.y()-i.beamHeight*t,a=s.beam.x(),f=s.beam.y()-s.beamHeight*t,l=4*r,c=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,u),e.lineTo(a,f),e.lineTo(a,f+l*t),e.lineTo(o,u+l*t),e.moveTo(o,u),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0});return c}}}),e}(),Euterpe.PluginNoteText=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteText",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){var t=Euterpe.select("Euterpe.Note",e);for(var n=0;n<t.length;n++){var r=t[n];if(typeof r.config.text=="undefined")continue;var i=new Euterpe.Text({text:r.config.text});r.leftItems.push(i)}return e}}),e}(),Euterpe.PluginTab=function(){var e=function(t){e.super.call(this,"Euterpe.PluginTab",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){for(var t=0;t<e.items.length;t++){var n=e.items[t],r=new Euterpe.Row({type:"tab"});for(var i=0;i<n.items.length;i++){var s=n.items[i];if(s.name=="Euterpe.Bar"){r.add(s.clone());continue}var o=new Euterpe.Column({}),u=Euterpe.select("Euterpe.Note",s);for(var a=0;a<u.length;a++){var f=u[a];typeof f.config.tab_location=="number"&&typeof f.config.tab_text=="string"&&(n.group=t.toString(),n.groupType="bracket",r.group=n.group,r.groupType=n.groupType,o.add(new Euterpe.Text({text:f.config.tab_text,location:f.config.tab_location})))}r!==null&&o.items.length>0&&r.add(o)}typeof r.group!="undefined"&&e.items.splice(t+1,0,r)}return e}}),e}(),Euterpe.Rest=function(){function e(t){this.type=Euterpe.getConfig(t,"type","long"),e.super.call(this,"Euterpe.Rest",t),this.basicWidth=7;switch(this.type){case"long":this.realWidth=this.basicWidth,this.realHeight=[0,28];break;case"double_whole":this.realWidth=this.basicWidth,this.realHeight=[0,14.5];break;case"whole":this.realWidth=20,this.realHeight=[0,8];break;case"half":this.realWidth=20,this.realHeight=[6,0];break;case"quarter":this.realWidth=20,this.realHeight=[16.75,22.25];break;case"eighth":this.realWidth=20,this.realHeight=[9.5,16.25];break;case"sixteenth":this.realWidth=20,this.realHeight=[9.5,30.25];break;case"thirty-second":this.realWidth=25,this.realHeight=[9.5,43.25];break;case"sixty-fourth":this.realWidth=30,this.realHeight=[9.5,55.75]}}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=e+this.getRealWidth(n)/2,i=[];switch(this.type){case"half":i.push(this.initHalf(r,t,n));break;case"quarter":i.push(this.initQuarter(r,t,n));break;case"eighth":i.push(this.initEighth(r,t,n));break;case"sixteenth":i.push(this.initSixteen(r,t,n));break;case"thirty-second":i.push(this.initThirtySecond(r,t,n));break;case"sixty-fourth":i.push(this.initSixtyFourth(r,t,n));break;default:i.push(this.simpleRestShape(r,t,n))}return Euterpe.bind(this,i),i},initHalf:function(e,t,n){var r=this.getRealHeight(n,!0);return this.simpleRestShape(e,t-r[0],n)},initQuarter:function(e,t,n){var r=n*.125,i=this.getRealHeight(n,!0),s=t-i[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(r,r),t.beginPath(),t.moveTo(100.2,80.7),t.bezierCurveTo(100.2,100.2,61.1,129.6,61.1,168.7),t.bezierCurveTo(61.1,183.4,90.4,227.5,110,251.9),t.bezierCurveTo(100.2,247,90.4,242.1,75.8,242.1),t.bezierCurveTo(46.4,242.1,36.6,266.6,36.6,281.3),t.bezierCurveTo(36.6,291.1,46.4,300.9,51.3,310.7),t.bezierCurveTo(21.9,291.1,2.4,271.5,2.4,251.9),t.bezierCurveTo(2.4,203,35.8,220.1,60.2,210.3),t.bezierCurveTo(35.8,185.9,12.1,149.2,12.1,134.5),t.bezierCurveTo(12.1,124.7,41.5,90.4,51.3,66),t.lineTo(51.3,51.3),t.bezierCurveTo(51.3,36.6,41.5,17,36.6,2.4),t.bezierCurveTo(56.2,26.8,100.2,70.9,100.2,80.7),t.lineTo(100.2,80.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initEighth:function(e,t,n){var r=n*.125,i=this.getRealHeight(n,!0),s=t-i[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(r,r),t.beginPath(),t.moveTo(92.9,5.2),t.bezierCurveTo(90.4,14.4,88.4,21.5,88.1,21.9),t.bezierCurveTo(84.9,28.7,78.5,37.2,73.6,42.1),t.bezierCurveTo(68.4,47.3,65.5,48.2,61.1,46.5),t.bezierCurveTo(57.4,44.5,56.2,42.4,53.8,31.5),t.bezierCurveTo(51.7,23.4,50.2,19,46.9,15.8),t.bezierCurveTo(38.4,6.5,23.8,5.3,12.6,12.6),t.bezierCurveTo(7.3,16.2,3.3,21.9,.9,28),t.bezierCurveTo(0,31.1,0,32,0,36.4),t.bezierCurveTo(0,40.9,0,42.4,.9,44.9),t.bezierCurveTo(3.6,53.8,9.3,60.7,18.2,64.7),t.bezierCurveTo(24.7,68,27.1,68.4,36,68.4),t.bezierCurveTo(42.5,68.4,44.5,68.4,49.8,67.5),t.bezierCurveTo(57.1,66.3,64.7,63.9,73.2,61.5),t.lineTo(78.5,59.4),t.lineTo(78.5,60.7),t.bezierCurveTo(78,62.3,44.1,190,43.7,190.8),t.bezierCurveTo(43.3,192.4,50.6,195.6,55,195.6),t.bezierCurveTo(59.4,195.6,65.9,192.8,66.3,190.8),t.bezierCurveTo(66.7,190.4,86.1,106.8,110.3,5.1),t.bezierCurveTo(107.1,-2.6,98.1,-0.8,92.9,5.2),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixteen:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.moveTo(132.4,0),t.bezierCurveTo(126.7,0,121.8,4.5,120.8,9.5),t.bezierCurveTo(118,21.7,117.1,25.3,116.8,26.1),t.bezierCurveTo(114.2,31.6,107.4,42.3,102.3,47.8),t.bezierCurveTo(96.7,52.9,94.2,53.8,89.5,52.1),t.bezierCurveTo(85.7,50,84.4,47.8,81.9,36.3),t.bezierCurveTo(79.7,27.8,78,23.1,74.6,19.8),t.bezierCurveTo(65.6,9.9,50.3,8.6,38.3,16.3),t.bezierCurveTo(32.8,20.2,28.6,26.1,26,32.6),t.bezierCurveTo(25.1,35.9,25.1,36.8,25.1,41.5),t.bezierCurveTo(25.1,47.8,25.6,51.3,28.6,56.3),t.bezierCurveTo(32.8,64.9,41.8,71.7,52,74.2),t.bezierCurveTo(63.1,77.2,81.4,74.7,102.3,67.9),t.bezierCurveTo(105.2,66.6,108.2,65.7,108.2,65.7),t.bezierCurveTo(108.2,66.2,104.8,80.2,101,97.7),t.bezierCurveTo(94.6,127.5,94.2,129.7,92,133.4),t.bezierCurveTo(88.6,140.7,81,151,75.8,155.6),t.bezierCurveTo(71.6,159.5,68.7,160.3,64.4,158.6),t.bezierCurveTo(60.6,156.5,59.2,154.3,56.7,142.9),t.bezierCurveTo(54.5,134.3,52.9,129.7,49.4,126.2),t.bezierCurveTo(40.5,116.4,25.1,115.2,13.2,122.8),t.bezierCurveTo(7.7,126.7,3.4,132.6,.9,139),t.bezierCurveTo(0,142.5,0,143.3,0,148),t.bezierCurveTo(0,154.3,.4,157.7,3.4,162.8),t.bezierCurveTo(7.7,171.4,16.6,178.2,26.9,180.8),t.bezierCurveTo(37.9,183.7,59.2,180.8,80.1,173.5),t.bezierCurveTo(82.7,172.7,84.4,172.3,84.4,172.3),t.bezierCurveTo(84.4,172.7,54.5,306.4,53.3,310.7),t.bezierCurveTo(53.3,311.6,53.7,312,55.4,312.8),t.bezierCurveTo(58,314.5,62.2,315.9,65.2,315.9),t.bezierCurveTo(68.2,315.9,72.4,314.5,75,312.8),t.bezierCurveTo(76.7,312,77.2,311.6,77.6,309.4),t.bezierCurveTo(77.6,308.2,100.1,196.1,127.9,60.2),t.bezierCurveTo(131.9,40.2,133.1,33.9,136.5,17),t.bezierCurveTo(137.7,11.1,139.7,0,132.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initThirtySecond:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.moveTo(154.4,0),t.bezierCurveTo(152.8,0,146,0,144.3,7.4),t.bezierCurveTo(141.2,20.7,140.5,22.5,138.9,25.3),t.bezierCurveTo(134.2,35.1,127.5,44.5,122.7,47.5),t.bezierCurveTo(120.2,49.2,118,49.2,115.1,47.9),t.bezierCurveTo(111.2,45.8,109.9,43.6,107.4,32.1),t.bezierCurveTo(105.2,23.6,103.6,18.9,100.1,15.5),t.bezierCurveTo(91.2,5.7,75.8,4.5,63.9,12.1),t.bezierCurveTo(58.4,15.9,54.1,21.9,51.6,28.3),t.bezierCurveTo(50.7,31.7,50.7,32.5,50.7,37.2),t.bezierCurveTo(50.7,43.6,51.1,47.1,54.1,52.2),t.bezierCurveTo(58.4,60.7,67.3,67.5,77.6,70),t.bezierCurveTo(82.3,71.4,94.2,71.4,102.3,70),t.bezierCurveTo(109.1,68.8,117.2,66.6,125.3,64.1),t.bezierCurveTo(129.1,62.8,131.7,61.9,132.1,61.9),t.bezierCurveTo(132.1,62.3,117.6,126.3,116.8,128.4),t.bezierCurveTo(114.2,133.9,107.4,144.6,102.3,150.1),t.bezierCurveTo(96.7,155.2,94.2,156.1,89.5,154.4),t.bezierCurveTo(85.7,152.3,84.4,150.1,81.9,138.6),t.bezierCurveTo(79.7,130.1,78,125.4,74.6,122.1),t.bezierCurveTo(65.6,112.2,50.3,111,38.3,118.6),t.bezierCurveTo(32.8,122.5,28.6,128.4,26,134.9),t.bezierCurveTo(25.1,138.2,25.1,139.1,25.1,143.8),t.bezierCurveTo(25.1,150.1,25.6,153.6,28.6,158.7),t.bezierCurveTo(32.8,167.2,41.8,174,52,176.5),t.bezierCurveTo(63.1,179.5,81.4,177,102.3,170.2),t.bezierCurveTo(105.2,168.9,108.2,168,108.2,168),t.bezierCurveTo(108.2,168.5,104.8,182.5,101,200),t.bezierCurveTo(94.6,229.8,94.2,232,92,235.7),t.bezierCurveTo(88.6,243,81,253.3,75.8,258),t.bezierCurveTo(71.6,261.8,68.7,262.6,64.4,260.9),t.bezierCurveTo(60.6,258.8,59.2,256.6,56.7,245.2),t.bezierCurveTo(54.5,236.7,52.9,232,49.4,228.5),t.bezierCurveTo(40.5,218.7,25.1,217.5,13.2,225.1),t.bezierCurveTo(7.7,229,3.4,234.9,.9,241.3),t.bezierCurveTo(0,244.8,0,245.6,0,250.3),t.bezierCurveTo(0,256.6,.4,260,3.4,265.1),t.bezierCurveTo(7.7,273.7,16.6,280.5,26.9,283.1),t.bezierCurveTo(37.9,286,59.2,283.1,80.1,275.8),t.bezierCurveTo(82.7,275,84.4,274.6,84.4,274.6),t.bezierCurveTo(84.4,275,54.5,408.7,53.3,413),t.bezierCurveTo(53.3,413.9,53.7,414.3,55.4,415.2),t.bezierCurveTo(58,416.8,62.2,418.2,65.2,418.2),t.bezierCurveTo(68.2,418.2,72.4,416.8,75,415.2),t.bezierCurveTo(76.7,414.3,77.2,413.9,77.6,411.7),t.bezierCurveTo(77.6,410.5,100.1,298.4,127.9,162.5),t.bezierCurveTo(141.5,94.4,151.4,44.8,158.6,8.7),t.bezierCurveTo(159.5,4.3,157.9,-0.1,154.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixtyFourth:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.bezierCurveTo(89,2.9,80.5,10.6,76.7,21.2),t.bezierCurveTo(75.8,24.6,75.8,25.4,75.8,30.1),t.bezierCurveTo(75.8,34.8,75.8,36.5,76.7,39.1),t.bezierCurveTo(79.7,48.5,85.7,55.7,95,59.9),t.bezierCurveTo(101.8,63.4,104.4,63.8,113.8,63.8),t.bezierCurveTo(120.2,63.8,122.7,63.8,127.9,63),t.bezierCurveTo(134.6,61.7,144,59.1,151.3,56.6),t.lineTo(155.9,54.8),t.lineTo(155.5,56.6),t.bezierCurveTo(155.1,57.4,152.1,72.3,148.2,89.3),t.bezierCurveTo(141.5,119.2,141.1,120.9,138.9,124.7),t.bezierCurveTo(134.2,134.5,127.5,143.9,122.7,146.9),t.bezierCurveTo(120.2,148.6,118,148.6,115.1,147.3),t.bezierCurveTo(111.2,145.2,109.9,143,107.4,131.5),t.bezierCurveTo(105.2,123,103.6,118.3,100.1,114.9),t.bezierCurveTo(91.2,105.1,75.8,103.9,63.9,111.5),t.bezierCurveTo(58.4,115.3,54.1,121.3,51.6,127.7),t.bezierCurveTo(50.7,131.1,50.7,131.9,50.7,136.6),t.bezierCurveTo(50.7,143,51.1,146.5,54.1,151.6),t.bezierCurveTo(58.4,160.1,67.3,166.9,77.6,169.4),t.bezierCurveTo(82.3,170.8,94.2,170.8,102.3,169.4),t.bezierCurveTo(109.1,168.2,117.2,166,125.3,163.5),t.bezierCurveTo(129.1,162.3,131.7,161.3,132.1,161.3),t.bezierCurveTo(132.1,161.8,117.6,225.7,116.8,227.8),t.bezierCurveTo(114.2,233.3,107.4,244,102.3,249.5),t.bezierCurveTo(96.7,254.6,94.2,255.6,89.5,253.8),t.bezierCurveTo(85.7,251.7,84.4,249.5,81.9,238),t.bezierCurveTo(79.7,229.5,78,224.8,74.6,221.5),t.bezierCurveTo(65.6,211.6,50.3,210.4,38.3,218),t.bezierCurveTo(32.8,221.9,28.6,227.8,26,234.3),t.bezierCurveTo(25.1,237.6,25.1,238.5,25.1,243.2),t.bezierCurveTo(25.1,249.5,25.6,253,28.6,258.1),t.bezierCurveTo(32.8,266.6,41.8,273.4,52,275.9),t.bezierCurveTo(63.1,278.9,81.4,276.4,102.3,269.6),t.bezierCurveTo(105.2,268.3,108.2,267.4,108.2,267.4),t.bezierCurveTo(108.2,267.9,104.8,281.9,101,299.4),t.bezierCurveTo(94.6,329.2,94.2,331.4,92,335.1),t.bezierCurveTo(88.6,342.4,81,352.7,75.8,357.4),t.bezierCurveTo(71.6,361.2,68.7,362,64.4,360.3),t.bezierCurveTo(60.6,358.2,59.2,356,56.7,344.6),t.bezierCurveTo(54.5,336.1,52.9,331.4,49.4,328),t.bezierCurveTo(40.5,318.1,25.1,316.9,13.2,324.5),t.bezierCurveTo(7.7,328.4,3.4,334.3,.9,340.7),t.bezierCurveTo(0,344.2,0,345,0,349.7),t.bezierCurveTo(0,356,.4,359.4,3.4,364.5),t.bezierCurveTo(7.7,373.1,16.6,379.9,26.9,382.5),t.bezierCurveTo(37.9,385.4,59.2,382.5,80.1,375.2),t.bezierCurveTo(82.7,374.4,84.4,374,84.4,374),t.bezierCurveTo(84.4,374.4,54.5,508.1,53.3,512.4),t.bezierCurveTo(53.3,513.3,53.7,513.7,55.4,514.6),t.bezierCurveTo(58,516.2,62.2,517.6,65.2,517.6),t.bezierCurveTo(68.2,517.6,72.4,516.2,75,514.6),t.bezierCurveTo(76.7,513.7,77.2,513.3,77.6,511.1),t.bezierCurveTo(77.6,509.9,100.1,397.8,127.9,261.9),t.bezierCurveTo(171.7,42.9,177.2,14.8,176.8,13.9),t.bezierCurveTo(175.6,11.8,173.9,11,171.3,11),t.bezierCurveTo(167.5,11,166.6,11.8,162.8,19.1),t.bezierCurveTo(157.3,29.7,151.7,37.4,147.8,40.4),t.bezierCurveTo(145.7,42.1,143.6,42.1,140.2,40.8),t.bezierCurveTo(136.4,38.6,135.1,36.5,132.5,25),t.bezierCurveTo(130,13.5,126.9,8.4,120.6,4.1),t.bezierCurveTo(114.6,.3,107,-0.9,100.1,.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},simpleRestShape:function(e,t,n){return new Kinetic.Rect({x:e,y:t,width:this.getRealWidth(n),height:this.getRealHeight(n),fill:"black",strokeWidth:0})}}),e}(),Euterpe.Row=function(){function e(t){e.super.call(this,"Euterpe.Row",t),this.type=Euterpe.getConfig(t,"type"),this.group=Euterpe.getConfig(t,"group",undefined),this.groupType=Euterpe.getConfig(t,"groupType",undefined),this.type==="measure"?(this.numberOfLines=5,this.realHeight=[0,57.3]):this.type==="tab"&&(this.numberOfLines=6,this.realHeight=[0,71.5]),this.prepared=[]}return Euterpe.extend(Euterpe.Container,e,{render:function(e,t,n){var r=[],i=0,s=e;for(var o=0;o<this.items.length;o++){var u=this.items[o];u.X=e+u.leftMargin*n,u.Y=t,r.push(u.render(u.X,u.Y,n));var a=u.getRealWidth(n);i+=a,e+=a}r.push(this.renderSelf(s,t,n,i));if(this.type==="measure"){var f=[];this.prepareLedgerLines(f,Euterpe.select("Euterpe.Note",this),t,n),r.push(this.renderLedgerLines(f,n))}return r},prepareLedgerLines:function(e,t,n,r){for(var i=0;i<t.length;i++){var s=t[i];if(typeof s.config.location=="number"){var o=s.headWidth*r,u;s.config.location>this.numberOfLines-1?(u=Math.floor(s.config.location),this.addLedgerLine(s,u,s.X,o,n,e,r)):s.config.location<0&&(u=Math.ceil(s.config.location),this.addLedgerLine(s,u,s.X,o,n,e,r))}}},addLedgerLine:function(e,t,n,r,i,s,o){var u;for(;;){if(t>0&&t<=4||t===0)break;u=!1;var a=Euterpe.getY(t,o,i);if(e.name==="Euterpe.Note"){for(var f=0;f<s.length;f++){var l=s[f];if(l[0]===n&&l[1]===a){u=!0;break}}u||s.push([n,a,r])}t+=t>0?-1:1}},renderLedgerLines:function(e,t){var n=[];for(var r=0;r<e.length;r++){var i=e[r][0],s=e[r][1],o=5*t,u=e[r][2]+o*2;n.push(new Kinetic.Line({points:[0,0,u,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:i-o,y:s}))}return n},renderSelf:function(e,t,n,r){var i=new Kinetic.Line({points:[0,0,r,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:e,y:t}),s=new Kinetic.Group({});s.add(i);for(var o=2;o<this.numberOfLines+1;o++){var u=Euterpe.getY(o-1,n,t),a=i.clone({y:u});s.add(a)}return s}}),e}(),Euterpe.Score=function(){function e(t){this.layer=t.layer,this.lineMargin=Euterpe.getConfig(t,"lineMargin",0),this.titleMargin=Euterpe.getConfig(t,"titleMargin",0),this.musicByMargin=Euterpe.getConfig(t,"musicByMargin",0),this.tuningMargin=Euterpe.getConfig(t,"tuningMargin",0),this.title=Euterpe.getConfig(t,"title",undefined),this.musicBy=Euterpe.getConfig(t,"musicBy",undefined),this.tuning=Euterpe.getConfig(t,"tuning",undefined),this.titleHeight=0,this.musicByHeight=0,this.tuningHeight=0,typeof this.title!="undefined"&&(this.titleText=new Euterpe.Text({text:this.title,fontSize:40,fontFamily:"Serif"}),this.titleWidth=this.titleText.getRealWidth(1),this.titleHeight=this.titleText.getRealHeight(1)),typeof this.musicBy!="undefined"&&(this.musicByText=new Euterpe.Text({fontSize:20,text:"Music by "+this.musicBy,fontFamily:"Serif"}),this.musicByHeight=this.musicByText.getRealHeight(1)),typeof this.tuning!="undefined"&&(this.tuningText=new Euterpe.Text({fontSize:15,text:this.tuning,fontFamily:"Serif",fontStyle:"italic"}),this.tuningHeight=this.tuningText.getRealHeight(1)),e.super.call(this,"Euterpe.Score",t)}return Euterpe.extend(Euterpe.Container,e,{bracketExtraUp:5,bracketExtraDown:5,getRealHeight:function(e,t){var n=this.doGetRealHeight(this.items,e,t),r=0;return r+=this.titleHeight*e,r+=this.titleMargin*e,r+=this.musicByHeight*e,r+=this.musicByMargin*e,r+=this.tuningHeight*e,r+=this.tuningMargin*e,t?n[0]+=r:n+=r,n},render:function(e,t,n){var r=0,i=[],s,o=Euterpe.getGroups(this.items),u=0;for(s=0;s<o.length;s++){var a=o[s];a.groupType==="bracket"&&6>u&&(u=6)}e+=u*n;var f=0;t=this.renderMeta(e,t,n,i);for(s=0;s<this.items.length;s++){var l=this.items[s],c=this.doGetRealHeight([l],n,!0);r!==0&&(r+=c[0]);var h=t+r;l.Y=h,l.X=e,f<o.length&&o[f].first===l.id&&(i.push(this.renderBracket(e-u*n,h,n,o[f].items)),f++),r+=c[1],i.push(l.render(e,h,n))}return i},renderMeta:function(e,t,n,r){var i=this.getRealHeight(n,!0);t-=i[0];var s=(this.titleHeight+this.musicByHeight+this.tuningHeight+this.titleMargin+this.musicByMargin+this.tuningMargin)*n;return typeof this.title!="undefined"&&(t+=this.titleHeight*n/2,r.push(this.renderText(this.titleText,this.titleWidth,e,t,n,!0)),t+=this.titleHeight*n/2,t+=this.titleMargin*n),typeof this.musicBy!="undefined"&&(t+=this.musicByHeight*n/2,r.push(this.renderText(this.musicByText,0,e,t,n)),t+=this.musicByHeight*n/2,t+=this.musicByMargin*n),typeof this.tuning!="undefined"&&(t+=this.tuningHeight*n/2,r.push(this.renderText(this.tuningText,0,e,t,n)),t+=this.tuningHeight*n/2,t+=this.tuningMargin*n),t+=i[0]-s,t},renderText:function(e,t,n,r,i,s){var o=n;if(s){var u=this.items[0].getRealWidth(i);o=n+(u/2-t/2)}return e.render(o,r,i)},doGetRealHeight:function(e,t,n){var r,i=0,s=Euterpe.getGroups(this.items),o=function(e){return _.find(s,function(t){return t.first===e.id})},u=function(e){return _.find(s,function(t){return t.last===e.id})};for(var a=0;a<e.length;a++){var f=e[a],l=f.getRealHeight(t,!0);o(f)&&(l[0]+=this.bracketExtraUp*t),u(f)&&(l[1]+=this.bracketExtraDown*t);var c=l[1]+l[0];typeof r=="undefined"&&(r=l[0]+i),i+=c+this.lineMargin*t}return n?[r,i-r]:i},renderBracket:function(e,t,n,r){var i=this.bracketExtraUp*n,s=this.bracketExtraDown*n,o=this.doGetRealHeight(r,n,!0),u=o[0]-i,a=o[1]-s-this.lineMargin*n;return new Kinetic.Shape({sceneFunc:function(r){r.beginPath();var o=10*n;r.moveTo(e+o,t-u-i),r.lineTo(e,t-u),r.lineTo(e,t+a),r.lineTo(e+o,t+a+s),r.lineTo(e+o/5,t+a),r.lineTo(e+o/5,t-u),r.lineTo(e+o,t-u-i),r.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})}}),e}(),Euterpe.Sharp=function(){function e(t){e.super.call(this,"Euterpe.Sharp",t),this.realWidth=9,this.realHeight=[11,11]}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=this.realHeight[0]+this.realHeight[1];this.startY=t-r*n/2-n;var i=this.realWidth*n,s=r*n,o=1.5*n,u=new Kinetic.Rect({x:this.X+i/3.6-o/2,y:this.startY+2*n,width:o,height:s,fill:"black",strokeWidth:0}),a=u.clone({x:this.X+i-i/3.6-o/2,y:this.startY}),f=4.5*n,l=this.startY+s/4+3*n;o=3*n;var c=new Kinetic.Line({points:[this.X,l,this.X,l+o,this.X+i,l+o-f,this.X+i,l-f],fill:"black",strokeWidth:0,closed:!0});l=this.startY+s-s/4;var h=c.clone({points:[this.X,l,this.X,l+o,this.X+i,l+o-f,this.X+i,l-f]}),p=[u,a,c,h];return Euterpe.bind(this,p),p}}),e}(),Euterpe.StringNumber=function(){function e(t){this.string=Euterpe.getConfig(t,"string"),this.fontSize=10,this.fontFamily="Arial";if(typeof this.string!="number"||this.string<0||this.string>6)throw"Invalid string value";this.string=this.string.toString(),this.textWidth=5,this.textHeight=7.6,this.realWidth=21.3,this.realHeight=[10.65,10.65],e.super.call(this,"Euterpe.StringNumber",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=[],i=e+this.realWidth*n/2;return r.push(new Kinetic.Circle({x:i,y:t,radius:10*n,fill:"white",stroke:"black",strokeWidth:n})),r.push(new Kinetic.Text({x:i-this.textWidth*n/2,y:t-this.textHeight*n/2,text:this.string,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fill:"black"})),Euterpe.bind(this,r),r}}),e}(),Euterpe.Text=function(){function e(t){this.text=Euterpe.getConfig(t,"text"),this.color=Euterpe.getConfig(t,"color","black"),this.fontFamily=Euterpe.getConfig(t,"fontFamily","Arial"),this.fontSize=Euterpe.getConfig(t,"fontSize",10),this.fontStyle=Euterpe.getConfig(t,"fontStyle","normal");var n=1,r=new Kinetic.Text({x:0,y:0,text:this.text,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fontStyle:this.fontStyle}),i=r.height()/n;this.realWidth=r.width()/n,this.realHeight=[i/2,i/2],e.super.call(this,"Euterpe.Text",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=[new Kinetic.Text({x:e,y:t-(this.realHeight[0]*n+this.realHeight[1]*n)/2,text:this.text,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fontStyle:this.fontStyle,fill:this.color})];return Euterpe.bind(this,r),r}}),e}(),Euterpe.TimeSignature=function(){function e(t){this.numerator=Euterpe.getConfig(t,"numerator",4),this.denominator=Euterpe.getConfig(t,"denominator",4),e.super.call(this,t),this.add(new Euterpe.TimeSignatureShape(this.numerator,0)),this.add(new Euterpe.TimeSignatureShape(this.denominator,2))}return Euterpe.extend(Euterpe.Column,e,{name:"Euterpe.TimeSignature"}),e}(),Euterpe.TimeSignatureShape=function(){function e(t,n){this.yoffset=2;var r={4:[0,24+this.yoffset]};this.digit=t.toString(),this.realWidth=22.4,this.realHeight=r[t],e.super.call(this,"Euterpe.TimeSignatureShape",{location:n})}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=this;this.scale=n,this.startX=e,this.startY=t+this.yoffset*n;var i=[];return this.digit==="4"&&i.push(new Kinetic.Shape({sceneFunc:function(e){var t=r.startX+17.6*n,i=r.startY;e.beginPath(),e.moveTo(t,i),e.lineTo(t-10*r.scale,i),e.bezierCurveTo(t-8.8*r.scale,i+6.8*r.scale,t-10.54*r.scale,i+10.66*r.scale,t-17.6*r.scale,i+16*r.scale),e.lineTo(t-17.6*r.scale,i+17*r.scale),e.lineTo(t-3.6*r.scale,i+17*r.scale),e.lineTo(t-3.6*r.scale,i+22.4*r.scale),e.lineTo(t-5.6*r.scale,i+22.4*r.scale),e.lineTo(t-5.6*r.scale,i+23.4*r.scale),e.lineTo(t-5.6*r.scale,i+23.4*r.scale),e.lineTo(t+4.4*r.scale,i+23.4*r.scale),e.lineTo(t+4.4*r.scale,i+22.4*r.scale),e.lineTo(t+2.4*r.scale,i+22.4*r.scale),e.lineTo(t+2.4*r.scale,i+17*r.scale),e.lineTo(t+4.4*r.scale,i+17*r.scale),e.lineTo(t+4.4*r.scale,i+16*r.scale),e.lineTo(t+2.4*r.scale,i+16*r.scale),e.lineTo(t+2.4*r.scale,i+1.4*r.scale),e.lineTo(t-3.6*r.scale,i+7.2*r.scale),e.lineTo(t-3.6*r.scale,i+16*r.scale),e.lineTo(t-16.6*r.scale,i+16*r.scale),e.lineTo(t,i),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})),Euterpe.bind(this,i),i}}),e}(),Euterpe.TrebleClef=function(){function e(t){this.realWidth=36.8,t.location=0,e.super.call(this,"Euterpe.TrebleClef",t)}return Euterpe.extend(Euterpe.Node,e,{realHeight:[26.3,82],render:function(e,t,n){this.startX=e,this.startY=t-27*n,this.scale=.125*n;var r=this,i=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(159,3),e.quadraticCurveTo(129,50,117,93),e.quadraticCurveTo(107,126,102,167),e.quadraticCurveTo(101,192,102,210),e.quadraticCurveTo(107,255,116,297),e.quadraticCurveTo(63,351,44,375),e.quadraticCurveTo(24,401,15,429),e.quadraticCurveTo(2,464,3,503),e.quadraticCurveTo(5,540,20,575),e.quadraticCurveTo(29,596,48,615),e.quadraticCurveTo(62,630,87,645),e.quadraticCurveTo(113,660,150,666),e.quadraticCurveTo(177,668,194,665),e.quadraticCurveTo(204,720,213,776),e.quadraticCurveTo(216,795,216,813),e.quadraticCurveTo(203,849,158,857),e.quadraticCurveTo(132,857,120,842),e.quadraticCurveTo(152,845,166,813),e.quadraticCurveTo(165,821,168,802),e.quadraticCurveTo(166,775,151,765),e.quadraticCurveTo(132,750,107,758),e.quadraticCurveTo(86,768,78,789),e.quadraticCurveTo(71,818,90,840),e.quadraticCurveTo(105,857,129,865),e.quadraticCurveTo(149,872,177,865),e.quadraticCurveTo(194,860,209,846),e.quadraticCurveTo(231,828,230,803),e.quadraticCurveTo(221,735,207,662),e.quadraticCurveTo(248,650,267,626),e.quadraticCurveTo(293,599,296,566),e.quadraticCurveTo(300,527,285,494),e.quadraticCurveTo(270,462,234,444),e.quadraticCurveTo(215,435,189,435),e.quadraticCurveTo(177,435,164,438),e.quadraticCurveTo(155,396,146,354),e.quadraticCurveTo(183,315,203,275),e.quadraticCurveTo(219,243,222,210),e.quadraticCurveTo(227,167,221,137),e.quadraticCurveTo(213,93,192,51),e.quadraticCurveTo(180,29,159,3),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),s=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(191,93),e.quadraticCurveTo(179,83,171,93),e.quadraticCurveTo(126,162,131,281),e.quadraticCurveTo(188,239,203,188),e.quadraticCurveTo(209,162,204,135),e.quadraticCurveTo(200,111,191,93),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),o=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(171,473),e.quadraticCurveTo(188,555,206,648),e.quadraticCurveTo(237,639,255,620),e.quadraticCurveTo(283,588,283,558),e.quadraticCurveTo(285,525,269,501),e.quadraticCurveTo(252,476,216,470),e.quadraticCurveTo(194,465,171,473),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),u=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,446),e.quadraticCurveTo(141,411,132,369),e.quadraticCurveTo(90,401,68,435),e.quadraticCurveTo(45,467,39,503),e.quadraticCurveTo(30,540,45,576),e.quadraticCurveTo(60,612,92,633),e.quadraticCurveTo(123,651,161,654),e.quadraticCurveTo(174,654,188,653),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,444),e.quadraticCurveTo(120,456,101,480),e.quadraticCurveTo(83,504,84,536),e.quadraticCurveTo(86,567,107,588),e.quadraticCurveTo(114,597,126,605),e.quadraticCurveTo(116,593,107,581),e.quadraticCurveTo(95,560,99,537),e.quadraticCurveTo(105,509,132,491),e.quadraticCurveTo(143,482,164,476),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),f=[i,s,o,u,a];return Euterpe.bind(this,f),f}}),e}(),Euterpe.Column=function(){function e(t){e.super.call(this,"Euterpe.Column",t)}return Euterpe.extend(Euterpe.Container,e,{getRealWidth:function(e,t){var n=Euterpe.getMargins(this,e),r=this.collectItems(),i=_.max(_.map(r,function(n){var r=0,i=0;return n.isNode&&(r=n.getLeftWidth(e),i=n.getRightWidth(e)),n.getRealWidth(e,t)+(t?0:r+i)}));return i+(t?0:n)},getRealHeight:function(e,t){var n=this.collectItems();return Euterpe.getRealHeight(this,n,e,t)},collectItems:function(){var e=this.items;return _.isArray(this.config.aboveItems)&&(e=this.config.aboveItems.concat(this.items)),_.isArray(this.config.belowItems)&&(e=e.concat(this.config.belowItems)),e},render:function(e,t,n){var r=[],i,s,o=0,u=this.collectItems(),a=this.renderSideItems(u,n,r,e,t,!0);e+=a;for(s=0;s<u.length;s++)i=u[s],i.X=e,i.Y=Euterpe.getY(i,n,t),r.push(i.render(i.X,i.Y,n)),a=i.getRealWidth(n),a>o&&(o=a);return this.renderSideItems(this.items,n,r,e+o,t,!1),r},renderSideItems:function(e,t,n,r,i,s){var o=[],u=0,a=0;if(s)for(f=0;f<e.length;f++)e[f].isNode?(c=e[f].getLeftWidth(t),o.push(c),c>u&&(u=c)):o.push(0);for(var f=0;f<e.length;f++){var l=e[f],c=0,h=0;typeof o[f]!="undefined"&&o[f]!==u&&(h=u-o[f]);var p=s?l.leftItems:l.rightItems;for(var d=0;d<p.length;d++){var v=p[d];typeof v.config.location=="undefined"&&(v.config.location=l.config.location),v.X=r+v.leftMargin*t+h+c,v.Y=Euterpe.getY(v,t,i),n.push(v.render(v.X,v.Y,t)),c+=v.getRealWidth(t)}c>a&&(a=c)}return a},reduceWidth:function(e,t){return _.reduce(e,function(e,n){return e+n.getRealWidth(t)},0)}}),e}(),Euterpe.ContainerDepth=0,Euterpe.Container=function(){var e=function(e,t){this.id=Euterpe.randomString(20),this.items=[],this.name=this.name||e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=[],this.rightItems=[];if(typeof t!="undefined"&&_.isArray(t.items))for(var n=0;n<t.items.length;n++)this.add(t.items[n])};return e.prototype={getRealWidth:function(e,t){var n=t?0:Euterpe.getMargins(this,e);for(var r=0;r<this.items.length;r++)n+=this.items[r].getRealWidth(e,t);return n},getRealHeight:function(e,t){return Euterpe.getRealHeight(this,this.items,e,t)},isContainer:!0,getLeftWidth:function(e){var t=_.map(this.items,function(t){return t.getLeftWidth(e)});return _.max(t)},getRightWidth:function(e){var t=_.map(this.items,function(t){return t.getRightWidth(e)});return _.max(t)},clear:function(){this.items.length=0},size:function(){return this.items.length},add:function(e){var t=this;if(_.isArray(e))return _.each(e,function(e){t.add(e)});e.parent=this,this.items.push(e)},prepend:function(e){e.parentContainer=this,this.items.unshift(e)},insertBefore:function(e,t){for(var n=0;n<this.items.length;n++){var r=this.items[n];if(r.id===e)return this.items.splice(n,0,t)}},baseRender:function(e,t,n,r,i){Euterpe.ContainerDepth+=1;var s=[],o=function(e,t,n,r,i){var s=Euterpe.getY(e,r,n);return e.Y=s,e.render(t,s,r,i)};r=r||o,i=i||o;for(var u=0;u<this.items.length;u++){var a=this.items[u],f=0;Euterpe.log.debug((new Array(Euterpe.ContainerDepth)).join("  "),a),a.isContainer?(a.parentContainer=this,f=a.getRealWidth(n),a.X=e+a.leftMargin*n,a.Y=t,s.push(i(a,a.X,a.Y,n,u)),e+=f):(a.parentContainer=this,f=a.getRealWidth(n),a.X=e+a.leftMargin*n,a.Y=t,s.push(r(a,a.X,a.Y,n,u)),e+=f)}return Euterpe.ContainerDepth-=1,s},render:function(e,t,n){return Euterpe.baseRender(this.items,e,t,n)}},e}(),Euterpe.const={LOG_DEBUG:1,LOG_INFO:2,LOG_WARNING:3,LOG_ERROR:4},Euterpe.global={loglevel:Euterpe.const.LOG_INFO},Euterpe.plugins={plugins:[],add:function(){var e=this;_.each(arguments,function(t){e.plugins.push(t)})},fold:function(e,t,n){return _.reduce(this.plugins,function(e,r){return r.process(e,t,n)},e)}},Euterpe.getConfig=function(e,t,n){return typeof e=="undefined"?n:typeof e[t]=="undefined"?n:e[t]},Euterpe.getY=function(e,t,n){var r;if(typeof e=="number")r=e;else{if(typeof e.config=="undefined"||typeof e.config.location=="undefined")return n;r=e.config.location}if(typeof r=="function")return r(t,n);var i=Euterpe.global.linePadding/2+Euterpe.global.lineWidth/2,s,o,u;return r>=0?(o=Math.floor(r),u=Math.ceil(r)>r?i:0,s=Euterpe.global.linePadding*o+Euterpe.global.lineWidth*o,n+s+u):r<0?(o=Math.ceil(r),u=Math.floor(r)<r?i:0,s=Euterpe.global.linePadding*-o+Euterpe.global.lineWidth*-o,n+s*-1-u):n},Euterpe.initNode=function(e,t){e.isNode=!0,e.nodeName=t},Euterpe.extend=function(e,t,n){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t,t.super=e,typeof n=="object"&&_.extend(t.prototype,n)},Euterpe.render=function(e,t,n,r,i,s){Euterpe.initLog(),Euterpe.global.root=e,Euterpe.global.background=new Kinetic.Layer({}),Euterpe.global.foreground=new Kinetic.Layer({}),Euterpe.global.linePadding=13*i,Euterpe.global.lineWidth=i;var o=[],u=Euterpe.plugins.fold(e,i,o),a=u.getRealHeight(i,!0);n+=a[0];var f=n+a[1];Euterpe.stage=new Kinetic.Stage({container:s,width:r,height:f}),Euterpe.stage.add(Euterpe.global.foreground),Euterpe.stage.add(Euterpe.global.background);var l=_.flatten(u.render(t+e.leftMargin*i,n,i));for(var c=0;c<l.length;c++)l[c].layer2draw==="background"?Euterpe.global.background.add(l[c]):Euterpe.global.foreground.add(l[c]);for(var h=0;h<o.length;h++){var p=o[h],d=p(u,i);if(typeof d=="undefined")continue;d.layer2draw==="background"?Euterpe.global.background.add(d):Euterpe.global.foreground.add(d)}return Euterpe.stage},Euterpe.getMargins=function(e,t){return e.leftMargin*t+e.rightMargin*t},Euterpe.randomString=function(e){return(new Array(e+1)).join((Math.random().toString(36)+"00000000000000000").slice(2,18)).slice(0,e)},Euterpe.select=function(e,t){var n=function(t){return e[0]==="#"?t.id===e.slice(1,e.length):t.name===e};t=t||Euterpe.global.root;var r=[];if(t.isNode&&n(t))r.push(t);else if(t.isContainer)for(var i=0;i<t.items.length;i++){var s=t.items[i];n(s)&&r.push(s),s.isContainer&&r.push(Euterpe.select(e,s))}return _.flatten(r)},Euterpe.replace=function(e,t,n){for(var r=0;r<e.items.length;r++){var i=e.items[r];if(i.id==t)return n.parentContainer=e,e.items[r]=n,!0;if(i.isContainer&&Euterpe.replace(i,t,n))break}return!1},Euterpe.initLog=function(){var e=window.console||{},t=function(){};Euterpe.log={debug:t,info:t,warn:t,error:t},Euterpe.const.LOG_DEBUG>=Euterpe.global.loglevel&&e.log&&(Euterpe.log.debug=e.debug.bind(e)),Euterpe.const.LOG_INFO>=Euterpe.global.loglevel&&e.info&&(Euterpe.log.info=e.info.bind(e)),Euterpe.const.LOG_WARNING>=Euterpe.global.loglevel&&e.warn&&(Euterpe.log.warn=e.warn.bind(e)),Euterpe.const.LOG_ERROR>=Euterpe.global.loglevel&&e.error&&(Euterpe.log.error=e.error.bind(e))},Euterpe.getDistance=function(e,t,n){var r=0;for(var i=0;i<e.items.length;i++){var s=e.items[i];if(s.id===t.id)break;if(s.isContainer&&Euterpe.select("#"+t.id,s).length>0){r+=s.leftMargin*n,r+=Euterpe.getDistance(s,t,n);break}r+=s.getRealWidth(n)}return r},Euterpe.getRealHeight=function(e,t,n,r){var i=0,s,o,u,a,f;typeof e.realHeight!="undefined"&&(f=Euterpe.getY(e,n,i),s=e.realHeight[0]*n,o=e.realHeight[1]*n);for(var l=0;l<t.length;l++){var c=t[l],h=c.getRealHeight(n,!0);f=Euterpe.getY(c,n,i),u=f-h[0],a=f+h[1];if(typeof s=="undefined"||u<s)s=u;if(typeof o=="undefined"||a>o)o=a}return r?[s*-1,o]:o-s},Euterpe.baseRender=function(e,t,n,r){var i=[],s,o;for(o=0;o<e.length;o++)s=e[o],s.X=t,s.Y=Euterpe.getY(s,r,n),i.push(s.render(s.X,s.Y,r)),t+=s.getRealWidth(r);return i},Euterpe.getGroups=function(e){var t=[],n=null,r=null,i=null,s=[],o=null;for(var u=0;u<e.length;u++){var a=e[u];typeof a.group!="undefined"?(n!==a.group&&(n!==null&&t.push({first:i,last:o,groupType:r,items:_.clone(s)}),i=a.id,n=a.group,r=a.groupType,s.length=0),s.push(a)):t.push({first:undefined,last:undefined,groupType:undefined,items:[a]}),o=a.id}return s.length>0&&t.push({first:i,last:o,groupType:r,items:s}),t},Euterpe.bind=function(e,t){if(typeof e.config.on=="undefined")return;_.isArray(t)?t=_.flatten(t):t=[t];var n={},r=function(r,i){return function(){i.call(r,e,t,n)}},i=_.keys(e.config.on);for(var s=0;s<i.length;s++){var o=i[s];_.each(t,function(t){t.on(o,r(t,e.config.on[o]))})}},Euterpe.Flat=function(){function e(t){this.realWidth=12.25,this.realHeight=[16.3,9],e.super.call(this,"Euterpe.Flat",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=(this.realHeight[0]+this.realHeight[1])*n;this.barWidth=1.5*n,t-=16.25*n;var i=new Kinetic.Line({points:[0,0,0,r],stroke:"black",strokeWidth:this.barWidth,x:e,y:t}),s=t+r,o=e+this.barWidth/2,u=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,s),e.lineTo(o+7*n,s-5.25*n),e.bezierCurveTo(o+12*n,s-8.75*n,o+12.5*n,s-19.75*n,o,s-13.75*n),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,s-1.25*n),e.bezierCurveTo(o+9.75*n,s-6.75*n,o+8.25*n,s-17.25*n,o,s-12.75*n),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),f=[i,u,a];return Euterpe.bind(this,f),f}}),e}(),Euterpe.helpers={},Euterpe.helpers.events={highlight:function(e,t){function n(n,r,i){typeof i.fill=="undefined"&&(i.fill={}),typeof i.stroke=="undefined"&&(i.stroke={});for(var s=0;s<r.length;s++){var o=r[s];o.fill()===e&&(i.fill[o._id]=e,o.fill(t)),o.stroke()===e&&(i.stroke[o._id]=e,o.stroke(t))}Euterpe.global.background.draw(),Euterpe.global.foreground.draw()}function r(e,t,n){for(var r=0;r<t.length;r++){var i=t[r];typeof n.fill[i._id]!="undefined"&&i.fill(n.fill[i._id]),typeof n.stroke[i._id]!="undefined"&&i.stroke(n.stroke[i._id])}Euterpe.global.background.draw(),Euterpe.global.foreground.draw()}return[n,r]}},Euterpe.KeySignature=function(){function e(t){this.type=Euterpe.getConfig(t,"type"),this.amount=Euterpe.getConfig(t,"amount");if(this.type!=="sharp"&&this.type!=="flat")throw"Invalid type argument";if(typeof this.amount!="number"||this.amount<1||this.amount>7)throw"amount should be >= 1 and <= 7";e.super.call(this,t);var n={sharp:[0,1.5,-0.5,1,2.5,.5,2],flat:[2,.5,2.5,1,3,1.5,3.5]};for(var r=0;r<this.amount;r++){var i={location:n[this.type][r]};this.add(this.type==="sharp"?new Euterpe.Sharp(i):new Euterpe.Flat(i))}}return Euterpe.extend(Euterpe.Container,e),e}(),Euterpe.Natural=function(){function e(t){this.realWidth=11.5,this.realHeight=[20.5,21.5],e.super.call(this,"Euterpe.Natural",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=1.5*n,i=28*n,s=10*n,o=2.5*n,u=1.5*n;t-=i/2+i/4;var a=new Kinetic.Rect({width:r,height:i,fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1,x:e,y:t}),f=a.clone({x:e+s,y:t+i/2}),l,c,h=new Kinetic.Shape({sceneFunc:function(n){l=e,c=t+i/2,n.beginPath(),n.moveTo(l,c),n.lineTo(l+s+r,c-u),n.lineTo(l+s+r,c+o),n.lineTo(l,c+o+u),n.lineTo(l,c),n.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1}),p=h.clone({sceneFunc:function(n){l=e,c=t+i-o,n.beginPath(),n.moveTo(l,c),n.lineTo(l+s+r,c-u),n.lineTo(l+s+r,c+o),n.lineTo(l,c+o+u),n.lineTo(l,c),n.fillStrokeShape(this)}}),d=[a,f,h,p];return Euterpe.bind(this,d),d}}),e}(),Euterpe.Node=function(){var e=function(e,t){this.id=Euterpe.randomString(20),this.name=e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=Euterpe.getConfig(t,"leftItems",[]),this.rightItems=Euterpe.getConfig(t,"rightItems",[])};return e.prototype.isNode=!0,e.prototype.getLeftWidth=function(e){return this.reduceWidth(this.leftItems,e)},e.prototype.getRightWidth=function(e){return this.reduceWidth(this.rightItems,e)},e.prototype.getRealWidth=function(e,t){var n=Euterpe.getMargins(this,e);return this.realWidth*e+(t?0:n)},e.prototype.getRealHeight=function(e,t){return typeof this.realHeight=="undefined"?t?[0,0]:0:t?[this.realHeight[0]*e,this.realHeight[1]*e]:this.realHeight[0]*e+this.realHeight[1]*e},e.prototype.clone=function(){var e=new this.constructor(this.config);return e.parentContainer=this.parentContainer,e},e.prototype.reduceWidth=function(e,t){return _.reduce(e,function(e,n){return e+n.getRealWidth(t)},0)},e}(),Euterpe.Note=function(){function e(t){this.type=Euterpe.getConfig(t,"type","quarter"),this.beamDir=Euterpe.getConfig(t,"beamDirection",undefined),this.flags=Euterpe.getConfig(t,"flags",0),this.dots=Euterpe.getConfig(t,"dots",0),this.beam=undefined,e.super.call(this,"Euterpe.Note",t),this.headHeight=13.3,this.realHeight=[this.headHeight/2,this.headHeight/2],this.type==="whole"?this.realWidth=this.headWidth=21.2:this.realWidth=this.headWidth=13.6,this.dotWidth=4.5,this.dotMargin=2.5,this.calculateSize()}return Euterpe.extend(Euterpe.Node,e,{beamRealHeight:35,calculateSize:function(){this.beamDir==="up"?this.realHeight=[this.beamRealHeight,this.headHeight/2]:this.beamDir==="down"&&(this.realHeight=[this.headHeight/2,this.beamRealHeight]),this.realWidth+=(this.dotMargin+this.dotWidth)*this.dots,this.flags>0&&(this.realWidth+=13.3)},render:function(e,t,n){this.beamWidth=1.3*n,this.beamHeight=this.beamRealHeight*n,this.scale=n,this.startX=e+this.headWidth*n/2,this.startY=t;var r=[];switch(this.type){case"whole":r=this.initWhole();break;default:r=this.initHalfQuarter()}if(this.dots>0){var i=0,s=this.location;s%1===0&&(i=3*n);var o=e+this.headWidth*n;for(var u=this.dots;u>0;u--)o+=this.dotMargin*n+this.dotWidth*n/2,r.push(new Kinetic.Ellipse({x:o,y:this.Y-i,radius:{x:2*this.scale,y:2*this.scale},fill:"black"})),o+=this.dotWidth*n/2}return Euterpe.bind(this,r),r},initWhole:function(){var e=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:10.5*this.scale,y:6.5*this.scale},fill:"black"}),t=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:5.5*this.scale,y:4*this.scale},fill:"white"});return t.rotation(45),[e,t]},initHalfQuarter:function(){var e=[],t=this,n=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:7.6*this.scale,y:5.6*this.scale},fill:"black"});n.rotation(140),e.push(n);if(this.type==="half"){var r=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:6.6*this.scale,y:2.5*this.scale},fill:"white"});r.rotation(140),e.push(r)}var i,s;if(typeof this.beamDir=="string"){this.beamDir==="up"?(i=n.x()+n.width()/2-this.beamWidth-this.beamWidth/3,s=n.y(),this.beam=new Kinetic.Line({points:[0,0,0,-this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:i,y:s}),e.push(this.beam)):this.beamDir==="down"&&(i=n.x()-n.width()/2+this.beamWidth+this.beamWidth/3,s=n.y(),this.beam=new Kinetic.Line({points:[0,0,0,this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:i,y:s}),e.push(this.beam));if(this.flags==1){var o=this.beam.x(),u=this.beam.y()-this.beamHeight,a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,u),e.bezierCurveTo(o+6.2*t.scale,u+11.8*t.scale,o+21.4*t.scale,u+10.4*t.scale,o+10*t.scale,u+26.4*t.scale),e.bezierCurveTo(o+19.6*t.scale,u+12.4*t.scale,o+5.4*t.scale,u+10.4*t.scale,o-.2*t.scale,u+7.4*t.scale),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:1});e.push(a)}}return Euterpe.bind(this,e),e}}),e}(),Euterpe.PluginAboveBelow=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAboveBelow",t)};return Euterpe.extend(Euterpe.Plugin,e,{roundLine:function(e){var t,n;return e<0?(t=e-Math.ceil(e),t===0?n=e:t>=-0.5?n=Math.ceil(e)-.5:n=Math.floor(e),n):(t=e-Math.floor(e),t===0?n=e:t<=.5?n=Math.floor(e)+.5:n=Math.ceil(e),n)},place:function(e,t,n,r){var i=0,s,o,u,a;typeof r=="number"?s=r:n==="above"?s=0:n==="below"&&(s=4);for(var f=0;f<e.length;f++){var l=e[f];o=l.getRealHeight(t,!0),u=o[0]/this.lineH,a=o[1]/this.lineH,n==="above"?(i=s-this.roundLine(a),s=i-this.roundLine(u)):n==="below"&&(i=s+this.roundLine(a),s=i+this.roundLine(u)),l.config.location=i}},process:function(e,t){this.lineH=Euterpe.global.linePadding+Euterpe.global.lineWidth;var n=Euterpe.select("Euterpe.Column",e);for(var r=0;r<n.length;r++){var i=n[r],s=i.config,o=i.getRealHeight(t,!0),u=this.roundLine(o[0]/this.lineH*-1),a=this.roundLine(o[1]/this.lineH);a<4&&(a=4),_.isArray(s.aboveItems)&&this.place(s.aboveItems,t,"above",u),_.isArray(s.belowItems)&&this.place(s.belowItems,t,"below",a)}return e}}),e}(),Euterpe.PluginAccidentals=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAccidentals",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){var t=Euterpe.select("Euterpe.Note",e);for(var n=0;n<t.length;n++){var r=t[n];if(typeof r.config.sharp=="undefined"&&typeof r.config.flat=="undefined")continue;var i=r.config.sharp||r.config.flat;for(var s=0;s<i;s++)typeof r.config.sharp!="undefined"?r.leftItems.push(new Euterpe.Sharp({})):typeof r.config.flat!="undefined"&&r.leftItems.push(new Euterpe.Flat({}))}return e}}),e}(),Euterpe.PluginAlign=function(){var e=function(t){this.totalWidth=Euterpe.getConfig(t,"totalWidth"),this.nodeMargin=Euterpe.getConfig(t,"nodeMargin",5),this.sideMargin=Euterpe.getConfig(t,"sideMargin",3),e.super.call(this,"Euterpe.PluginAlign",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t){var n,r;for(n=0;n<e.items.length;n++){r=e.items[n];var i,s=this.collectNodes(r);for(i=0;i<s.length;i++)s[i].leftMargin=this.nodeMargin;this.alignSideItems(r)}var o=Euterpe.getGroups(e.items);for(n=0;n<o.length;n++)this.processGroup(o[n],t);return e},alignSideItems:function(e){var t=Euterpe.select("Euterpe.Column",e);for(var n=0;n<t.length;n++){var r=t[n];for(var i=0;i<r.items.length;i++){var s=r.items[i],o;for(o=0;o<s.leftItems.length;o++)s.leftItems[o].rightMargin=this.sideMargin;for(o=0;o<s.rightItems.length;o++)s.rightItems[o].leftMargin=this.sideMargin}}},getColsBars:function(e){var t=[];for(var n=1;n<e.items.length;n++){var r=e.items[n];(r.name==="Euterpe.Column"||r.name==="Euterpe.Bar")&&t.push(r)}return t},stretchAlign:function(e,t){var n=e.getRealWidth(t),r=this.getColsBars(e),i=this.totalWidth-n,s=i/r.length/t;for(var o=0;o<r.length;o++)r[o].leftMargin+=s},getCols:function(e,t){return _.map(e,function(e){return e[t]})},cleanGroup:function(e){var t=[];for(var n=0;n<e.items.length;n++)t[n]=this.getColsBars(e.items[n]);return t},processGroup:function(e,t){var n=this.cleanGroup(e),r,i,s,o,u=_.max(_.map(n,function(e){return e.length}));for(r=0;r<u;r++){o=this.getCols(n,r);var a={},f={},l={};for(i=0;i<o.length;i++){s=o[i];if(typeof s=="undefined")continue;a[s.id]=Euterpe.getDistance(s.parent,s,t)+s.leftMargin*t+s.getLeftWidth(t),f[s.id]=s.getRealWidth(t,!0),l[s.id]=s.getRightWidth(t)}var c=_.max(_.values(a)),h=_.max(_.values(f)),p=_.max(_.values(l));for(i=0;i<o.length;i++){s=o[i];if(typeof s=="undefined")continue;var d=a[s.id],v=f[s.id],m=l[s.id];d<c&&(s.leftMargin+=(c-d)/t),v<h&&(s.rightMargin+=(h-v)/t),m<p&&(s.rightMargin+=(p-m)/t)}}var g=this;_.each(e.items,function(e){g.stretchAlign(e,t)})},collectNodes:function(e){return _.filter(e.items,function(e){return e.name!=="Euterpe.Bar"&&e.name!=="Euterpe.Column"})}}),e}(),Euterpe.Plugin=function(){var e=function(e,t){this.name=e,this.config=t||{}};return e.prototype.isPlugin=!0,e.prototype.process=function(e){return e},e}(),Euterpe.PluginNoteBar=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteBar",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t,n){var r=Euterpe.select("Euterpe.Column",e),i=[],s=[],o=1,u={};for(var a=0;a<r.length;a++){var f=r[a];for(var l=0;l<f.items.length;l++){var c=f.items[l],h=c.config||{};if(h.bar==="begin"||h.bar==="cont"||h.bar==="end")o=h.beamDirection==="down"?-1:1,u[i.length]=o,c.flags=0,s.push(c.id),h.bar==="end"&&(this.adjustBeamHeight(s,o),i.push(_.clone(s)),s.length=0)}}for(var p=0;p<i.length;p++)n.push(this.bind(i[p],u[p]));return e},getTopTwo:function(e,t){var n=_.clone(e);return n.sort(function(e,n){return t===1?e.config.location-n.config.location:n.config.location-e.config.location}),n.length>2?[n[0],n[1]]:n},adjustBeamHeight:function(e,t){e=_.map(e,function(e){return Euterpe.select("#"+e)[0]});if(e.length>2){var n=this.getTopTwo(e,t),r=function(e,n){return Euterpe.getY(e,scale,n)-e.beamRealHeight*scale*t},i=n[0],s=n[1],o=i.parent.parent,u=Euterpe.getDistance(o,i,scale),a=Euterpe.getDistance(o,s,scale);for(var f=0;f<e.length;f++){var l=Math.abs(Euterpe.getY(e[f],scale,0)),c=r(i,l),h=r(s,l),p=(h-c)/(a-u),d=Euterpe.getDistance(o,e[f],scale),v=r(e[f],l),m=p*(d-u)+c,g=v-m;g!==0&&(e[f].beamRealHeight+=g*t/scale,e[f].calculateSize())}}},bind:function(e,t){return function(n,r){var i=Euterpe.select("#"+e[0])[0],s=Euterpe.select("#"+e[e.length-1])[0],o=i.beam.x(),u=i.beam.y()-i.beamHeight*t,a=s.beam.x(),f=s.beam.y()-s.beamHeight*t,l=4*r,c=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,u),e.lineTo(a,f),e.lineTo(a,f+l*t),e.lineTo(o,u+l*t),e.moveTo(o,u),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0});return c}}}),e}(),Euterpe.PluginNoteText=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteText",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){var t=Euterpe.select("Euterpe.Note",e);for(var n=0;n<t.length;n++){var r=t[n];if(typeof r.config.text=="undefined")continue;var i=new Euterpe.Text({text:r.config.text});r.leftItems.push(i)}return e}}),e}(),Euterpe.PluginTab=function(){var e=function(t){e.super.call(this,"Euterpe.PluginTab",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){for(var t=0;t<e.items.length;t++){var n=e.items[t],r=new Euterpe.Row({type:"tab"});for(var i=0;i<n.items.length;i++){var s=n.items[i];if(s.name=="Euterpe.Bar"){r.add(s.clone());continue}var o=new Euterpe.Column({}),u=Euterpe.select("Euterpe.Note",s);for(var a=0;a<u.length;a++){var f=u[a];typeof f.config.tab_location=="number"&&typeof f.config.tab_text=="string"&&(n.group=t.toString(),n.groupType="bracket",r.group=n.group,r.groupType=n.groupType,o.add(new Euterpe.Text({text:f.config.tab_text,location:f.config.tab_location})))}r!==null&&o.items.length>0&&r.add(o)}typeof r.group!="undefined"&&e.items.splice(t+1,0,r)}return e}}),e}(),Euterpe.Rest=function(){function e(t){this.type=Euterpe.getConfig(t,"type","long"),e.super.call(this,"Euterpe.Rest",t),this.basicWidth=7;switch(this.type){case"long":this.realWidth=this.basicWidth,this.realHeight=[0,28];break;case"double_whole":this.realWidth=this.basicWidth,this.realHeight=[0,14.5];break;case"whole":this.realWidth=20,this.realHeight=[0,8];break;case"half":this.realWidth=20,this.realHeight=[6,0];break;case"quarter":this.realWidth=20,this.realHeight=[16.75,22.25];break;case"eighth":this.realWidth=20,this.realHeight=[9.5,16.25];break;case"sixteenth":this.realWidth=20,this.realHeight=[9.5,30.25];break;case"thirty-second":this.realWidth=25,this.realHeight=[9.5,43.25];break;case"sixty-fourth":this.realWidth=30,this.realHeight=[9.5,55.75]}}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=e+this.getRealWidth(n)/2,i=[];switch(this.type){case"half":i.push(this.initHalf(r,t,n));break;case"quarter":i.push(this.initQuarter(r,t,n));break;case"eighth":i.push(this.initEighth(r,t,n));break;case"sixteenth":i.push(this.initSixteen(r,t,n));break;case"thirty-second":i.push(this.initThirtySecond(r,t,n));break;case"sixty-fourth":i.push(this.initSixtyFourth(r,t,n));break;default:i.push(this.simpleRestShape(r,t,n))}return Euterpe.bind(this,i),i},initHalf:function(e,t,n){var r=this.getRealHeight(n,!0);return this.simpleRestShape(e,t-r[0],n)},initQuarter:function(e,t,n){var r=n*.125,i=this.getRealHeight(n,!0),s=t-i[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(r,r),t.beginPath(),t.moveTo(100.2,80.7),t.bezierCurveTo(100.2,100.2,61.1,129.6,61.1,168.7),t.bezierCurveTo(61.1,183.4,90.4,227.5,110,251.9),t.bezierCurveTo(100.2,247,90.4,242.1,75.8,242.1),t.bezierCurveTo(46.4,242.1,36.6,266.6,36.6,281.3),t.bezierCurveTo(36.6,291.1,46.4,300.9,51.3,310.7),t.bezierCurveTo(21.9,291.1,2.4,271.5,2.4,251.9),t.bezierCurveTo(2.4,203,35.8,220.1,60.2,210.3),t.bezierCurveTo(35.8,185.9,12.1,149.2,12.1,134.5),t.bezierCurveTo(12.1,124.7,41.5,90.4,51.3,66),t.lineTo(51.3,51.3),t.bezierCurveTo(51.3,36.6,41.5,17,36.6,2.4),t.bezierCurveTo(56.2,26.8,100.2,70.9,100.2,80.7),t.lineTo(100.2,80.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initEighth:function(e,t,n){var r=n*.125,i=this.getRealHeight(n,!0),s=t-i[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(r,r),t.beginPath(),t.moveTo(92.9,5.2),t.bezierCurveTo(90.4,14.4,88.4,21.5,88.1,21.9),t.bezierCurveTo(84.9,28.7,78.5,37.2,73.6,42.1),t.bezierCurveTo(68.4,47.3,65.5,48.2,61.1,46.5),t.bezierCurveTo(57.4,44.5,56.2,42.4,53.8,31.5),t.bezierCurveTo(51.7,23.4,50.2,19,46.9,15.8),t.bezierCurveTo(38.4,6.5,23.8,5.3,12.6,12.6),t.bezierCurveTo(7.3,16.2,3.3,21.9,.9,28),t.bezierCurveTo(0,31.1,0,32,0,36.4),t.bezierCurveTo(0,40.9,0,42.4,.9,44.9),t.bezierCurveTo(3.6,53.8,9.3,60.7,18.2,64.7),t.bezierCurveTo(24.7,68,27.1,68.4,36,68.4),t.bezierCurveTo(42.5,68.4,44.5,68.4,49.8,67.5),t.bezierCurveTo(57.1,66.3,64.7,63.9,73.2,61.5),t.lineTo(78.5,59.4),t.lineTo(78.5,60.7),t.bezierCurveTo(78,62.3,44.1,190,43.7,190.8),t.bezierCurveTo(43.3,192.4,50.6,195.6,55,195.6),t.bezierCurveTo(59.4,195.6,65.9,192.8,66.3,190.8),t.bezierCurveTo(66.7,190.4,86.1,106.8,110.3,5.1),t.bezierCurveTo(107.1,-2.6,98.1,-0.8,92.9,5.2),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixteen:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.moveTo(132.4,0),t.bezierCurveTo(126.7,0,121.8,4.5,120.8,9.5),t.bezierCurveTo(118,21.7,117.1,25.3,116.8,26.1),t.bezierCurveTo(114.2,31.6,107.4,42.3,102.3,47.8),t.bezierCurveTo(96.7,52.9,94.2,53.8,89.5,52.1),t.bezierCurveTo(85.7,50,84.4,47.8,81.9,36.3),t.bezierCurveTo(79.7,27.8,78,23.1,74.6,19.8),t.bezierCurveTo(65.6,9.9,50.3,8.6,38.3,16.3),t.bezierCurveTo(32.8,20.2,28.6,26.1,26,32.6),t.bezierCurveTo(25.1,35.9,25.1,36.8,25.1,41.5),t.bezierCurveTo(25.1,47.8,25.6,51.3,28.6,56.3),t.bezierCurveTo(32.8,64.9,41.8,71.7,52,74.2),t.bezierCurveTo(63.1,77.2,81.4,74.7,102.3,67.9),t.bezierCurveTo(105.2,66.6,108.2,65.7,108.2,65.7),t.bezierCurveTo(108.2,66.2,104.8,80.2,101,97.7),t.bezierCurveTo(94.6,127.5,94.2,129.7,92,133.4),t.bezierCurveTo(88.6,140.7,81,151,75.8,155.6),t.bezierCurveTo(71.6,159.5,68.7,160.3,64.4,158.6),t.bezierCurveTo(60.6,156.5,59.2,154.3,56.7,142.9),t.bezierCurveTo(54.5,134.3,52.9,129.7,49.4,126.2),t.bezierCurveTo(40.5,116.4,25.1,115.2,13.2,122.8),t.bezierCurveTo(7.7,126.7,3.4,132.6,.9,139),t.bezierCurveTo(0,142.5,0,143.3,0,148),t.bezierCurveTo(0,154.3,.4,157.7,3.4,162.8),t.bezierCurveTo(7.7,171.4,16.6,178.2,26.9,180.8),t.bezierCurveTo(37.9,183.7,59.2,180.8,80.1,173.5),t.bezierCurveTo(82.7,172.7,84.4,172.3,84.4,172.3),t.bezierCurveTo(84.4,172.7,54.5,306.4,53.3,310.7),t.bezierCurveTo(53.3,311.6,53.7,312,55.4,312.8),t.bezierCurveTo(58,314.5,62.2,315.9,65.2,315.9),t.bezierCurveTo(68.2,315.9,72.4,314.5,75,312.8),t.bezierCurveTo(76.7,312,77.2,311.6,77.6,309.4),t.bezierCurveTo(77.6,308.2,100.1,196.1,127.9,60.2),t.bezierCurveTo(131.9,40.2,133.1,33.9,136.5,17),t.bezierCurveTo(137.7,11.1,139.7,0,132.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initThirtySecond:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.moveTo(154.4,0),t.bezierCurveTo(152.8,0,146,0,144.3,7.4),t.bezierCurveTo(141.2,20.7,140.5,22.5,138.9,25.3),t.bezierCurveTo(134.2,35.1,127.5,44.5,122.7,47.5),t.bezierCurveTo(120.2,49.2,118,49.2,115.1,47.9),t.bezierCurveTo(111.2,45.8,109.9,43.6,107.4,32.1),t.bezierCurveTo(105.2,23.6,103.6,18.9,100.1,15.5),t.bezierCurveTo(91.2,5.7,75.8,4.5,63.9,12.1),t.bezierCurveTo(58.4,15.9,54.1,21.9,51.6,28.3),t.bezierCurveTo(50.7,31.7,50.7,32.5,50.7,37.2),t.bezierCurveTo(50.7,43.6,51.1,47.1,54.1,52.2),t.bezierCurveTo(58.4,60.7,67.3,67.5,77.6,70),t.bezierCurveTo(82.3,71.4,94.2,71.4,102.3,70),t.bezierCurveTo(109.1,68.8,117.2,66.6,125.3,64.1),t.bezierCurveTo(129.1,62.8,131.7,61.9,132.1,61.9),t.bezierCurveTo(132.1,62.3,117.6,126.3,116.8,128.4),t.bezierCurveTo(114.2,133.9,107.4,144.6,102.3,150.1),t.bezierCurveTo(96.7,155.2,94.2,156.1,89.5,154.4),t.bezierCurveTo(85.7,152.3,84.4,150.1,81.9,138.6),t.bezierCurveTo(79.7,130.1,78,125.4,74.6,122.1),t.bezierCurveTo(65.6,112.2,50.3,111,38.3,118.6),t.bezierCurveTo(32.8,122.5,28.6,128.4,26,134.9),t.bezierCurveTo(25.1,138.2,25.1,139.1,25.1,143.8),t.bezierCurveTo(25.1,150.1,25.6,153.6,28.6,158.7),t.bezierCurveTo(32.8,167.2,41.8,174,52,176.5),t.bezierCurveTo(63.1,179.5,81.4,177,102.3,170.2),t.bezierCurveTo(105.2,168.9,108.2,168,108.2,168),t.bezierCurveTo(108.2,168.5,104.8,182.5,101,200),t.bezierCurveTo(94.6,229.8,94.2,232,92,235.7),t.bezierCurveTo(88.6,243,81,253.3,75.8,258),t.bezierCurveTo(71.6,261.8,68.7,262.6,64.4,260.9),t.bezierCurveTo(60.6,258.8,59.2,256.6,56.7,245.2),t.bezierCurveTo(54.5,236.7,52.9,232,49.4,228.5),t.bezierCurveTo(40.5,218.7,25.1,217.5,13.2,225.1),t.bezierCurveTo(7.7,229,3.4,234.9,.9,241.3),t.bezierCurveTo(0,244.8,0,245.6,0,250.3),t.bezierCurveTo(0,256.6,.4,260,3.4,265.1),t.bezierCurveTo(7.7,273.7,16.6,280.5,26.9,283.1),t.bezierCurveTo(37.9,286,59.2,283.1,80.1,275.8),t.bezierCurveTo(82.7,275,84.4,274.6,84.4,274.6),t.bezierCurveTo(84.4,275,54.5,408.7,53.3,413),t.bezierCurveTo(53.3,413.9,53.7,414.3,55.4,415.2),t.bezierCurveTo(58,416.8,62.2,418.2,65.2,418.2),t.bezierCurveTo(68.2,418.2,72.4,416.8,75,415.2),t.bezierCurveTo(76.7,414.3,77.2,413.9,77.6,411.7),t.bezierCurveTo(77.6,410.5,100.1,298.4,127.9,162.5),t.bezierCurveTo(141.5,94.4,151.4,44.8,158.6,8.7),t.bezierCurveTo(159.5,4.3,157.9,-0.1,154.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixtyFourth:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.bezierCurveTo(89,2.9,80.5,10.6,76.7,21.2),t.bezierCurveTo(75.8,24.6,75.8,25.4,75.8,30.1),t.bezierCurveTo(75.8,34.8,75.8,36.5,76.7,39.1),t.bezierCurveTo(79.7,48.5,85.7,55.7,95,59.9),t.bezierCurveTo(101.8,63.4,104.4,63.8,113.8,63.8),t.bezierCurveTo(120.2,63.8,122.7,63.8,127.9,63),t.bezierCurveTo(134.6,61.7,144,59.1,151.3,56.6),t.lineTo(155.9,54.8),t.lineTo(155.5,56.6),t.bezierCurveTo(155.1,57.4,152.1,72.3,148.2,89.3),t.bezierCurveTo(141.5,119.2,141.1,120.9,138.9,124.7),t.bezierCurveTo(134.2,134.5,127.5,143.9,122.7,146.9),t.bezierCurveTo(120.2,148.6,118,148.6,115.1,147.3),t.bezierCurveTo(111.2,145.2,109.9,143,107.4,131.5),t.bezierCurveTo(105.2,123,103.6,118.3,100.1,114.9),t.bezierCurveTo(91.2,105.1,75.8,103.9,63.9,111.5),t.bezierCurveTo(58.4,115.3,54.1,121.3,51.6,127.7),t.bezierCurveTo(50.7,131.1,50.7,131.9,50.7,136.6),t.bezierCurveTo(50.7,143,51.1,146.5,54.1,151.6),t.bezierCurveTo(58.4,160.1,67.3,166.9,77.6,169.4),t.bezierCurveTo(82.3,170.8,94.2,170.8,102.3,169.4),t.bezierCurveTo(109.1,168.2,117.2,166,125.3,163.5),t.bezierCurveTo(129.1,162.3,131.7,161.3,132.1,161.3),t.bezierCurveTo(132.1,161.8,117.6,225.7,116.8,227.8),t.bezierCurveTo(114.2,233.3,107.4,244,102.3,249.5),t.bezierCurveTo(96.7,254.6,94.2,255.6,89.5,253.8),t.bezierCurveTo(85.7,251.7,84.4,249.5,81.9,238),t.bezierCurveTo(79.7,229.5,78,224.8,74.6,221.5),t.bezierCurveTo(65.6,211.6,50.3,210.4,38.3,218),t.bezierCurveTo(32.8,221.9,28.6,227.8,26,234.3),t.bezierCurveTo(25.1,237.6,25.1,238.5,25.1,243.2),t.bezierCurveTo(25.1,249.5,25.6,253,28.6,258.1),t.bezierCurveTo(32.8,266.6,41.8,273.4,52,275.9),t.bezierCurveTo(63.1,278.9,81.4,276.4,102.3,269.6),t.bezierCurveTo(105.2,268.3,108.2,267.4,108.2,267.4),t.bezierCurveTo(108.2,267.9,104.8,281.9,101,299.4),t.bezierCurveTo(94.6,329.2,94.2,331.4,92,335.1),t.bezierCurveTo(88.6,342.4,81,352.7,75.8,357.4),t.bezierCurveTo(71.6,361.2,68.7,362,64.4,360.3),t.bezierCurveTo(60.6,358.2,59.2,356,56.7,344.6),t.bezierCurveTo(54.5,336.1,52.9,331.4,49.4,328),t.bezierCurveTo(40.5,318.1,25.1,316.9,13.2,324.5),t.bezierCurveTo(7.7,328.4,3.4,334.3,.9,340.7),t.bezierCurveTo(0,344.2,0,345,0,349.7),t.bezierCurveTo(0,356,.4,359.4,3.4,364.5),t.bezierCurveTo(7.7,373.1,16.6,379.9,26.9,382.5),t.bezierCurveTo(37.9,385.4,59.2,382.5,80.1,375.2),t.bezierCurveTo(82.7,374.4,84.4,374,84.4,374),t.bezierCurveTo(84.4,374.4,54.5,508.1,53.3,512.4),t.bezierCurveTo(53.3,513.3,53.7,513.7,55.4,514.6),t.bezierCurveTo(58,516.2,62.2,517.6,65.2,517.6),t.bezierCurveTo(68.2,517.6,72.4,516.2,75,514.6),t.bezierCurveTo(76.7,513.7,77.2,513.3,77.6,511.1),t.bezierCurveTo(77.6,509.9,100.1,397.8,127.9,261.9),t.bezierCurveTo(171.7,42.9,177.2,14.8,176.8,13.9),t.bezierCurveTo(175.6,11.8,173.9,11,171.3,11),t.bezierCurveTo(167.5,11,166.6,11.8,162.8,19.1),t.bezierCurveTo(157.3,29.7,151.7,37.4,147.8,40.4),t.bezierCurveTo(145.7,42.1,143.6,42.1,140.2,40.8),t.bezierCurveTo(136.4,38.6,135.1,36.5,132.5,25),t.bezierCurveTo(130,13.5,126.9,8.4,120.6,4.1),t.bezierCurveTo(114.6,.3,107,-0.9,100.1,.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},simpleRestShape:function(e,t,n){return new Kinetic.Rect({x:e,y:t,width:this.getRealWidth(n),height:this.getRealHeight(n),fill:"black",strokeWidth:0})}}),e}(),Euterpe.Row=function(){function e(t){e.super.call(this,"Euterpe.Row",t),this.type=Euterpe.getConfig(t,"type"),this.group=Euterpe.getConfig(t,"group",undefined),this.groupType=Euterpe.getConfig(t,"groupType",undefined),this.type==="measure"?(this.numberOfLines=5,this.realHeight=[0,57.3]):this.type==="tab"&&(this.numberOfLines=6,this.realHeight=[0,71.5]),this.prepared=[]}return Euterpe.extend(Euterpe.Container,e,{render:function(e,t,n){var r=[],i=0,s=e;for(var o=0;o<this.items.length;o++){var u=this.items[o];u.X=e+u.leftMargin*n,u.Y=t,r.push(u.render(u.X,u.Y,n));var a=u.getRealWidth(n);i+=a,e+=a}r.push(this.renderSelf(s,t,n,i));if(this.type==="measure"){var f=[];this.prepareLedgerLines(f,Euterpe.select("Euterpe.Note",this),t,n),r.push(this.renderLedgerLines(f,n))}return r},prepareLedgerLines:function(e,t,n,r){for(var i=0;i<t.length;i++){var s=t[i];if(typeof s.config.location=="number"){var o=s.headWidth*r,u;s.config.location>this.numberOfLines-1?(u=Math.floor(s.config.location),this.addLedgerLine(s,u,s.X,o,n,e,r)):s.config.location<0&&(u=Math.ceil(s.config.location),this.addLedgerLine(s,u,s.X,o,n,e,r))}}},addLedgerLine:function(e,t,n,r,i,s,o){var u;for(;;){if(t>0&&t<=4||t===0)break;u=!1;var a=Euterpe.getY(t,o,i);if(e.name==="Euterpe.Note"){for(var f=0;f<s.length;f++){var l=s[f];if(l[0]===n&&l[1]===a){u=!0;break}}u||s.push([n,a,r])}t+=t>0?-1:1}},renderLedgerLines:function(e,t){var n=[];for(var r=0;r<e.length;r++){var i=e[r][0],s=e[r][1],o=5*t,u=e[r][2]+o*2;n.push(new Kinetic.Line({points:[0,0,u,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:i-o,y:s}))}return n},renderSelf:function(e,t,n,r){var i=new Kinetic.Line({points:[0,0,r,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:e,y:t}),s=new Kinetic.Group({});s.add(i);for(var o=2;o<this.numberOfLines+1;o++){var u=Euterpe.getY(o-1,n,t),a=i.clone({y:u});s.add(a)}return s}}),e}(),Euterpe.Score=function(){function e(t){this.layer=t.layer,this.lineMargin=Euterpe.getConfig(t,"lineMargin",0),this.titleMargin=Euterpe.getConfig(t,"titleMargin",0),this.musicByMargin=Euterpe.getConfig(t,"musicByMargin",0),this.tuningMargin=Euterpe.getConfig(t,"tuningMargin",0),this.title=Euterpe.getConfig(t,"title",undefined),this.musicBy=Euterpe.getConfig(t,"musicBy",undefined),this.tuning=Euterpe.getConfig(t,"tuning",undefined),this.titleHeight=0,this.musicByHeight=0,this.tuningHeight=0,typeof this.title!="undefined"&&(this.titleText=new Euterpe.Text({text:this.title,fontSize:40,fontFamily:"Serif"}),this.titleWidth=this.titleText.getRealWidth(1),this.titleHeight=this.titleText.getRealHeight(1)),typeof this.musicBy!="undefined"&&(this.musicByText=new Euterpe.Text({fontSize:20,text:"Music by "+this.musicBy,fontFamily:"Serif"}),this.musicByHeight=this.musicByText.getRealHeight(1)),typeof this.tuning!="undefined"&&(this.tuningText=new Euterpe.Text({fontSize:15,text:this.tuning,fontFamily:"Serif",fontStyle:"italic"}),this.tuningHeight=this.tuningText.getRealHeight(1)),e.super.call(this,"Euterpe.Score",t)}return Euterpe.extend(Euterpe.Container,e,{bracketExtraUp:5,bracketExtraDown:5,getRealHeight:function(e,t){var n=this.doGetRealHeight(this.items,e,t),r=0;return r+=this.titleHeight*e,r+=this.titleMargin*e,r+=this.musicByHeight*e,r+=this.musicByMargin*e,r+=this.tuningHeight*e,r+=this.tuningMargin*e,t?n[0]+=r:n+=r,n},render:function(e,t,n){var r=0,i=[],s,o=Euterpe.getGroups(this.items),u=0;for(s=0;s<o.length;s++){var a=o[s];a.groupType==="bracket"&&6>u&&(u=6)}e+=u*n;var f=0;t=this.renderMeta(e,t,n,i);for(s=0;s<this.items.length;s++){var l=this.items[s],c=this.doGetRealHeight([l],n,!0);r!==0&&(r+=c[0]);var h=t+r;l.Y=h,l.X=e,f<o.length&&o[f].first===l.id&&(i.push(this.renderBracket(e-u*n,h,n,o[f].items)),f++),r+=c[1],i.push(l.render(e,h,n))}return i},renderMeta:function(e,t,n,r){var i=this.getRealHeight(n,!0);t-=i[0];var s=(this.titleHeight+this.musicByHeight+this.tuningHeight+this.titleMargin+this.musicByMargin+this.tuningMargin)*n;return typeof this.title!="undefined"&&(t+=this.titleHeight*n/2,r.push(this.renderText(this.titleText,this.titleWidth,e,t,n,!0)),t+=this.titleHeight*n/2,t+=this.titleMargin*n),typeof this.musicBy!="undefined"&&(t+=this.musicByHeight*n/2,r.push(this.renderText(this.musicByText,0,e,t,n)),t+=this.musicByHeight*n/2,t+=this.musicByMargin*n),typeof this.tuning!="undefined"&&(t+=this.tuningHeight*n/2,r.push(this.renderText(this.tuningText,0,e,t,n)),t+=this.tuningHeight*n/2,t+=this.tuningMargin*n),t+=i[0]-s,t},renderText:function(e,t,n,r,i,s){var o=n;if(s){var u=this.items[0].getRealWidth(i);o=n+(u/2-t/2)}return e.render(o,r,i)},doGetRealHeight:function(e,t,n){var r,i=0,s=Euterpe.getGroups(this.items),o=function(e){return _.find(s,function(t){return t.first===e.id})},u=function(e){return _.find(s,function(t){return t.last===e.id})};for(var a=0;a<e.length;a++){var f=e[a],l=f.getRealHeight(t,!0);o(f)&&(l[0]+=this.bracketExtraUp*t),u(f)&&(l[1]+=this.bracketExtraDown*t);var c=l[1]+l[0];typeof r=="undefined"&&(r=l[0]+i),i+=c+this.lineMargin*t}return n?[r,i-r]:i},renderBracket:function(e,t,n,r){var i=this.bracketExtraUp*n,s=this.bracketExtraDown*n,o=this.doGetRealHeight(r,n,!0),u=o[0]-i,a=o[1]-s-this.lineMargin*n;return new Kinetic.Shape({sceneFunc:function(r){r.beginPath();var o=10*n;r.moveTo(e+o,t-u-i),r.lineTo(e,t-u),r.lineTo(e,t+a),r.lineTo(e+o,t+a+s),r.lineTo(e+o/5,t+a),r.lineTo(e+o/5,t-u),r.lineTo(e+o,t-u-i),r.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})}}),e}(),Euterpe.Sharp=function(){function e(t){e.super.call(this,"Euterpe.Sharp",t),this.realWidth=9,this.realHeight=[11,11]}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=this.realHeight[0]+this.realHeight[1];this.startY=t-r*n/2-n;var i=this.realWidth*n,s=r*n,o=1.5*n,u=new Kinetic.Rect({x:this.X+i/3.6-o/2,y:this.startY+2*n,width:o,height:s,fill:"black",strokeWidth:0}),a=u.clone({x:this.X+i-i/3.6-o/2,y:this.startY}),f=4.5*n,l=this.startY+s/4+3*n;o=3*n;var c=new Kinetic.Line({points:[this.X,l,this.X,l+o,this.X+i,l+o-f,this.X+i,l-f],fill:"black",strokeWidth:0,closed:!0});l=this.startY+s-s/4;var h=c.clone({points:[this.X,l,this.X,l+o,this.X+i,l+o-f,this.X+i,l-f]}),p=[u,a,c,h];return Euterpe.bind(this,p),p}}),e}(),Euterpe.StringNumber=function(){function e(t){this.string=Euterpe.getConfig(t,"string"),this.fontSize=10,this.fontFamily="Arial";if(typeof this.string!="number"||this.string<0||this.string>6)throw"Invalid string value";this.string=this.string.toString(),this.textWidth=5,this.textHeight=7.6,this.realWidth=21.3,this.realHeight=[10.65,10.65],e.super.call(this,"Euterpe.StringNumber",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=[],i=e+this.realWidth*n/2;return r.push(new Kinetic.Circle({x:i,y:t,radius:10*n,fill:"white",stroke:"black",strokeWidth:n})),r.push(new Kinetic.Text({x:i-this.textWidth*n/2,y:t-this.textHeight*n/2,text:this.string,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fill:"black"})),Euterpe.bind(this,r),r}}),e}(),Euterpe.Text=function(){function e(t){this.text=Euterpe.getConfig(t,"text"),this.color=Euterpe.getConfig(t,"color","black"),this.fontFamily=Euterpe.getConfig(t,"fontFamily","Arial"),this.fontSize=Euterpe.getConfig(t,"fontSize",10),this.fontStyle=Euterpe.getConfig(t,"fontStyle","normal");var n=1,r=new Kinetic.Text({x:0,y:0,text:this.text,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fontStyle:this.fontStyle}),i=r.height()/n;this.realWidth=r.width()/n,this.realHeight=[i/2,i/2],e.super.call(this,"Euterpe.Text",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=[new Kinetic.Text({x:e,y:t-(this.realHeight[0]*n+this.realHeight[1]*n)/2,text:this.text,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fontStyle:this.fontStyle,fill:this.color})];return Euterpe.bind(this,r),r}}),e}(),Euterpe.TimeSignature=function(){function e(t){this.numerator=Euterpe.getConfig(t,"numerator",4),this.denominator=Euterpe.getConfig(t,"denominator",4),e.super.call(this,t),this.add(new Euterpe.TimeSignatureShape(this.numerator,0)),this.add(new Euterpe.TimeSignatureShape(this.denominator,2))}return Euterpe.extend(Euterpe.Column,e,{name:"Euterpe.TimeSignature"}),e}(),Euterpe.TimeSignatureShape=function(){function e(t,n){this.yoffset=2;var r={4:[0,24+this.yoffset]};this.digit=t.toString(),this.realWidth=22.4,this.realHeight=r[t],e.super.call(this,"Euterpe.TimeSignatureShape",{location:n})}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=this;this.scale=n,this.startX=e,this.startY=t+this.yoffset*n;var i=[];return this.digit==="4"&&i.push(new Kinetic.Shape({sceneFunc:function(e){var t=r.startX+17.6*n,i=r.startY;e.beginPath(),e.moveTo(t,i),e.lineTo(t-10*r.scale,i),e.bezierCurveTo(t-8.8*r.scale,i+6.8*r.scale,t-10.54*r.scale,i+10.66*r.scale,t-17.6*r.scale,i+16*r.scale),e.lineTo(t-17.6*r.scale,i+17*r.scale),e.lineTo(t-3.6*r.scale,i+17*r.scale),e.lineTo(t-3.6*r.scale,i+22.4*r.scale),e.lineTo(t-5.6*r.scale,i+22.4*r.scale),e.lineTo(t-5.6*r.scale,i+23.4*r.scale),e.lineTo(t-5.6*r.scale,i+23.4*r.scale),e.lineTo(t+4.4*r.scale,i+23.4*r.scale),e.lineTo(t+4.4*r.scale,i+22.4*r.scale),e.lineTo(t+2.4*r.scale,i+22.4*r.scale),e.lineTo(t+2.4*r.scale,i+17*r.scale),e.lineTo(t+4.4*r.scale,i+17*r.scale),e.lineTo(t+4.4*r.scale,i+16*r.scale),e.lineTo(t+2.4*r.scale,i+16*r.scale),e.lineTo(t+2.4*r.scale,i+1.4*r.scale),e.lineTo(t-3.6*r.scale,i+7.2*r.scale),e.lineTo(t-3.6*r.scale,i+16*r.scale),e.lineTo(t-16.6*r.scale,i+16*r.scale),e.lineTo(t,i),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})),Euterpe.bind(this,i),i}}),e}(),Euterpe.TrebleClef=function(){function e(t){this.realWidth=36.8,t.location=0,e.super.call(this,"Euterpe.TrebleClef",t)}return Euterpe.extend(Euterpe.Node,e,{realHeight:[26.3,82],render:function(e,t,n){this.startX=e,this.startY=t-27*n,this.scale=.125*n;var r=this,i=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(159,3),e.quadraticCurveTo(129,50,117,93),e.quadraticCurveTo(107,126,102,167),e.quadraticCurveTo(101,192,102,210),e.quadraticCurveTo(107,255,116,297),e.quadraticCurveTo(63,351,44,375),e.quadraticCurveTo(24,401,15,429),e.quadraticCurveTo(2,464,3,503),e.quadraticCurveTo(5,540,20,575),e.quadraticCurveTo(29,596,48,615),e.quadraticCurveTo(62,630,87,645),e.quadraticCurveTo(113,660,150,666),e.quadraticCurveTo(177,668,194,665),e.quadraticCurveTo(204,720,213,776),e.quadraticCurveTo(216,795,216,813),e.quadraticCurveTo(203,849,158,857),e.quadraticCurveTo(132,857,120,842),e.quadraticCurveTo(152,845,166,813),e.quadraticCurveTo(165,821,168,802),e.quadraticCurveTo(166,775,151,765),e.quadraticCurveTo(132,750,107,758),e.quadraticCurveTo(86,768,78,789),e.quadraticCurveTo(71,818,90,840),e.quadraticCurveTo(105,857,129,865),e.quadraticCurveTo(149,872,177,865),e.quadraticCurveTo(194,860,209,846),e.quadraticCurveTo(231,828,230,803),e.quadraticCurveTo(221,735,207,662),e.quadraticCurveTo(248,650,267,626),e.quadraticCurveTo(293,599,296,566),e.quadraticCurveTo(300,527,285,494),e.quadraticCurveTo(270,462,234,444),e.quadraticCurveTo(215,435,189,435),e.quadraticCurveTo(177,435,164,438),e.quadraticCurveTo(155,396,146,354),e.quadraticCurveTo(183,315,203,275),e.quadraticCurveTo(219,243,222,210),e.quadraticCurveTo(227,167,221,137),e.quadraticCurveTo(213,93,192,51),e.quadraticCurveTo(180,29,159,3),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),s=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(191,93),e.quadraticCurveTo(179,83,171,93),e.quadraticCurveTo(126,162,131,281),e.quadraticCurveTo(188,239,203,188),e.quadraticCurveTo(209,162,204,135),e.quadraticCurveTo(200,111,191,93),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),o=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(171,473),e.quadraticCurveTo(188,555,206,648),e.quadraticCurveTo(237,639,255,620),e.quadraticCurveTo(283,588,283,558),e.quadraticCurveTo(285,525,269,501),e.quadraticCurveTo(252,476,216,470),e.quadraticCurveTo(194,465,171,473),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),u=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,446),e.quadraticCurveTo(141,411,132,369),e.quadraticCurveTo(90,401,68,435),e.quadraticCurveTo(45,467,39,503),e.quadraticCurveTo(30,540,45,576),e.quadraticCurveTo(60,612,92,633),e.quadraticCurveTo(123,651,161,654),e.quadraticCurveTo(174,654,188,653),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,444),e.quadraticCurveTo(120,456,101,480),e.quadraticCurveTo(83,504,84,536),e.quadraticCurveTo(86,567,107,588),e.quadraticCurveTo(114,597,126,605),e.quadraticCurveTo(116,593,107,581),e.quadraticCurveTo(95,560,99,537),e.quadraticCurveTo(105,509,132,491),e.quadraticCurveTo(143,482,164,476),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),f=[i,s,o,u,a];return Euterpe.bind(this,f),f}}),e}(),Euterpe.Column=function(){function e(t){e.super.call(this,"Euterpe.Column",t)}return Euterpe.extend(Euterpe.Container,e,{getRealWidth:function(e,t){var n=Euterpe.getMargins(this,e),r=this.collectItems(),i=_.max(_.map(r,function(n){var r=0,i=0;return n.isNode&&(r=n.getLeftWidth(e),i=n.getRightWidth(e)),n.getRealWidth(e,t)+(t?0:r+i)}));return i+(t?0:n)},getRealHeight:function(e,t){var n=this.collectItems();return Euterpe.getRealHeight(this,n,e,t)},collectItems:function(){var e=this.items;return _.isArray(this.config.aboveItems)&&(e=this.config.aboveItems.concat(this.items)),_.isArray(this.config.belowItems)&&(e=e.concat(this.config.belowItems)),e},render:function(e,t,n){var r=[],i,s,o=0,u=this.collectItems(),a=this.renderSideItems(u,n,r,e,t,!0);e+=a;for(s=0;s<u.length;s++)i=u[s],i.X=e,i.Y=Euterpe.getY(i,n,t),r.push(i.render(i.X,i.Y,n)),a=i.getRealWidth(n),a>o&&(o=a);return this.renderSideItems(this.items,n,r,e+o,t,!1),r},renderSideItems:function(e,t,n,r,i,s){var o=[],u=0,a=0;if(s)for(f=0;f<e.length;f++)e[f].isNode?(c=e[f].getLeftWidth(t),o.push(c),c>u&&(u=c)):o.push(0);for(var f=0;f<e.length;f++){var l=e[f],c=0,h=0;typeof o[f]!="undefined"&&o[f]!==u&&(h=u-o[f]);var p=s?l.leftItems:l.rightItems;for(var d=0;d<p.length;d++){var v=p[d];typeof v.config.location=="undefined"&&(v.config.location=l.config.location),v.X=r+v.leftMargin*t+h+c,v.Y=Euterpe.getY(v,t,i),n.push(v.render(v.X,v.Y,t)),c+=v.getRealWidth(t)}c>a&&(a=c)}return a},reduceWidth:function(e,t){return _.reduce(e,function(e,n){return e+n.getRealWidth(t)},0)}}),e}(),Euterpe.ContainerDepth=0,Euterpe.Container=function(){var e=function(e,t){this.id=Euterpe.randomString(20),this.items=[],this.name=this.name||e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=[],this.rightItems=[];if(typeof t!="undefined"&&_.isArray(t.items))for(var n=0;n<t.items.length;n++)this.add(t.items[n])};return e.prototype={getRealWidth:function(e,t){var n=t?0:Euterpe.getMargins(this,e);for(var r=0;r<this.items.length;r++)n+=this.items[r].getRealWidth(e,t);return n},getRealHeight:function(e,t){return Euterpe.getRealHeight(this,this.items,e,t)},isContainer:!0,getLeftWidth:function(e){var t=_.map(this.items,function(t){return t.getLeftWidth(e)});return _.max(t)},getRightWidth:function(e){var t=_.map(this.items,function(t){return t.getRightWidth(e)});return _.max(t)},clear:function(){this.items.length=0},size:function(){return this.items.length},add:function(e){var t=this;if(_.isArray(e))return _.each(e,function(e){t.add(e)});e.parent=this,this.items.push(e)},prepend:function(e){e.parentContainer=this,this.items.unshift(e)},insertBefore:function(e,t){for(var n=0;n<this.items.length;n++){var r=this.items[n];if(r.id===e)return this.items.splice(n,0,t)}},baseRender:function(e,t,n,r,i){Euterpe.ContainerDepth+=1;var s=[],o=function(e,t,n,r,i){var s=Euterpe.getY(e,r,n);return e.Y=s,e.render(t,s,r,i)};r=r||o,i=i||o;for(var u=0;u<this.items.length;u++){var a=this.items[u],f=0;Euterpe.log.debug((new Array(Euterpe.ContainerDepth)).join("  "),a),a.isContainer?(a.parentContainer=this,f=a.getRealWidth(n),a.X=e+a.leftMargin*n,a.Y=t,s.push(i(a,a.X,a.Y,n,u)),e+=f):(a.parentContainer=this,f=a.getRealWidth(n),a.X=e+a.leftMargin*n,a.Y=t,s.push(r(a,a.X,a.Y,n,u)),e+=f)}return Euterpe.ContainerDepth-=1,s},render:function(e,t,n){return Euterpe.baseRender(this.items,e,t,n)}},e}(),Euterpe.const={LOG_DEBUG:1,LOG_INFO:2,LOG_WARNING:3,LOG_ERROR:4},Euterpe.global={loglevel:Euterpe.const.LOG_INFO},Euterpe.plugins={plugins:[],add:function(){var e=this;_.each(arguments,function(t){e.plugins.push(t)})},fold:function(e,t,n){return _.reduce(this.plugins,function(e,r){return r.process(e,t,n)},e)}},Euterpe.getConfig=function(e,t,n){return typeof e=="undefined"?n:typeof e[t]=="undefined"?n:e[t]},Euterpe.getY=function(e,t,n){var r;if(typeof e=="number")r=e;else{if(typeof e.config=="undefined"||typeof e.config.location=="undefined")return n;r=e.config.location}if(typeof r=="function")return r(t,n);var i=Euterpe.global.linePadding/2+Euterpe.global.lineWidth/2,s,o,u;return r>=0?(o=Math.floor(r),u=Math.ceil(r)>r?i:0,s=Euterpe.global.linePadding*o+Euterpe.global.lineWidth*o,n+s+u):r<0?(o=Math.ceil(r),u=Math.floor(r)<r?i:0,s=Euterpe.global.linePadding*-o+Euterpe.global.lineWidth*-o,n+s*-1-u):n},Euterpe.initNode=function(e,t){e.isNode=!0,e.nodeName=t},Euterpe.extend=function(e,t,n){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t,t.super=e,typeof n=="object"&&_.extend(t.prototype,n)},Euterpe.render=function(e,t,n,r,i,s){Euterpe.initLog(),Euterpe.global.root=e,Euterpe.global.background=new Kinetic.Layer({}),Euterpe.global.foreground=new Kinetic.Layer({}),Euterpe.global.linePadding=13*i,Euterpe.global.lineWidth=i;var o=[],u=Euterpe.plugins.fold(e,i,o),a=u.getRealHeight(i,!0);n+=a[0];var f=n+a[1];Euterpe.stage=new Kinetic.Stage({container:s,width:r,height:f}),Euterpe.stage.add(Euterpe.global.foreground),Euterpe.stage.add(Euterpe.global.background);var l=_.flatten(u.render(t+e.leftMargin*i,n,i));for(var c=0;c<l.length;c++)l[c].layer2draw==="background"?Euterpe.global.background.add(l[c]):Euterpe.global.foreground.add(l[c]);for(var h=0;h<o.length;h++){var p=o[h],d=p(u,i);if(typeof d=="undefined")continue;d.layer2draw==="background"?Euterpe.global.background.add(d):Euterpe.global.foreground.add(d)}return Euterpe.stage},Euterpe.getMargins=function(e,t){return e.leftMargin*t+e.rightMargin*t},Euterpe.randomString=function(e){return(new Array(e+1)).join((Math.random().toString(36)+"00000000000000000").slice(2,18)).slice(0,e)},Euterpe.select=function(e,t){var n=function(t){return e[0]==="#"?t.id===e.slice(1,e.length):t.name===e};t=t||Euterpe.global.root;var r=[];if(t.isNode&&n(t))r.push(t);else if(t.isContainer)for(var i=0;i<t.items.length;i++){var s=t.items[i];n(s)&&r.push(s),s.isContainer&&r.push(Euterpe.select(e,s))}return _.flatten(r)},Euterpe.replace=function(e,t,n){for(var r=0;r<e.items.length;r++){var i=e.items[r];if(i.id==t)return n.parentContainer=e,e.items[r]=n,!0;if(i.isContainer&&Euterpe.replace(i,t,n))break}return!1},Euterpe.initLog=function(){var e=window.console||{},t=function(){};Euterpe.log={debug:t,info:t,warn:t,error:t},Euterpe.const.LOG_DEBUG>=Euterpe.global.loglevel&&e.log&&(Euterpe.log.debug=e.debug.bind(e)),Euterpe.const.LOG_INFO>=Euterpe.global.loglevel&&e.info&&(Euterpe.log.info=e.info.bind(e)),Euterpe.const.LOG_WARNING>=Euterpe.global.loglevel&&e.warn&&(Euterpe.log.warn=e.warn.bind(e)),Euterpe.const.LOG_ERROR>=Euterpe.global.loglevel&&e.error&&(Euterpe.log.error=e.error.bind(e))},Euterpe.getDistance=function(e,t,n){var r=0;for(var i=0;i<e.items.length;i++){var s=e.items[i];if(s.id===t.id)break;if(s.isContainer&&Euterpe.select("#"+t.id,s).length>0){r+=s.leftMargin*n,r+=Euterpe.getDistance(s,t,n);break}r+=s.getRealWidth(n)}return r},Euterpe.getRealHeight=function(e,t,n,r){var i=0,s,o,u,a,f;typeof e.realHeight!="undefined"&&(f=Euterpe.getY(e,n,i),s=e.realHeight[0]*n,o=e.realHeight[1]*n);for(var l=0;l<t.length;l++){var c=t[l],h=c.getRealHeight(n,!0);f=Euterpe.getY(c,n,i),u=f-h[0],a=f+h[1];if(typeof s=="undefined"||u<s)s=u;if(typeof o=="undefined"||a>o)o=a}return r?[s*-1,o]:o-s},Euterpe.baseRender=function(e,t,n,r){var i=[],s,o;for(o=0;o<e.length;o++)s=e[o],s.X=t,s.Y=Euterpe.getY(s,r,n),i.push(s.render(s.X,s.Y,r)),t+=s.getRealWidth(r);return i},Euterpe.getGroups=function(e){var t=[],n=null,r=null,i=null,s=[],o=null;for(var u=0;u<e.length;u++){var a=e[u];typeof a.group!="undefined"?(n!==a.group&&(n!==null&&t.push({first:i,last:o,groupType:r,items:_.clone(s)}),i=a.id,n=a.group,r=a.groupType,s.length=0),s.push(a)):t.push({first:undefined,last:undefined,groupType:undefined,items:[a]}),o=a.id}return s.length>0&&t.push({first:i,last:o,groupType:r,items:s}),t},Euterpe.bind=function(e,t){if(typeof e.config.on=="undefined")return;_.isArray(t)?t=_.flatten(t):t=[t];var n={},r=function(r,i){return function(){i.call(r,e,t,n)}},i=_.keys(e.config.on);for(var s=0;s<i.length;s++){var o=i[s];_.each(t,function(t){t.on(o,r(t,e.config.on[o]))})}},Euterpe.Flat=function(){function e(t){this.realWidth=12.25,this.realHeight=[16.3,9],e.super.call(this,"Euterpe.Flat",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=(this.realHeight[0]+this.realHeight[1])*n;this.barWidth=1.5*n,t-=16.25*n;var i=new Kinetic.Line({points:[0,0,0,r],stroke:"black",strokeWidth:this.barWidth,x:e,y:t}),s=t+r,o=e+this.barWidth/2,u=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,s),e.lineTo(o+7*n,s-5.25*n),e.bezierCurveTo(o+12*n,s-8.75*n,o+12.5*n,s-19.75*n,o,s-13.75*n),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,s-1.25*n),e.bezierCurveTo(o+9.75*n,s-6.75*n,o+8.25*n,s-17.25*n,o,s-12.75*n),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),f=[i,u,a];return Euterpe.bind(this,f),f}}),e}(),Euterpe.helpers={},Euterpe.helpers.events={highlight:function(e,t){function n(n,r,i){typeof i.fill=="undefined"&&(i.fill={}),typeof i.stroke=="undefined"&&(i.stroke={});for(var s=0;s<r.length;s++){var o=r[s];o.fill()===e&&(i.fill[o._id]=e,o.fill(t)),o.stroke()===e&&(i.stroke[o._id]=e,o.stroke(t))}Euterpe.global.background.draw(),Euterpe.global.foreground.draw()}function r(e,t,n){for(var r=0;r<t.length;r++){var i=t[r];typeof n.fill[i._id]!="undefined"&&i.fill(n.fill[i._id]),typeof n.stroke[i._id]!="undefined"&&i.stroke(n.stroke[i._id])}Euterpe.global.background.draw(),Euterpe.global.foreground.draw()}return[n,r]}},Euterpe.KeySignature=function(){function e(t){this.type=Euterpe.getConfig(t,"type"),this.amount=Euterpe.getConfig(t,"amount");if(this.type!=="sharp"&&this.type!=="flat")throw"Invalid type argument";if(typeof this.amount!="number"||this.amount<1||this.amount>7)throw"amount should be >= 1 and <= 7";e.super.call(this,t);var n={sharp:[0,1.5,-0.5,1,2.5,.5,2],flat:[2,.5,2.5,1,3,1.5,3.5]};for(var r=0;r<this.amount;r++){var i={location:n[this.type][r]};this.add(this.type==="sharp"?new Euterpe.Sharp(i):new Euterpe.Flat(i))}}return Euterpe.extend(Euterpe.Container,e),e}(),Euterpe.Natural=function(){function e(t){this.realWidth=11.5,this.realHeight=[20.5,21.5],e.super.call(this,"Euterpe.Natural",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=1.5*n,i=28*n,s=10*n,o=2.5*n,u=1.5*n;t-=i/2+i/4;var a=new Kinetic.Rect({width:r,height:i,fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1,x:e,y:t}),f=a.clone({x:e+s,y:t+i/2}),l,c,h=new Kinetic.Shape({sceneFunc:function(n){l=e,c=t+i/2,n.beginPath(),n.moveTo(l,c),n.lineTo(l+s+r,c-u),n.lineTo(l+s+r,c+o),n.lineTo(l,c+o+u),n.lineTo(l,c),n.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1}),p=h.clone({sceneFunc:function(n){l=e,c=t+i-o,n.beginPath(),n.moveTo(l,c),n.lineTo(l+s+r,c-u),n.lineTo(l+s+r,c+o),n.lineTo(l,c+o+u),n.lineTo(l,c),n.fillStrokeShape(this)}}),d=[a,f,h,p];return Euterpe.bind(this,d),d}}),e}(),Euterpe.Node=function(){var e=function(e,t){this.id=Euterpe.randomString(20),this.name=e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=Euterpe.getConfig(t,"leftItems",[]),this.rightItems=Euterpe.getConfig(t,"rightItems",[])};return e.prototype.isNode=!0,e.prototype.getLeftWidth=function(e){return this.reduceWidth(this.leftItems,e)},e.prototype.getRightWidth=function(e){return this.reduceWidth(this.rightItems,e)},e.prototype.getRealWidth=function(e,t){var n=Euterpe.getMargins(this,e);return this.realWidth*e+(t?0:n)},e.prototype.getRealHeight=function(e,t){return typeof this.realHeight=="undefined"?t?[0,0]:0:t?[this.realHeight[0]*e,this.realHeight[1]*e]:this.realHeight[0]*e+this.realHeight[1]*e},e.prototype.clone=function(){var e=new this.constructor(this.config);return e.parentContainer=this.parentContainer,e},e.prototype.reduceWidth=function(e,t){return _.reduce(e,function(e,n){return e+n.getRealWidth(t)},0)},e}(),Euterpe.Note=function(){function e(t){this.type=Euterpe.getConfig(t,"type","quarter"),this.beamDir=Euterpe.getConfig(t,"beamDirection",undefined),this.flags=Euterpe.getConfig(t,"flags",0),this.dots=Euterpe.getConfig(t,"dots",0),this.beam=undefined,e.super.call(this,"Euterpe.Note",t),this.headHeight=13.3,this.realHeight=[this.headHeight/2,this.headHeight/2],this.type==="whole"?this.realWidth=this.headWidth=21.2:this.realWidth=this.headWidth=13.6,this.dotWidth=4.5,this.dotMargin=2.5,this.calculateSize()}return Euterpe.extend(Euterpe.Node,e,{beamRealHeight:35,calculateSize:function(){this.beamDir==="up"?this.realHeight=[this.beamRealHeight,this.headHeight/2]:this.beamDir==="down"&&(this.realHeight=[this.headHeight/2,this.beamRealHeight]),this.realWidth+=(this.dotMargin+this.dotWidth)*this.dots,this.flags>0&&(this.realWidth+=13.3)},render:function(e,t,n){this.beamWidth=1.3*n,this.beamHeight=this.beamRealHeight*n,this.scale=n,this.startX=e+this.headWidth*n/2,this.startY=t;var r=[];switch(this.type){case"whole":r=this.initWhole();break;default:r=this.initHalfQuarter()}if(this.dots>0){var i=0,s=this.location;s%1===0&&(i=3*n);var o=e+this.headWidth*n;for(var u=this.dots;u>0;u--)o+=this.dotMargin*n+this.dotWidth*n/2,r.push(new Kinetic.Ellipse({x:o,y:this.Y-i,radius:{x:2*this.scale,y:2*this.scale},fill:"black"})),o+=this.dotWidth*n/2}return Euterpe.bind(this,r),r},initWhole:function(){var e=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:10.5*this.scale,y:6.5*this.scale},fill:"black"}),t=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:5.5*this.scale,y:4*this.scale},fill:"white"});return t.rotation(45),[e,t]},initHalfQuarter:function(){var e=[],t=this,n=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:7.6*this.scale,y:5.6*this.scale},fill:"black"});n.rotation(140),e.push(n);if(this.type==="half"){var r=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:6.6*this.scale,y:2.5*this.scale},fill:"white"});r.rotation(140),e.push(r)}var i,s;if(typeof this.beamDir=="string"){this.beamDir==="up"?(i=n.x()+n.width()/2-this.beamWidth-this.beamWidth/3,s=n.y(),this.beam=new Kinetic.Line({points:[0,0,0,-this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:i,y:s}),e.push(this.beam)):this.beamDir==="down"&&(i=n.x()-n.width()/2+this.beamWidth+this.beamWidth/3,s=n.y(),this.beam=new Kinetic.Line({points:[0,0,0,this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:i,y:s}),e.push(this.beam));if(this.flags==1){var o=this.beam.x(),u=this.beam.y()-this.beamHeight,a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,u),e.bezierCurveTo(o+6.2*t.scale,u+11.8*t.scale,o+21.4*t.scale,u+10.4*t.scale,o+10*t.scale,u+26.4*t.scale),e.bezierCurveTo(o+19.6*t.scale,u+12.4*t.scale,o+5.4*t.scale,u+10.4*t.scale,o-.2*t.scale,u+7.4*t.scale),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:1});e.push(a)}}return Euterpe.bind(this,e),e}}),e}(),Euterpe.PluginAboveBelow=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAboveBelow",t)};return Euterpe.extend(Euterpe.Plugin,e,{roundLine:function(e){var t,n;return e<0?(t=e-Math.ceil(e),t===0?n=e:t>=-0.5?n=Math.ceil(e)-.5:n=Math.floor(e),n):(t=e-Math.floor(e),t===0?n=e:t<=.5?n=Math.floor(e)+.5:n=Math.ceil(e),n)},place:function(e,t,n,r){var i=0,s,o,u,a;typeof r=="number"?s=r:n==="above"?s=0:n==="below"&&(s=4);for(var f=0;f<e.length;f++){var l=e[f];o=l.getRealHeight(t,!0),u=o[0]/this.lineH,a=o[1]/this.lineH,n==="above"?(i=s-this.roundLine(a),s=i-this.roundLine(u)):n==="below"&&(i=s+this.roundLine(a),s=i+this.roundLine(u)),l.config.location=i}},process:function(e,t){this.lineH=Euterpe.global.linePadding+Euterpe.global.lineWidth;var n=Euterpe.select("Euterpe.Column",e);for(var r=0;r<n.length;r++){var i=n[r],s=i.config,o=i.getRealHeight(t,!0),u=this.roundLine(o[0]/this.lineH*-1),a=this.roundLine(o[1]/this.lineH);a<4&&(a=4),_.isArray(s.aboveItems)&&this.place(s.aboveItems,t,"above",u),_.isArray(s.belowItems)&&this.place(s.belowItems,t,"below",a)}return e}}),e}(),Euterpe.PluginAccidentals=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAccidentals",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){var t=Euterpe.select("Euterpe.Note",e);for(var n=0;n<t.length;n++){var r=t[n];if(typeof r.config.sharp=="undefined"&&typeof r.config.flat=="undefined")continue;var i=r.config.sharp||r.config.flat;for(var s=0;s<i;s++)typeof r.config.sharp!="undefined"?r.leftItems.push(new Euterpe.Sharp({})):typeof r.config.flat!="undefined"&&r.leftItems.push(new Euterpe.Flat({}))}return e}}),e}(),Euterpe.PluginAlign=function(){var e=function(t){this.totalWidth=Euterpe.getConfig(t,"totalWidth"),this.nodeMargin=Euterpe.getConfig(t,"nodeMargin",5),this.sideMargin=Euterpe.getConfig(t,"sideMargin",3),e.super.call(this,"Euterpe.PluginAlign",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t){var n,r;for(n=0;n<e.items.length;n++){r=e.items[n];var i,s=this.collectNodes(r);for(i=0;i<s.length;i++)s[i].leftMargin=this.nodeMargin;this.alignSideItems(r)}var o=Euterpe.getGroups(e.items);for(n=0;n<o.length;n++)this.processGroup(o[n],t);return e},alignSideItems:function(e){var t=Euterpe.select("Euterpe.Column",e);for(var n=0;n<t.length;n++){var r=t[n];for(var i=0;i<r.items.length;i++){var s=r.items[i],o;for(o=0;o<s.leftItems.length;o++)s.leftItems[o].rightMargin=this.sideMargin;for(o=0;o<s.rightItems.length;o++)s.rightItems[o].leftMargin=this.sideMargin}}},getColsBars:function(e){var t=[];for(var n=1;n<e.items.length;n++){var r=e.items[n];(r.name==="Euterpe.Column"||r.name==="Euterpe.Bar")&&t.push(r)}return t},stretchAlign:function(e,t){var n=e.getRealWidth(t),r=this.getColsBars(e),i=this.totalWidth-n,s=i/r.length/t;for(var o=0;o<r.length;o++)r[o].leftMargin+=s},getCols:function(e,t){return _.map(e,function(e){return e[t]})},cleanGroup:function(e){var t=[];for(var n=0;n<e.items.length;n++)t[n]=this.getColsBars(e.items[n]);return t},processGroup:function(e,t){var n=this.cleanGroup(e),r,i,s,o,u=_.max(_.map(n,function(e){return e.length}));for(r=0;r<u;r++){o=this.getCols(n,r);var a={},f={},l={};for(i=0;i<o.length;i++){s=o[i];if(typeof s=="undefined")continue;a[s.id]=Euterpe.getDistance(s.parent,s,t)+s.leftMargin*t+s.getLeftWidth(t),f[s.id]=s.getRealWidth(t,!0),l[s.id]=s.getRightWidth(t)}var c=_.max(_.values(a)),h=_.max(_.values(f)),p=_.max(_.values(l));for(i=0;i<o.length;i++){s=o[i];if(typeof s=="undefined")continue;var d=a[s.id],v=f[s.id],m=l[s.id];d<c&&(s.leftMargin+=(c-d)/t),v<h&&(s.rightMargin+=(h-v)/t),m<p&&(s.rightMargin+=(p-m)/t)}}var g=this;_.each(e.items,function(e){g.stretchAlign(e,t)})},collectNodes:function(e){return _.filter(e.items,function(e){return e.name!=="Euterpe.Bar"&&e.name!=="Euterpe.Column"})}}),e}(),Euterpe.Plugin=function(){var e=function(e,t){this.name=e,this.config=t||{}};return e.prototype.isPlugin=!0,e.prototype.process=function(e){return e},e}(),Euterpe.PluginNoteBar=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteBar",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t,n){var r=Euterpe.select("Euterpe.Column",e),i=[],s=[],o=1,u={};for(var a=0;a<r.length;a++){var f=r[a];for(var l=0;l<f.items.length;l++){var c=f.items[l],h=c.config||{};if(h.bar==="begin"||h.bar==="cont"||h.bar==="end")o=h.beamDirection==="down"?-1:1,u[i.length]=o,c.flags=0,s.push(c.id),h.bar==="end"&&(this.adjustBeamHeight(s,o),i.push(_.clone(s)),s.length=0)}}for(var p=0;p<i.length;p++)n.push(this.bind(i[p],u[p]));return e},getTopTwo:function(e,t){var n=_.clone(e);return n.sort(function(e,n){return t===1?e.config.location-n.config.location:n.config.location-e.config.location}),n.length>2?[n[0],n[1]]:n},adjustBeamHeight:function(e,t){e=_.map(e,function(e){return Euterpe.select("#"+e)[0]});if(e.length>2){var n=this.getTopTwo(e,t),r=function(e,n){return Euterpe.getY(e,scale,n)-e.beamRealHeight*scale*t},i=n[0],s=n[1],o=i.parent.parent,u=Euterpe.getDistance(o,i,scale),a=Euterpe.getDistance(o,s,scale);for(var f=0;f<e.length;f++){var l=Math.abs(Euterpe.getY(e[f],scale,0)),c=r(i,l),h=r(s,l),p=(h-c)/(a-u),d=Euterpe.getDistance(o,e[f],scale),v=r(e[f],l),m=p*(d-u)+c,g=v-m;g!==0&&(e[f].beamRealHeight+=g*t/scale,e[f].calculateSize())}}},bind:function(e,t){return function(n,r){var i=Euterpe.select("#"+e[0])[0],s=Euterpe.select("#"+e[e.length-1])[0],o=i.beam.x(),u=i.beam.y()-i.beamHeight*t,a=s.beam.x(),f=s.beam.y()-s.beamHeight*t,l=4*r,c=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,u),e.lineTo(a,f),e.lineTo(a,f+l*t),e.lineTo(o,u+l*t),e.moveTo(o,u),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0});return c}}}),e}(),Euterpe.PluginNoteText=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteText",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){var t=Euterpe.select("Euterpe.Note",e);for(var n=0;n<t.length;n++){var r=t[n];if(typeof r.config.text=="undefined")continue;var i=new Euterpe.Text({text:r.config.text});r.leftItems.push(i)}return e}}),e}(),Euterpe.PluginTab=function(){var e=function(t){e.super.call(this,"Euterpe.PluginTab",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){for(var t=0;t<e.items.length;t++){var n=e.items[t],r=new Euterpe.Row({type:"tab"});for(var i=0;i<n.items.length;i++){var s=n.items[i];if(s.name=="Euterpe.Bar"){r.add(s.clone());continue}var o=new Euterpe.Column({}),u=Euterpe.select("Euterpe.Note",s);for(var a=0;a<u.length;a++){var f=u[a];typeof f.config.tab_location=="number"&&typeof f.config.tab_text=="string"&&(n.group=t.toString(),n.groupType="bracket",r.group=n.group,r.groupType=n.groupType,o.add(new Euterpe.Text({text:f.config.tab_text,location:f.config.tab_location})))}r!==null&&o.items.length>0&&r.add(o)}typeof r.group!="undefined"&&e.items.splice(t+1,0,r)}return e}}),e}(),Euterpe.Rest=function(){function e(t){this.type=Euterpe.getConfig(t,"type","long"),e.super.call(this,"Euterpe.Rest",t),this.basicWidth=7;switch(this.type){case"long":this.realWidth=this.basicWidth,this.realHeight=[0,28];break;case"double_whole":this.realWidth=this.basicWidth,this.realHeight=[0,14.5];break;case"whole":this.realWidth=20,this.realHeight=[0,8];break;case"half":this.realWidth=20,this.realHeight=[6,0];break;case"quarter":this.realWidth=20,this.realHeight=[16.75,22.25];break;case"eighth":this.realWidth=20,this.realHeight=[9.5,16.25];break;case"sixteenth":this.realWidth=20,this.realHeight=[9.5,30.25];break;case"thirty-second":this.realWidth=25,this.realHeight=[9.5,43.25];break;case"sixty-fourth":this.realWidth=30,this.realHeight=[9.5,55.75]}}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=e+this.getRealWidth(n)/2,i=[];switch(this.type){case"half":i.push(this.initHalf(r,t,n));break;case"quarter":i.push(this.initQuarter(r,t,n));break;case"eighth":i.push(this.initEighth(r,t,n));break;case"sixteenth":i.push(this.initSixteen(r,t,n));break;case"thirty-second":i.push(this.initThirtySecond(r,t,n));break;case"sixty-fourth":i.push(this.initSixtyFourth(r,t,n));break;default:i.push(this.simpleRestShape(r,t,n))}return Euterpe.bind(this,i),i},initHalf:function(e,t,n){var r=this.getRealHeight(n,!0);return this.simpleRestShape(e,t-r[0],n)},initQuarter:function(e,t,n){var r=n*.125,i=this.getRealHeight(n,!0),s=t-i[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(r,r),t.beginPath(),t.moveTo(100.2,80.7),t.bezierCurveTo(100.2,100.2,61.1,129.6,61.1,168.7),t.bezierCurveTo(61.1,183.4,90.4,227.5,110,251.9),t.bezierCurveTo(100.2,247,90.4,242.1,75.8,242.1),t.bezierCurveTo(46.4,242.1,36.6,266.6,36.6,281.3),t.bezierCurveTo(36.6,291.1,46.4,300.9,51.3,310.7),t.bezierCurveTo(21.9,291.1,2.4,271.5,2.4,251.9),t.bezierCurveTo(2.4,203,35.8,220.1,60.2,210.3),t.bezierCurveTo(35.8,185.9,12.1,149.2,12.1,134.5),t.bezierCurveTo(12.1,124.7,41.5,90.4,51.3,66),t.lineTo(51.3,51.3),t.bezierCurveTo(51.3,36.6,41.5,17,36.6,2.4),t.bezierCurveTo(56.2,26.8,100.2,70.9,100.2,80.7),t.lineTo(100.2,80.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initEighth:function(e,t,n){var r=n*.125,i=this.getRealHeight(n,!0),s=t-i[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(r,r),t.beginPath(),t.moveTo(92.9,5.2),t.bezierCurveTo(90.4,14.4,88.4,21.5,88.1,21.9),t.bezierCurveTo(84.9,28.7,78.5,37.2,73.6,42.1),t.bezierCurveTo(68.4,47.3,65.5,48.2,61.1,46.5),t.bezierCurveTo(57.4,44.5,56.2,42.4,53.8,31.5),t.bezierCurveTo(51.7,23.4,50.2,19,46.9,15.8),t.bezierCurveTo(38.4,6.5,23.8,5.3,12.6,12.6),t.bezierCurveTo(7.3,16.2,3.3,21.9,.9,28),t.bezierCurveTo(0,31.1,0,32,0,36.4),t.bezierCurveTo(0,40.9,0,42.4,.9,44.9),t.bezierCurveTo(3.6,53.8,9.3,60.7,18.2,64.7),t.bezierCurveTo(24.7,68,27.1,68.4,36,68.4),t.bezierCurveTo(42.5,68.4,44.5,68.4,49.8,67.5),t.bezierCurveTo(57.1,66.3,64.7,63.9,73.2,61.5),t.lineTo(78.5,59.4),t.lineTo(78.5,60.7),t.bezierCurveTo(78,62.3,44.1,190,43.7,190.8),t.bezierCurveTo(43.3,192.4,50.6,195.6,55,195.6),t.bezierCurveTo(59.4,195.6,65.9,192.8,66.3,190.8),t.bezierCurveTo(66.7,190.4,86.1,106.8,110.3,5.1),t.bezierCurveTo(107.1,-2.6,98.1,-0.8,92.9,5.2),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixteen:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.moveTo(132.4,0),t.bezierCurveTo(126.7,0,121.8,4.5,120.8,9.5),t.bezierCurveTo(118,21.7,117.1,25.3,116.8,26.1),t.bezierCurveTo(114.2,31.6,107.4,42.3,102.3,47.8),t.bezierCurveTo(96.7,52.9,94.2,53.8,89.5,52.1),t.bezierCurveTo(85.7,50,84.4,47.8,81.9,36.3),t.bezierCurveTo(79.7,27.8,78,23.1,74.6,19.8),t.bezierCurveTo(65.6,9.9,50.3,8.6,38.3,16.3),t.bezierCurveTo(32.8,20.2,28.6,26.1,26,32.6),t.bezierCurveTo(25.1,35.9,25.1,36.8,25.1,41.5),t.bezierCurveTo(25.1,47.8,25.6,51.3,28.6,56.3),t.bezierCurveTo(32.8,64.9,41.8,71.7,52,74.2),t.bezierCurveTo(63.1,77.2,81.4,74.7,102.3,67.9),t.bezierCurveTo(105.2,66.6,108.2,65.7,108.2,65.7),t.bezierCurveTo(108.2,66.2,104.8,80.2,101,97.7),t.bezierCurveTo(94.6,127.5,94.2,129.7,92,133.4),t.bezierCurveTo(88.6,140.7,81,151,75.8,155.6),t.bezierCurveTo(71.6,159.5,68.7,160.3,64.4,158.6),t.bezierCurveTo(60.6,156.5,59.2,154.3,56.7,142.9),t.bezierCurveTo(54.5,134.3,52.9,129.7,49.4,126.2),t.bezierCurveTo(40.5,116.4,25.1,115.2,13.2,122.8),t.bezierCurveTo(7.7,126.7,3.4,132.6,.9,139),t.bezierCurveTo(0,142.5,0,143.3,0,148),t.bezierCurveTo(0,154.3,.4,157.7,3.4,162.8),t.bezierCurveTo(7.7,171.4,16.6,178.2,26.9,180.8),t.bezierCurveTo(37.9,183.7,59.2,180.8,80.1,173.5),t.bezierCurveTo(82.7,172.7,84.4,172.3,84.4,172.3),t.bezierCurveTo(84.4,172.7,54.5,306.4,53.3,310.7),t.bezierCurveTo(53.3,311.6,53.7,312,55.4,312.8),t.bezierCurveTo(58,314.5,62.2,315.9,65.2,315.9),t.bezierCurveTo(68.2,315.9,72.4,314.5,75,312.8),t.bezierCurveTo(76.7,312,77.2,311.6,77.6,309.4),t.bezierCurveTo(77.6,308.2,100.1,196.1,127.9,60.2),t.bezierCurveTo(131.9,40.2,133.1,33.9,136.5,17),t.bezierCurveTo(137.7,11.1,139.7,0,132.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initThirtySecond:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.moveTo(154.4,0),t.bezierCurveTo(152.8,0,146,0,144.3,7.4),t.bezierCurveTo(141.2,20.7,140.5,22.5,138.9,25.3),t.bezierCurveTo(134.2,35.1,127.5,44.5,122.7,47.5),t.bezierCurveTo(120.2,49.2,118,49.2,115.1,47.9),t.bezierCurveTo(111.2,45.8,109.9,43.6,107.4,32.1),t.bezierCurveTo(105.2,23.6,103.6,18.9,100.1,15.5),t.bezierCurveTo(91.2,5.7,75.8,4.5,63.9,12.1),t.bezierCurveTo(58.4,15.9,54.1,21.9,51.6,28.3),t.bezierCurveTo(50.7,31.7,50.7,32.5,50.7,37.2),t.bezierCurveTo(50.7,43.6,51.1,47.1,54.1,52.2),t.bezierCurveTo(58.4,60.7,67.3,67.5,77.6,70),t.bezierCurveTo(82.3,71.4,94.2,71.4,102.3,70),t.bezierCurveTo(109.1,68.8,117.2,66.6,125.3,64.1),t.bezierCurveTo(129.1,62.8,131.7,61.9,132.1,61.9),t.bezierCurveTo(132.1,62.3,117.6,126.3,116.8,128.4),t.bezierCurveTo(114.2,133.9,107.4,144.6,102.3,150.1),t.bezierCurveTo(96.7,155.2,94.2,156.1,89.5,154.4),t.bezierCurveTo(85.7,152.3,84.4,150.1,81.9,138.6),t.bezierCurveTo(79.7,130.1,78,125.4,74.6,122.1),t.bezierCurveTo(65.6,112.2,50.3,111,38.3,118.6),t.bezierCurveTo(32.8,122.5,28.6,128.4,26,134.9),t.bezierCurveTo(25.1,138.2,25.1,139.1,25.1,143.8),t.bezierCurveTo(25.1,150.1,25.6,153.6,28.6,158.7),t.bezierCurveTo(32.8,167.2,41.8,174,52,176.5),t.bezierCurveTo(63.1,179.5,81.4,177,102.3,170.2),t.bezierCurveTo(105.2,168.9,108.2,168,108.2,168),t.bezierCurveTo(108.2,168.5,104.8,182.5,101,200),t.bezierCurveTo(94.6,229.8,94.2,232,92,235.7),t.bezierCurveTo(88.6,243,81,253.3,75.8,258),t.bezierCurveTo(71.6,261.8,68.7,262.6,64.4,260.9),t.bezierCurveTo(60.6,258.8,59.2,256.6,56.7,245.2),t.bezierCurveTo(54.5,236.7,52.9,232,49.4,228.5),t.bezierCurveTo(40.5,218.7,25.1,217.5,13.2,225.1),t.bezierCurveTo(7.7,229,3.4,234.9,.9,241.3),t.bezierCurveTo(0,244.8,0,245.6,0,250.3),t.bezierCurveTo(0,256.6,.4,260,3.4,265.1),t.bezierCurveTo(7.7,273.7,16.6,280.5,26.9,283.1),t.bezierCurveTo(37.9,286,59.2,283.1,80.1,275.8),t.bezierCurveTo(82.7,275,84.4,274.6,84.4,274.6),t.bezierCurveTo(84.4,275,54.5,408.7,53.3,413),t.bezierCurveTo(53.3,413.9,53.7,414.3,55.4,415.2),t.bezierCurveTo(58,416.8,62.2,418.2,65.2,418.2),t.bezierCurveTo(68.2,418.2,72.4,416.8,75,415.2),t.bezierCurveTo(76.7,414.3,77.2,413.9,77.6,411.7),t.bezierCurveTo(77.6,410.5,100.1,298.4,127.9,162.5),t.bezierCurveTo(141.5,94.4,151.4,44.8,158.6,8.7),t.bezierCurveTo(159.5,4.3,157.9,-0.1,154.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixtyFourth:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.bezierCurveTo(89,2.9,80.5,10.6,76.7,21.2),t.bezierCurveTo(75.8,24.6,75.8,25.4,75.8,30.1),t.bezierCurveTo(75.8,34.8,75.8,36.5,76.7,39.1),t.bezierCurveTo(79.7,48.5,85.7,55.7,95,59.9),t.bezierCurveTo(101.8,63.4,104.4,63.8,113.8,63.8),t.bezierCurveTo(120.2,63.8,122.7,63.8,127.9,63),t.bezierCurveTo(134.6,61.7,144,59.1,151.3,56.6),t.lineTo(155.9,54.8),t.lineTo(155.5,56.6),t.bezierCurveTo(155.1,57.4,152.1,72.3,148.2,89.3),t.bezierCurveTo(141.5,119.2,141.1,120.9,138.9,124.7),t.bezierCurveTo(134.2,134.5,127.5,143.9,122.7,146.9),t.bezierCurveTo(120.2,148.6,118,148.6,115.1,147.3),t.bezierCurveTo(111.2,145.2,109.9,143,107.4,131.5),t.bezierCurveTo(105.2,123,103.6,118.3,100.1,114.9),t.bezierCurveTo(91.2,105.1,75.8,103.9,63.9,111.5),t.bezierCurveTo(58.4,115.3,54.1,121.3,51.6,127.7),t.bezierCurveTo(50.7,131.1,50.7,131.9,50.7,136.6),t.bezierCurveTo(50.7,143,51.1,146.5,54.1,151.6),t.bezierCurveTo(58.4,160.1,67.3,166.9,77.6,169.4),t.bezierCurveTo(82.3,170.8,94.2,170.8,102.3,169.4),t.bezierCurveTo(109.1,168.2,117.2,166,125.3,163.5),t.bezierCurveTo(129.1,162.3,131.7,161.3,132.1,161.3),t.bezierCurveTo(132.1,161.8,117.6,225.7,116.8,227.8),t.bezierCurveTo(114.2,233.3,107.4,244,102.3,249.5),t.bezierCurveTo(96.7,254.6,94.2,255.6,89.5,253.8),t.bezierCurveTo(85.7,251.7,84.4,249.5,81.9,238),t.bezierCurveTo(79.7,229.5,78,224.8,74.6,221.5),t.bezierCurveTo(65.6,211.6,50.3,210.4,38.3,218),t.bezierCurveTo(32.8,221.9,28.6,227.8,26,234.3),t.bezierCurveTo(25.1,237.6,25.1,238.5,25.1,243.2),t.bezierCurveTo(25.1,249.5,25.6,253,28.6,258.1),t.bezierCurveTo(32.8,266.6,41.8,273.4,52,275.9),t.bezierCurveTo(63.1,278.9,81.4,276.4,102.3,269.6),t.bezierCurveTo(105.2,268.3,108.2,267.4,108.2,267.4),t.bezierCurveTo(108.2,267.9,104.8,281.9,101,299.4),t.bezierCurveTo(94.6,329.2,94.2,331.4,92,335.1),t.bezierCurveTo(88.6,342.4,81,352.7,75.8,357.4),t.bezierCurveTo(71.6,361.2,68.7,362,64.4,360.3),t.bezierCurveTo(60.6,358.2,59.2,356,56.7,344.6),t.bezierCurveTo(54.5,336.1,52.9,331.4,49.4,328),t.bezierCurveTo(40.5,318.1,25.1,316.9,13.2,324.5),t.bezierCurveTo(7.7,328.4,3.4,334.3,.9,340.7),t.bezierCurveTo(0,344.2,0,345,0,349.7),t.bezierCurveTo(0,356,.4,359.4,3.4,364.5),t.bezierCurveTo(7.7,373.1,16.6,379.9,26.9,382.5),t.bezierCurveTo(37.9,385.4,59.2,382.5,80.1,375.2),t.bezierCurveTo(82.7,374.4,84.4,374,84.4,374),t.bezierCurveTo(84.4,374.4,54.5,508.1,53.3,512.4),t.bezierCurveTo(53.3,513.3,53.7,513.7,55.4,514.6),t.bezierCurveTo(58,516.2,62.2,517.6,65.2,517.6),t.bezierCurveTo(68.2,517.6,72.4,516.2,75,514.6),t.bezierCurveTo(76.7,513.7,77.2,513.3,77.6,511.1),t.bezierCurveTo(77.6,509.9,100.1,397.8,127.9,261.9),t.bezierCurveTo(171.7,42.9,177.2,14.8,176.8,13.9),t.bezierCurveTo(175.6,11.8,173.9,11,171.3,11),t.bezierCurveTo(167.5,11,166.6,11.8,162.8,19.1),t.bezierCurveTo(157.3,29.7,151.7,37.4,147.8,40.4),t.bezierCurveTo(145.7,42.1,143.6,42.1,140.2,40.8),t.bezierCurveTo(136.4,38.6,135.1,36.5,132.5,25),t.bezierCurveTo(130,13.5,126.9,8.4,120.6,4.1),t.bezierCurveTo(114.6,.3,107,-0.9,100.1,.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},simpleRestShape:function(e,t,n){return new Kinetic.Rect({x:e,y:t,width:this.getRealWidth(n),height:this.getRealHeight(n),fill:"black",strokeWidth:0})}}),e}(),Euterpe.Row=function(){function e(t){e.super.call(this,"Euterpe.Row",t),this.type=Euterpe.getConfig(t,"type"),this.group=Euterpe.getConfig(t,"group",undefined),this.groupType=Euterpe.getConfig(t,"groupType",undefined),this.type==="measure"?(this.numberOfLines=5,this.realHeight=[0,57.3]):this.type==="tab"&&(this.numberOfLines=6,this.realHeight=[0,71.5]),this.prepared=[]}return Euterpe.extend(Euterpe.Container,e,{render:function(e,t,n){var r=[],i=0,s=e;for(var o=0;o<this.items.length;o++){var u=this.items[o];u.X=e+u.leftMargin*n,u.Y=t,r.push(u.render(u.X,u.Y,n));var a=u.getRealWidth(n);i+=a,e+=a}r.push(this.renderSelf(s,t,n,i));if(this.type==="measure"){var f=[];this.prepareLedgerLines(f,Euterpe.select("Euterpe.Note",this),t,n),r.push(this.renderLedgerLines(f,n))}return r},prepareLedgerLines:function(e,t,n,r){for(var i=0;i<t.length;i++){var s=t[i];if(typeof s.config.location=="number"){var o=s.headWidth*r,u;s.config.location>this.numberOfLines-1?(u=Math.floor(s.config.location),this.addLedgerLine(s,u,s.X,o,n,e,r)):s.config.location<0&&(u=Math.ceil(s.config.location),this.addLedgerLine(s,u,s.X,o,n,e,r))}}},addLedgerLine:function(e,t,n,r,i,s,o){var u;for(;;){if(t>0&&t<=4||t===0)break;u=!1;var a=Euterpe.getY(t,o,i);if(e.name==="Euterpe.Note"){for(var f=0;f<s.length;f++){var l=s[f];if(l[0]===n&&l[1]===a){u=!0;break}}u||s.push([n,a,r])}t+=t>0?-1:1}},renderLedgerLines:function(e,t){var n=[];for(var r=0;r<e.length;r++){var i=e[r][0],s=e[r][1],o=5*t,u=e[r][2]+o*2;n.push(new Kinetic.Line({points:[0,0,u,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:i-o,y:s}))}return n},renderSelf:function(e,t,n,r){var i=new Kinetic.Line({points:[0,0,r,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:e,y:t}),s=new Kinetic.Group({});s.add(i);for(var o=2;o<this.numberOfLines+1;o++){var u=Euterpe.getY(o-1,n,t),a=i.clone({y:u});s.add(a)}return s}}),e}(),Euterpe.Score=function(){function e(t){this.layer=t.layer,this.lineMargin=Euterpe.getConfig(t,"lineMargin",0),this.titleMargin=Euterpe.getConfig(t,"titleMargin",0),this.musicByMargin=Euterpe.getConfig(t,"musicByMargin",0),this.tuningMargin=Euterpe.getConfig(t,"tuningMargin",0),this.title=Euterpe.getConfig(t,"title",undefined),this.musicBy=Euterpe.getConfig(t,"musicBy",undefined),this.tuning=Euterpe.getConfig(t,"tuning",undefined),this.titleHeight=0,this.musicByHeight=0,this.tuningHeight=0,typeof this.title!="undefined"&&(this.titleText=new Euterpe.Text({text:this.title,fontSize:40,fontFamily:"Serif"}),this.titleWidth=this.titleText.getRealWidth(1),this.titleHeight=this.titleText.getRealHeight(1)),typeof this.musicBy!="undefined"&&(this.musicByText=new Euterpe.Text({fontSize:20,text:"Music by "+this.musicBy,fontFamily:"Serif"}),this.musicByHeight=this.musicByText.getRealHeight(1)),typeof this.tuning!="undefined"&&(this.tuningText=new Euterpe.Text({fontSize:15,text:this.tuning,fontFamily:"Serif",fontStyle:"italic"}),this.tuningHeight=this.tuningText.getRealHeight(1)),e.super.call(this,"Euterpe.Score",t)}return Euterpe.extend(Euterpe.Container,e,{bracketExtraUp:5,bracketExtraDown:5,getRealHeight:function(e,t){var n=this.doGetRealHeight(this.items,e,t),r=0;return r+=this.titleHeight*e,r+=this.titleMargin*e,r+=this.musicByHeight*e,r+=this.musicByMargin*e,r+=this.tuningHeight*e,r+=this.tuningMargin*e,t?n[0]+=r:n+=r,n},render:function(e,t,n){var r=0,i=[],s,o=Euterpe.getGroups(this.items),u=0;for(s=0;s<o.length;s++){var a=o[s];a.groupType==="bracket"&&6>u&&(u=6)}e+=u*n;var f=0;t=this.renderMeta(e,t,n,i);for(s=0;s<this.items.length;s++){var l=this.items[s],c=this.doGetRealHeight([l],n,!0);r!==0&&(r+=c[0]);var h=t+r;l.Y=h,l.X=e,f<o.length&&o[f].first===l.id&&(i.push(this.renderBracket(e-u*n,h,n,o[f].items)),f++),r+=c[1],i.push(l.render(e,h,n))}return i},renderMeta:function(e,t,n,r){var i=this.getRealHeight(n,!0);t-=i[0];var s=(this.titleHeight+this.musicByHeight+this.tuningHeight+this.titleMargin+this.musicByMargin+this.tuningMargin)*n;return typeof this.title!="undefined"&&(t+=this.titleHeight*n/2,r.push(this.renderText(this.titleText,this.titleWidth,e,t,n,!0)),t+=this.titleHeight*n/2,t+=this.titleMargin*n),typeof this.musicBy!="undefined"&&(t+=this.musicByHeight*n/2,r.push(this.renderText(this.musicByText,0,e,t,n)),t+=this.musicByHeight*n/2,t+=this.musicByMargin*n),typeof this.tuning!="undefined"&&(t+=this.tuningHeight*n/2,r.push(this.renderText(this.tuningText,0,e,t,n)),t+=this.tuningHeight*n/2,t+=this.tuningMargin*n),t+=i[0]-s,t},renderText:function(e,t,n,r,i,s){var o=n;if(s){var u=this.items[0].getRealWidth(i);o=n+(u/2-t/2)}return e.render(o,r,i)},doGetRealHeight:function(e,t,n){var r,i=0,s=Euterpe.getGroups(this.items),o=function(e){return _.find(s,function(t){return t.first===e.id})},u=function(e){return _.find(s,function(t){return t.last===e.id})};for(var a=0;a<e.length;a++){var f=e[a],l=f.getRealHeight(t,!0);o(f)&&(l[0]+=this.bracketExtraUp*t),u(f)&&(l[1]+=this.bracketExtraDown*t);var c=l[1]+l[0];typeof r=="undefined"&&(r=l[0]+i),i+=c+this.lineMargin*t}return n?[r,i-r]:i},renderBracket:function(e,t,n,r){var i=this.bracketExtraUp*n,s=this.bracketExtraDown*n,o=this.doGetRealHeight(r,n,!0),u=o[0]-i,a=o[1]-s-this.lineMargin*n;return new Kinetic.Shape({sceneFunc:function(r){r.beginPath();var o=10*n;r.moveTo(e+o,t-u-i),r.lineTo(e,t-u),r.lineTo(e,t+a),r.lineTo(e+o,t+a+s),r.lineTo(e+o/5,t+a),r.lineTo(e+o/5,t-u),r.lineTo(e+o,t-u-i),r.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})}}),e}(),Euterpe.Sharp=function(){function e(t){e.super.call(this,"Euterpe.Sharp",t),this.realWidth=9,this.realHeight=[11,11]}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=this.realHeight[0]+this.realHeight[1];this.startY=t-r*n/2-n;var i=this.realWidth*n,s=r*n,o=1.5*n,u=new Kinetic.Rect({x:this.X+i/3.6-o/2,y:this.startY+2*n,width:o,height:s,fill:"black",strokeWidth:0}),a=u.clone({x:this.X+i-i/3.6-o/2,y:this.startY}),f=4.5*n,l=this.startY+s/4+3*n;o=3*n;var c=new Kinetic.Line({points:[this.X,l,this.X,l+o,this.X+i,l+o-f,this.X+i,l-f],fill:"black",strokeWidth:0,closed:!0});l=this.startY+s-s/4;var h=c.clone({points:[this.X,l,this.X,l+o,this.X+i,l+o-f,this.X+i,l-f]}),p=[u,a,c,h];return Euterpe.bind(this,p),p}}),e}(),Euterpe.StringNumber=function(){function e(t){this.string=Euterpe.getConfig(t,"string"),this.fontSize=10,this.fontFamily="Arial";if(typeof this.string!="number"||this.string<0||this.string>6)throw"Invalid string value";this.string=this.string.toString(),this.textWidth=5,this.textHeight=7.6,this.realWidth=21.3,this.realHeight=[10.65,10.65],e.super.call(this,"Euterpe.StringNumber",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=[],i=e+this.realWidth*n/2;return r.push(new Kinetic.Circle({x:i,y:t,radius:10*n,fill:"white",stroke:"black",strokeWidth:n})),r.push(new Kinetic.Text({x:i-this.textWidth*n/2,y:t-this.textHeight*n/2,text:this.string,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fill:"black"})),Euterpe.bind(this,r),r}}),e}(),Euterpe.Text=function(){function e(t){this.text=Euterpe.getConfig(t,"text"),this.color=Euterpe.getConfig(t,"color","black"),this.fontFamily=Euterpe.getConfig(t,"fontFamily","Arial"),this.fontSize=Euterpe.getConfig(t,"fontSize",10),this.fontStyle=Euterpe.getConfig(t,"fontStyle","normal");var n=1,r=new Kinetic.Text({x:0,y:0,text:this.text,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fontStyle:this.fontStyle}),i=r.height()/n;this.realWidth=r.width()/n,this.realHeight=[i/2,i/2],e.super.call(this,"Euterpe.Text",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=[new Kinetic.Text({x:e,y:t-(this.realHeight[0]*n+this.realHeight[1]*n)/2,text:this.text,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fontStyle:this.fontStyle,fill:this.color})];return Euterpe.bind(this,r),r}}),e}(),Euterpe.TimeSignature=function(){function e(t){this.numerator=Euterpe.getConfig(t,"numerator",4),this.denominator=Euterpe.getConfig(t,"denominator",4),e.super.call(this,t),this.add(new Euterpe.TimeSignatureShape(this.numerator,0)),this.add(new Euterpe.TimeSignatureShape(this.denominator,2))}return Euterpe.extend(Euterpe.Column,e,{name:"Euterpe.TimeSignature"}),e}(),Euterpe.TimeSignatureShape=function(){function e(t,n){this.yoffset=2;var r={4:[0,24+this.yoffset]};this.digit=t.toString(),this.realWidth=22.4,this.realHeight=r[t],e.super.call(this,"Euterpe.TimeSignatureShape",{location:n})}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=this;this.scale=n,this.startX=e,this.startY=t+this.yoffset*n;var i=[];return this.digit==="4"&&i.push(new Kinetic.Shape({sceneFunc:function(e){var t=r.startX+17.6*n,i=r.startY;e.beginPath(),e.moveTo(t,i),e.lineTo(t-10*r.scale,i),e.bezierCurveTo(t-8.8*r.scale,i+6.8*r.scale,t-10.54*r.scale,i+10.66*r.scale,t-17.6*r.scale,i+16*r.scale),e.lineTo(t-17.6*r.scale,i+17*r.scale),e.lineTo(t-3.6*r.scale,i+17*r.scale),e.lineTo(t-3.6*r.scale,i+22.4*r.scale),e.lineTo(t-5.6*r.scale,i+22.4*r.scale),e.lineTo(t-5.6*r.scale,i+23.4*r.scale),e.lineTo(t-5.6*r.scale,i+23.4*r.scale),e.lineTo(t+4.4*r.scale,i+23.4*r.scale),e.lineTo(t+4.4*r.scale,i+22.4*r.scale),e.lineTo(t+2.4*r.scale,i+22.4*r.scale),e.lineTo(t+2.4*r.scale,i+17*r.scale),e.lineTo(t+4.4*r.scale,i+17*r.scale),e.lineTo(t+4.4*r.scale,i+16*r.scale),e.lineTo(t+2.4*r.scale,i+16*r.scale),e.lineTo(t+2.4*r.scale,i+1.4*r.scale),e.lineTo(t-3.6*r.scale,i+7.2*r.scale),e.lineTo(t-3.6*r.scale,i+16*r.scale),e.lineTo(t-16.6*r.scale,i+16*r.scale),e.lineTo(t,i),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})),Euterpe.bind(this,i),i}}),e}();Euterpe.TrebleClef=function(){function e(t){this.realWidth=36.8,t.location=0,e.super.call(this,"Euterpe.TrebleClef",t)}return Euterpe.extend(Euterpe.Node,e,{realHeight:[26.3,82],render:function(e,t,n){this.startX=e,this.startY=t-27*n,this.scale=.125*n;var r=this,i=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(159,3),e.quadraticCurveTo(129,50,117,93),e.quadraticCurveTo(107,126,102,167),e.quadraticCurveTo(101,192,102,210),e.quadraticCurveTo(107,255,116,297),e.quadraticCurveTo(63,351,44,375),e.quadraticCurveTo(24,401,15,429),e.quadraticCurveTo(2,464,3,503),e.quadraticCurveTo(5,540,20,575),e.quadraticCurveTo(29,596,48,615),e.quadraticCurveTo(62,630,87,645),e.quadraticCurveTo(113,660,150,666),e.quadraticCurveTo(177,668,194,665),e.quadraticCurveTo(204,720,213,776),e.quadraticCurveTo(216,795,216,813),e.quadraticCurveTo(203,849,158,857),e.quadraticCurveTo(132,857,120,842),e.quadraticCurveTo(152,845,166,813),e.quadraticCurveTo(165,821,168,802),e.quadraticCurveTo(166,775,151,765),e.quadraticCurveTo(132,750,107,758),e.quadraticCurveTo(86,768,78,789),e.quadraticCurveTo(71,818,90,840),e.quadraticCurveTo(105,857,129,865),e.quadraticCurveTo(149,872,177,865),e.quadraticCurveTo(194,860,209,846),e.quadraticCurveTo(231,828,230,803),e.quadraticCurveTo(221,735,207,662),e.quadraticCurveTo(248,650,267,626),e.quadraticCurveTo(293,599,296,566),e.quadraticCurveTo(300,527,285,494),e.quadraticCurveTo(270,462,234,444),e.quadraticCurveTo(215,435,189,435),e.quadraticCurveTo(177,435,164,438),e.quadraticCurveTo(155,396,146,354),e.quadraticCurveTo(183,315,203,275),e.quadraticCurveTo(219,243,222,210),e.quadraticCurveTo(227,167,221,137),e.quadraticCurveTo(213,93,192,51),e.quadraticCurveTo(180,29,159,3),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),s=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(191,93),e.quadraticCurveTo(179,83,171,93),e.quadraticCurveTo(126,162,131,281),e.quadraticCurveTo(188,239,203,188),e.quadraticCurveTo(209,162,204,135),e.quadraticCurveTo(200,111,191,93),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),o=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(171,473),e.quadraticCurveTo(188,555,206,648),e.quadraticCurveTo(237,639,255,620),e.quadraticCurveTo(283,588,283,558),e.quadraticCurveTo(285,525,269,501),e.quadraticCurveTo(252,476,216,470),e.quadraticCurveTo(194,465,171,473),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),u=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,446),e.quadraticCurveTo(141,411,132,369),e.quadraticCurveTo(90,401,68,435),e.quadraticCurveTo(45,467,39,503),e.quadraticCurveTo(30,540,45,576),e.quadraticCurveTo(60,612,92,633),e.quadraticCurveTo(123,651,161,654),e.quadraticCurveTo(174,654,188,653),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,444),e.quadraticCurveTo(120,456,101,480),e.quadraticCurveTo(83,504,84,536),e.quadraticCurveTo(86,567,107,588),e.quadraticCurveTo(114,597,126,605),e.quadraticCurveTo(116,593,107,581),e.quadraticCurveTo(95,560,99,537),e.quadraticCurveTo(105,509,132,491),e.quadraticCurveTo(143,482,164,476),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),f=[i,s,o,u,a];return Euterpe.bind(this,f),f}}),e}();Euterpe.Column=function(){function e(t){e.super.call(this,"Euterpe.Column",t)}return Euterpe.extend(Euterpe.Container,e,{getRealWidth:function(e,t){var n=Euterpe.getMargins(this,e),r=this.collectItems(),i=_.max(_.map(r,function(n){var r=0,i=0;return n.isNode&&(r=n.getLeftWidth(e),i=n.getRightWidth(e)),n.getRealWidth(e,t)+(t?0:r+i)}));return i+(t?0:n)},getRealHeight:function(e,t){var n=this.collectItems();return Euterpe.getRealHeight(this,n,e,t)},collectItems:function(){var e=this.items;return _.isArray(this.config.aboveItems)&&(e=this.config.aboveItems.concat(this.items)),_.isArray(this.config.belowItems)&&(e=e.concat(this.config.belowItems)),e},render:function(e,t,n){var r=[],i,s,o=0,u=this.collectItems(),a=this.renderSideItems(u,n,r,e,t,!0);e+=a;for(s=0;s<u.length;s++)i=u[s],i.X=e,i.Y=Euterpe.getY(i,n,t),r.push(i.render(i.X,i.Y,n)),a=i.getRealWidth(n),a>o&&(o=a);return this.renderSideItems(this.items,n,r,e+o,t,!1),r},renderSideItems:function(e,t,n,r,i,s){var o=[],u=0,a=0;if(s)for(f=0;f<e.length;f++)e[f].isNode?(c=e[f].getLeftWidth(t),o.push(c),c>u&&(u=c)):o.push(0);for(var f=0;f<e.length;f++){var l=e[f],c=0,h=0;typeof o[f]!="undefined"&&o[f]!==u&&(h=u-o[f]);var p=s?l.leftItems:l.rightItems;for(var d=0;d<p.length;d++){var v=p[d];typeof v.config.location=="undefined"&&(v.config.location=l.config.location),v.X=r+v.leftMargin*t+h+c,v.Y=Euterpe.getY(v,t,i),n.push(v.render(v.X,v.Y,t)),c+=v.getRealWidth(t)}c>a&&(a=c)}return a},reduceWidth:function(e,t){return _.reduce(e,function(e,n){return e+n.getRealWidth(t)},0)}}),e}();Euterpe.ContainerDepth=0,Euterpe.Container=function(){var e=function(e,t){this.id=Euterpe.randomString(20),this.items=[],this.name=this.name||e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=[],this.rightItems=[];if(typeof t!="undefined"&&_.isArray(t.items))for(var n=0;n<t.items.length;n++)this.add(t.items[n])};return e.prototype={getRealWidth:function(e,t){var n=t?0:Euterpe.getMargins(this,e);for(var r=0;r<this.items.length;r++)n+=this.items[r].getRealWidth(e,t);return n},getRealHeight:function(e,t){return Euterpe.getRealHeight(this,this.items,e,t)},isContainer:!0,getLeftWidth:function(e){var t=_.map(this.items,function(t){return t.getLeftWidth(e)});return _.max(t)},getRightWidth:function(e){var t=_.map(this.items,function(t){return t.getRightWidth(e)});return _.max(t)},clear:function(){this.items.length=0},size:function(){return this.items.length},add:function(e){var t=this;if(_.isArray(e))return _.each(e,function(e){t.add(e)});e.parent=this,this.items.push(e)},prepend:function(e){e.parentContainer=this,this.items.unshift(e)},insertBefore:function(e,t){for(var n=0;n<this.items.length;n++){var r=this.items[n];if(r.id===e)return this.items.splice(n,0,t)}},baseRender:function(e,t,n,r,i){Euterpe.ContainerDepth+=1;var s=[],o=function(e,t,n,r,i){var s=Euterpe.getY(e,r,n);return e.Y=s,e.render(t,s,r,i)};r=r||o,i=i||o;for(var u=0;u<this.items.length;u++){var a=this.items[u],f=0;Euterpe.log.debug((new Array(Euterpe.ContainerDepth)).join("  "),a),a.isContainer?(a.parentContainer=this,f=a.getRealWidth(n),a.X=e+a.leftMargin*n,a.Y=t,s.push(i(a,a.X,a.Y,n,u)),e+=f):(a.parentContainer=this,f=a.getRealWidth(n),a.X=e+a.leftMargin*n,a.Y=t,s.push(r(a,a.X,a.Y,n,u)),e+=f)}return Euterpe.ContainerDepth-=1,s},render:function(e,t,n){return Euterpe.baseRender(this.items,e,t,n)}},e}();function Euterpe(){}Euterpe.const={LOG_DEBUG:1,LOG_INFO:2,LOG_WARNING:3,LOG_ERROR:4},Euterpe.global={loglevel:Euterpe.const.LOG_INFO},Euterpe.plugins={plugins:[],add:function(){var e=this;_.each(arguments,function(t){e.plugins.push(t)})},fold:function(e,t,n){return _.reduce(this.plugins,function(e,r){return r.process(e,t,n)},e)}},Euterpe.getConfig=function(e,t,n){return typeof e=="undefined"?n:typeof e[t]=="undefined"?n:e[t]},Euterpe.getY=function(e,t,n){var r;if(typeof e=="number")r=e;else{if(typeof e.config=="undefined"||typeof e.config.location=="undefined")return n;r=e.config.location}if(typeof r=="function")return r(t,n);var i=Euterpe.global.linePadding/2+Euterpe.global.lineWidth/2,s,o,u;return r>=0?(o=Math.floor(r),u=Math.ceil(r)>r?i:0,s=Euterpe.global.linePadding*o+Euterpe.global.lineWidth*o,n+s+u):r<0?(o=Math.ceil(r),u=Math.floor(r)<r?i:0,s=Euterpe.global.linePadding*-o+Euterpe.global.lineWidth*-o,n+s*-1-u):n},Euterpe.initNode=function(e,t){e.isNode=!0,e.nodeName=t},Euterpe.extend=function(e,t,n){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t,t.super=e,typeof n=="object"&&_.extend(t.prototype,n)},Euterpe.render=function(e,t,n,r,i,s){Euterpe.initLog(),Euterpe.global.root=e,Euterpe.global.background=new Kinetic.Layer({}),Euterpe.global.foreground=new Kinetic.Layer({}),Euterpe.global.linePadding=13*i,Euterpe.global.lineWidth=i;var o=[],u=Euterpe.plugins.fold(e,i,o),a=u.getRealHeight(i,!0);n+=a[0];var f=n+a[1];Euterpe.stage=new Kinetic.Stage({container:s,width:r,height:f}),Euterpe.stage.add(Euterpe.global.foreground),Euterpe.stage.add(Euterpe.global.background);var l=_.flatten(u.render(t+e.leftMargin*i,n,i));for(var c=0;c<l.length;c++)l[c].layer2draw==="background"?Euterpe.global.background.add(l[c]):Euterpe.global.foreground.add(l[c]);for(var h=0;h<o.length;h++){var p=o[h],d=p(u,i);if(typeof d=="undefined")continue;d.layer2draw==="background"?Euterpe.global.background.add(d):Euterpe.global.foreground.add(d)}return Euterpe.stage},Euterpe.getMargins=function(e,t){return e.leftMargin*t+e.rightMargin*t},Euterpe.randomString=function(e){return(new Array(e+1)).join((Math.random().toString(36)+"00000000000000000").slice(2,18)).slice(0,e)},Euterpe.select=function(e,t){var n=function(t){return e[0]==="#"?t.id===e.slice(1,e.length):t.name===e};t=t||Euterpe.global.root;var r=[];if(t.isNode&&n(t))r.push(t);else if(t.isContainer)for(var i=0;i<t.items.length;i++){var s=t.items[i];n(s)&&r.push(s),s.isContainer&&r.push(Euterpe.select(e,s))}return _.flatten(r)},Euterpe.replace=function(e,t,n){for(var r=0;r<e.items.length;r++){var i=e.items[r];if(i.id==t)return n.parentContainer=e,e.items[r]=n,!0;if(i.isContainer&&Euterpe.replace(i,t,n))break}return!1},Euterpe.initLog=function(){var e=window.console||{},t=function(){};Euterpe.log={debug:t,info:t,warn:t,error:t},Euterpe.const.LOG_DEBUG>=Euterpe.global.loglevel&&e.log&&(Euterpe.log.debug=e.debug.bind(e)),Euterpe.const.LOG_INFO>=Euterpe.global.loglevel&&e.info&&(Euterpe.log.info=e.info.bind(e)),Euterpe.const.LOG_WARNING>=Euterpe.global.loglevel&&e.warn&&(Euterpe.log.warn=e.warn.bind(e)),Euterpe.const.LOG_ERROR>=Euterpe.global.loglevel&&e.error&&(Euterpe.log.error=e.error.bind(e))},Euterpe.getDistance=function(e,t,n){var r=0;for(var i=0;i<e.items.length;i++){var s=e.items[i];if(s.id===t.id)break;if(s.isContainer&&Euterpe.select("#"+t.id,s).length>0){r+=s.leftMargin*n,r+=Euterpe.getDistance(s,t,n);break}r+=s.getRealWidth(n)}return r},Euterpe.getRealHeight=function(e,t,n,r){var i=0,s,o,u,a,f;typeof e.realHeight!="undefined"&&(f=Euterpe.getY(e,n,i),s=e.realHeight[0]*n,o=e.realHeight[1]*n);for(var l=0;l<t.length;l++){var c=t[l],h=c.getRealHeight(n,!0);f=Euterpe.getY(c,n,i),u=f-h[0],a=f+h[1];if(typeof s=="undefined"||u<s)s=u;if(typeof o=="undefined"||a>o)o=a}return r?[s*-1,o]:o-s},Euterpe.baseRender=function(e,t,n,r){var i=[],s,o;for(o=0;o<e.length;o++)s=e[o],s.X=t,s.Y=Euterpe.getY(s,r,n),i.push(s.render(s.X,s.Y,r)),t+=s.getRealWidth(r);return i},Euterpe.getGroups=function(e){var t=[],n=null,r=null,i=null,s=[],o=null;for(var u=0;u<e.length;u++){var a=e[u];typeof a.group!="undefined"?(n!==a.group&&(n!==null&&t.push({first:i,last:o,groupType:r,items:_.clone(s)}),i=a.id,n=a.group,r=a.groupType,s.length=0),s.push(a)):t.push({first:undefined,last:undefined,groupType:undefined,items:[a]}),o=a.id}return s.length>0&&t.push({first:i,last:o,groupType:r,items:s}),t},Euterpe.bind=function(e,t){if(typeof e.config.on=="undefined")return;_.isArray(t)?t=_.flatten(t):t=[t];var n={},r=function(r,i){return function(){i.call(r,e,t,n)}},i=_.keys(e.config.on);for(var s=0;s<i.length;s++){var o=i[s];_.each(t,function(t){t.on(o,r(t,e.config.on[o]))})}};Euterpe.Flat=function(){function e(t){this.realWidth=12.25,this.realHeight=[16.3,9],e.super.call(this,"Euterpe.Flat",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=(this.realHeight[0]+this.realHeight[1])*n;this.barWidth=1.5*n,t-=16.25*n;var i=new Kinetic.Line({points:[0,0,0,r],stroke:"black",strokeWidth:this.barWidth,x:e,y:t}),s=t+r,o=e+this.barWidth/2,u=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,s),e.lineTo(o+7*n,s-5.25*n),e.bezierCurveTo(o+12*n,s-8.75*n,o+12.5*n,s-19.75*n,o,s-13.75*n),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,s-1.25*n),e.bezierCurveTo(o+9.75*n,s-6.75*n,o+8.25*n,s-17.25*n,o,s-12.75*n),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),f=[i,u,a];return Euterpe.bind(this,f),f}}),e}();Euterpe.helpers={},Euterpe.helpers.events={highlight:function(e,t){function n(n,r,i){typeof i.fill=="undefined"&&(i.fill={}),typeof i.stroke=="undefined"&&(i.stroke={});for(var s=0;s<r.length;s++){var o=r[s];o.fill()===e&&(i.fill[o._id]=e,o.fill(t)),o.stroke()===e&&(i.stroke[o._id]=e,o.stroke(t))}Euterpe.global.background.draw(),Euterpe.global.foreground.draw()}function r(e,t,n){for(var r=0;r<t.length;r++){var i=t[r];typeof n.fill[i._id]!="undefined"&&i.fill(n.fill[i._id]),typeof n.stroke[i._id]!="undefined"&&i.stroke(n.stroke[i._id])}Euterpe.global.background.draw(),Euterpe.global.foreground.draw()}return[n,r]}};Euterpe.KeySignature=function(){function e(t){this.type=Euterpe.getConfig(t,"type"),this.amount=Euterpe.getConfig(t,"amount");if(this.type!=="sharp"&&this.type!=="flat")throw"Invalid type argument";if(typeof this.amount!="number"||this.amount<1||this.amount>7)throw"amount should be >= 1 and <= 7";e.super.call(this,t);var n={sharp:[0,1.5,-0.5,1,2.5,.5,2],flat:[2,.5,2.5,1,3,1.5,3.5]};for(var r=0;r<this.amount;r++){var i={location:n[this.type][r]};this.add(this.type==="sharp"?new Euterpe.Sharp(i):new Euterpe.Flat(i))}}return Euterpe.extend(Euterpe.Container,e),e}();Euterpe.Natural=function(){function e(t){this.realWidth=11.5,this.realHeight=[20.5,21.5],e.super.call(this,"Euterpe.Natural",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=1.5*n,i=28*n,s=10*n,o=2.5*n,u=1.5*n;t-=i/2+i/4;var a=new Kinetic.Rect({width:r,height:i,fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1,x:e,y:t}),f=a.clone({x:e+s,y:t+i/2}),l,c,h=new Kinetic.Shape({sceneFunc:function(n){l=e,c=t+i/2,n.beginPath(),n.moveTo(l,c),n.lineTo(l+s+r,c-u),n.lineTo(l+s+r,c+o),n.lineTo(l,c+o+u),n.lineTo(l,c),n.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1}),p=h.clone({sceneFunc:function(n){l=e,c=t+i-o,n.beginPath(),n.moveTo(l,c),n.lineTo(l+s+r,c-u),n.lineTo(l+s+r,c+o),n.lineTo(l,c+o+u),n.lineTo(l,c),n.fillStrokeShape(this)}}),d=[a,f,h,p];return Euterpe.bind(this,d),d}}),e}();Euterpe.Node=function(){var e=function(e,t){this.id=Euterpe.randomString(20),this.name=e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=Euterpe.getConfig(t,"leftItems",[]),this.rightItems=Euterpe.getConfig(t,"rightItems",[])};return e.prototype.isNode=!0,e.prototype.getLeftWidth=function(e){return this.reduceWidth(this.leftItems,e)},e.prototype.getRightWidth=function(e){return this.reduceWidth(this.rightItems,e)},e.prototype.getRealWidth=function(e,t){var n=Euterpe.getMargins(this,e);return this.realWidth*e+(t?0:n)},e.prototype.getRealHeight=function(e,t){return typeof this.realHeight=="undefined"?t?[0,0]:0:t?[this.realHeight[0]*e,this.realHeight[1]*e]:this.realHeight[0]*e+this.realHeight[1]*e},e.prototype.clone=function(){var e=new this.constructor(this.config);return e.parentContainer=this.parentContainer,e},e.prototype.reduceWidth=function(e,t){return _.reduce(e,function(e,n){return e+n.getRealWidth(t)},0)},e}();Euterpe.Note=function(){function e(t){this.type=Euterpe.getConfig(t,"type","quarter"),this.beamDir=Euterpe.getConfig(t,"beamDirection",undefined),this.flags=Euterpe.getConfig(t,"flags",0),this.dots=Euterpe.getConfig(t,"dots",0),this.beam=undefined,e.super.call(this,"Euterpe.Note",t),this.headHeight=13.3,this.realHeight=[this.headHeight/2,this.headHeight/2],this.type==="whole"?this.realWidth=this.headWidth=21.2:this.realWidth=this.headWidth=13.6,this.dotWidth=4.5,this.dotMargin=2.5,this.calculateSize()}return Euterpe.extend(Euterpe.Node,e,{beamRealHeight:35,calculateSize:function(){this.beamDir==="up"?this.realHeight=[this.beamRealHeight,this.headHeight/2]:this.beamDir==="down"&&(this.realHeight=[this.headHeight/2,this.beamRealHeight]),this.realWidth+=(this.dotMargin+this.dotWidth)*this.dots,this.flags>0&&(this.realWidth+=13.3)},render:function(e,t,n){this.beamWidth=1.3*n,this.beamHeight=this.beamRealHeight*n,this.scale=n,this.startX=e+this.headWidth*n/2,this.startY=t;var r=[];switch(this.type){case"whole":r=this.initWhole();break;default:r=this.initHalfQuarter()}if(this.dots>0){var i=0,s=this.location;s%1===0&&(i=3*n);var o=e+this.headWidth*n;for(var u=this.dots;u>0;u--)o+=this.dotMargin*n+this.dotWidth*n/2,r.push(new Kinetic.Ellipse({x:o,y:this.Y-i,radius:{x:2*this.scale,y:2*this.scale},fill:"black"})),o+=this.dotWidth*n/2}return Euterpe.bind(this,r),r},initWhole:function(){var e=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:10.5*this.scale,y:6.5*this.scale},fill:"black"}),t=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:5.5*this.scale,y:4*this.scale},fill:"white"});return t.rotation(45),[e,t]},initHalfQuarter:function(){var e=[],t=this,n=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:7.6*this.scale,y:5.6*this.scale},fill:"black"});n.rotation(140),e.push(n);if(this.type==="half"){var r=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:6.6*this.scale,y:2.5*this.scale},fill:"white"});r.rotation(140),e.push(r)}var i,s;if(typeof this.beamDir=="string"){this.beamDir==="up"?(i=n.x()+n.width()/2-this.beamWidth-this.beamWidth/3,s=n.y(),this.beam=new Kinetic.Line({points:[0,0,0,-this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:i,y:s}),e.push(this.beam)):this.beamDir==="down"&&(i=n.x()-n.width()/2+this.beamWidth+this.beamWidth/3,s=n.y(),this.beam=new Kinetic.Line({points:[0,0,0,this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:i,y:s}),e.push(this.beam));if(this.flags==1){var o=this.beam.x(),u=this.beam.y()-this.beamHeight,a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,u),e.bezierCurveTo(o+6.2*t.scale,u+11.8*t.scale,o+21.4*t.scale,u+10.4*t.scale,o+10*t.scale,u+26.4*t.scale),e.bezierCurveTo(o+19.6*t.scale,u+12.4*t.scale,o+5.4*t.scale,u+10.4*t.scale,o-.2*t.scale,u+7.4*t.scale),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:1});e.push(a)}}return Euterpe.bind(this,e),e}}),e}();Euterpe.PluginAboveBelow=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAboveBelow",t)};return Euterpe.extend(Euterpe.Plugin,e,{roundLine:function(e){var t,n;return e<0?(t=e-Math.ceil(e),t===0?n=e:t>=-0.5?n=Math.ceil(e)-.5:n=Math.floor(e),n):(t=e-Math.floor(e),t===0?n=e:t<=.5?n=Math.floor(e)+.5:n=Math.ceil(e),n)},place:function(e,t,n,r){var i=0,s,o,u,a;typeof r=="number"?s=r:n==="above"?s=0:n==="below"&&(s=4);for(var f=0;f<e.length;f++){var l=e[f];o=l.getRealHeight(t,!0),u=o[0]/this.lineH,a=o[1]/this.lineH,n==="above"?(i=s-this.roundLine(a),s=i-this.roundLine(u)):n==="below"&&(i=s+this.roundLine(a),s=i+this.roundLine(u)),l.config.location=i}},process:function(e,t){this.lineH=Euterpe.global.linePadding+Euterpe.global.lineWidth;var n=Euterpe.select("Euterpe.Column",e);for(var r=0;r<n.length;r++){var i=n[r],s=i.config,o=i.getRealHeight(t,!0),u=this.roundLine(o[0]/this.lineH*-1),a=this.roundLine(o[1]/this.lineH);a<4&&(a=4),_.isArray(s.aboveItems)&&this.place(s.aboveItems,t,"above",u),_.isArray(s.belowItems)&&this.place(s.belowItems,t,"below",a)}return e}}),e}();Euterpe.PluginAccidentals=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAccidentals",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){var t=Euterpe.select("Euterpe.Note",e);for(var n=0;n<t.length;n++){var r=t[n];if(typeof r.config.sharp=="undefined"&&typeof r.config.flat=="undefined")continue;var i=r.config.sharp||r.config.flat;for(var s=0;s<i;s++)typeof r.config.sharp!="undefined"?r.leftItems.push(new Euterpe.Sharp({})):typeof r.config.flat!="undefined"&&r.leftItems.push(new Euterpe.Flat({}))}return e}}),e}();Euterpe.PluginAlign=function(){var e=function(t){this.totalWidth=Euterpe.getConfig(t,"totalWidth"),this.nodeMargin=Euterpe.getConfig(t,"nodeMargin",5),this.sideMargin=Euterpe.getConfig(t,"sideMargin",3),e.super.call(this,"Euterpe.PluginAlign",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t){var n,r;for(n=0;n<e.items.length;n++){r=e.items[n];var i,s=this.collectNodes(r);for(i=0;i<s.length;i++)s[i].leftMargin=this.nodeMargin;this.alignSideItems(r)}var o=Euterpe.getGroups(e.items);for(n=0;n<o.length;n++)this.processGroup(o[n],t);return e},alignSideItems:function(e){var t=Euterpe.select("Euterpe.Column",e);for(var n=0;n<t.length;n++){var r=t[n];for(var i=0;i<r.items.length;i++){var s=r.items[i],o;for(o=0;o<s.leftItems.length;o++)s.leftItems[o].rightMargin=this.sideMargin;for(o=0;o<s.rightItems.length;o++)s.rightItems[o].leftMargin=this.sideMargin}}},getColsBars:function(e){var t=[];for(var n=1;n<e.items.length;n++){var r=e.items[n];(r.name==="Euterpe.Column"||r.name==="Euterpe.Bar")&&t.push(r)}return t},stretchAlign:function(e,t){var n=e.getRealWidth(t),r=this.getColsBars(e),i=this.totalWidth-n,s=i/r.length/t;for(var o=0;o<r.length;o++)r[o].leftMargin+=s},getCols:function(e,t){return _.map(e,function(e){return e[t]})},cleanGroup:function(e){var t=[];for(var n=0;n<e.items.length;n++)t[n]=this.getColsBars(e.items[n]);return t},processGroup:function(e,t){var n=this.cleanGroup(e),r,i,s,o,u=_.max(_.map(n,function(e){return e.length}));for(r=0;r<u;r++){o=this.getCols(n,r);var a={},f={},l={};for(i=0;i<o.length;i++){s=o[i];if(typeof s=="undefined")continue;a[s.id]=Euterpe.getDistance(s.parent,s,t)+s.leftMargin*t+s.getLeftWidth(t),f[s.id]=s.getRealWidth(t,!0),l[s.id]=s.getRightWidth(t)}var c=_.max(_.values(a)),h=_.max(_.values(f)),p=_.max(_.values(l));for(i=0;i<o.length;i++){s=o[i];if(typeof s=="undefined")continue;var d=a[s.id],v=f[s.id],m=l[s.id];d<c&&(s.leftMargin+=(c-d)/t),v<h&&(s.rightMargin+=(h-v)/t),m<p&&(s.rightMargin+=(p-m)/t)}}var g=this;_.each(e.items,function(e){g.stretchAlign(e,t)})},collectNodes:function(e){return _.filter(e.items,function(e){return e.name!=="Euterpe.Bar"&&e.name!=="Euterpe.Column"})}}),e}();Euterpe.Plugin=function(){var e=function(e,t){this.name=e,this.config=t||{}};return e.prototype.isPlugin=!0,e.prototype.process=function(e){return e},e}();Euterpe.PluginNoteBar=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteBar",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t,n){var r=Euterpe.select("Euterpe.Column",e),i=[],s=[],o=1,u={};for(var a=0;a<r.length;a++){var f=r[a];for(var l=0;l<f.items.length;l++){var c=f.items[l],h=c.config||{};if(h.bar==="begin"||h.bar==="cont"||h.bar==="end")o=h.beamDirection==="down"?-1:1,u[i.length]=o,c.flags=0,s.push(c.id),h.bar==="end"&&(this.adjustBeamHeight(s,o),i.push(_.clone(s)),s.length=0)}}for(var p=0;p<i.length;p++)n.push(this.bind(i[p],u[p]));return e},getTopTwo:function(e,t){var n=_.clone(e);return n.sort(function(e,n){return t===1?e.config.location-n.config.location:n.config.location-e.config.location}),n.length>2?[n[0],n[1]]:n},adjustBeamHeight:function(e,t){e=_.map(e,function(e){return Euterpe.select("#"+e)[0]});if(e.length>2){var n=this.getTopTwo(e,t),r=function(e,n){return Euterpe.getY(e,scale,n)-e.beamRealHeight*scale*t},i=n[0],s=n[1],o=i.parent.parent,u=Euterpe.getDistance(o,i,scale),a=Euterpe.getDistance(o,s,scale);for(var f=0;f<e.length;f++){var l=Math.abs(Euterpe.getY(e[f],scale,0)),c=r(i,l),h=r(s,l),p=(h-c)/(a-u),d=Euterpe.getDistance(o,e[f],scale),v=r(e[f],l),m=p*(d-u)+c,g=v-m;g!==0&&(e[f].beamRealHeight+=g*t/scale,e[f].calculateSize())}}},bind:function(e,t){return function(n,r){var i=Euterpe.select("#"+e[0])[0],s=Euterpe.select("#"+e[e.length-1])[0],o=i.beam.x(),u=i.beam.y()-i.beamHeight*t,a=s.beam.x(),f=s.beam.y()-s.beamHeight*t,l=4*r,c=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(o,u),e.lineTo(a,f),e.lineTo(a,f+l*t),e.lineTo(o,u+l*t),e.moveTo(o,u),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0});return c}}}),e}();Euterpe.PluginNoteText=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteText",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){var t=Euterpe.select("Euterpe.Note",e);for(var n=0;n<t.length;n++){var r=t[n];if(typeof r.config.text=="undefined")continue;var i=new Euterpe.Text({text:r.config.text});r.leftItems.push(i)}return e}}),e}();Euterpe.PluginTab=function(){var e=function(t){e.super.call(this,"Euterpe.PluginTab",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){for(var t=0;t<e.items.length;t++){var n=e.items[t],r=new Euterpe.Row({type:"tab"});for(var i=0;i<n.items.length;i++){var s=n.items[i];if(s.name=="Euterpe.Bar"){r.add(s.clone());continue}var o=new Euterpe.Column({}),u=Euterpe.select("Euterpe.Note",s);for(var a=0;a<u.length;a++){var f=u[a];typeof f.config.tab_location=="number"&&typeof f.config.tab_text=="string"&&(n.group=t.toString(),n.groupType="bracket",r.group=n.group,r.groupType=n.groupType,o.add(new Euterpe.Text({text:f.config.tab_text,location:f.config.tab_location})))}r!==null&&o.items.length>0&&r.add(o)}typeof r.group!="undefined"&&e.items.splice(t+1,0,r)}return e}}),e}();Euterpe.Rest=function(){function e(t){this.type=Euterpe.getConfig(t,"type","long"),e.super.call(this,"Euterpe.Rest",t),this.basicWidth=7;switch(this.type){case"long":this.realWidth=this.basicWidth,this.realHeight=[0,28];break;case"double_whole":this.realWidth=this.basicWidth,this.realHeight=[0,14.5];break;case"whole":this.realWidth=20,this.realHeight=[0,8];break;case"half":this.realWidth=20,this.realHeight=[6,0];break;case"quarter":this.realWidth=20,this.realHeight=[16.75,22.25];break;case"eighth":this.realWidth=20,this.realHeight=[9.5,16.25];break;case"sixteenth":this.realWidth=20,this.realHeight=[9.5,30.25];break;case"thirty-second":this.realWidth=25,this.realHeight=[9.5,43.25];break;case"sixty-fourth":this.realWidth=30,this.realHeight=[9.5,55.75]}}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=e+this.getRealWidth(n)/2,i=[];switch(this.type){case"half":i.push(this.initHalf(r,t,n));break;case"quarter":i.push(this.initQuarter(r,t,n));break;case"eighth":i.push(this.initEighth(r,t,n));break;case"sixteenth":i.push(this.initSixteen(r,t,n));break;case"thirty-second":i.push(this.initThirtySecond(r,t,n));break;case"sixty-fourth":i.push(this.initSixtyFourth(r,t,n));break;default:i.push(this.simpleRestShape(r,t,n))}return Euterpe.bind(this,i),i},initHalf:function(e,t,n){var r=this.getRealHeight(n,!0);return this.simpleRestShape(e,t-r[0],n)},initQuarter:function(e,t,n){var r=n*.125,i=this.getRealHeight(n,!0),s=t-i[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(r,r),t.beginPath(),t.moveTo(100.2,80.7),t.bezierCurveTo(100.2,100.2,61.1,129.6,61.1,168.7),t.bezierCurveTo(61.1,183.4,90.4,227.5,110,251.9),t.bezierCurveTo(100.2,247,90.4,242.1,75.8,242.1),t.bezierCurveTo(46.4,242.1,36.6,266.6,36.6,281.3),t.bezierCurveTo(36.6,291.1,46.4,300.9,51.3,310.7),t.bezierCurveTo(21.9,291.1,2.4,271.5,2.4,251.9),t.bezierCurveTo(2.4,203,35.8,220.1,60.2,210.3),t.bezierCurveTo(35.8,185.9,12.1,149.2,12.1,134.5),t.bezierCurveTo(12.1,124.7,41.5,90.4,51.3,66),t.lineTo(51.3,51.3),t.bezierCurveTo(51.3,36.6,41.5,17,36.6,2.4),t.bezierCurveTo(56.2,26.8,100.2,70.9,100.2,80.7),t.lineTo(100.2,80.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initEighth:function(e,t,n){var r=n*.125,i=this.getRealHeight(n,!0),s=t-i[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(r,r),t.beginPath(),t.moveTo(92.9,5.2),t.bezierCurveTo(90.4,14.4,88.4,21.5,88.1,21.9),t.bezierCurveTo(84.9,28.7,78.5,37.2,73.6,42.1),t.bezierCurveTo(68.4,47.3,65.5,48.2,61.1,46.5),t.bezierCurveTo(57.4,44.5,56.2,42.4,53.8,31.5),t.bezierCurveTo(51.7,23.4,50.2,19,46.9,15.8),t.bezierCurveTo(38.4,6.5,23.8,5.3,12.6,12.6),t.bezierCurveTo(7.3,16.2,3.3,21.9,.9,28),t.bezierCurveTo(0,31.1,0,32,0,36.4),t.bezierCurveTo(0,40.9,0,42.4,.9,44.9),t.bezierCurveTo(3.6,53.8,9.3,60.7,18.2,64.7),t.bezierCurveTo(24.7,68,27.1,68.4,36,68.4),t.bezierCurveTo(42.5,68.4,44.5,68.4,49.8,67.5),t.bezierCurveTo(57.1,66.3,64.7,63.9,73.2,61.5),t.lineTo(78.5,59.4),t.lineTo(78.5,60.7),t.bezierCurveTo(78,62.3,44.1,190,43.7,190.8),t.bezierCurveTo(43.3,192.4,50.6,195.6,55,195.6),t.bezierCurveTo(59.4,195.6,65.9,192.8,66.3,190.8),t.bezierCurveTo(66.7,190.4,86.1,106.8,110.3,5.1),t.bezierCurveTo(107.1,-2.6,98.1,-0.8,92.9,5.2),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixteen:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.moveTo(132.4,0),t.bezierCurveTo(126.7,0,121.8,4.5,120.8,9.5),t.bezierCurveTo(118,21.7,117.1,25.3,116.8,26.1),t.bezierCurveTo(114.2,31.6,107.4,42.3,102.3,47.8),t.bezierCurveTo(96.7,52.9,94.2,53.8,89.5,52.1),t.bezierCurveTo(85.7,50,84.4,47.8,81.9,36.3),t.bezierCurveTo(79.7,27.8,78,23.1,74.6,19.8),t.bezierCurveTo(65.6,9.9,50.3,8.6,38.3,16.3),t.bezierCurveTo(32.8,20.2,28.6,26.1,26,32.6),t.bezierCurveTo(25.1,35.9,25.1,36.8,25.1,41.5),t.bezierCurveTo(25.1,47.8,25.6,51.3,28.6,56.3),t.bezierCurveTo(32.8,64.9,41.8,71.7,52,74.2),t.bezierCurveTo(63.1,77.2,81.4,74.7,102.3,67.9),t.bezierCurveTo(105.2,66.6,108.2,65.7,108.2,65.7),t.bezierCurveTo(108.2,66.2,104.8,80.2,101,97.7),t.bezierCurveTo(94.6,127.5,94.2,129.7,92,133.4),t.bezierCurveTo(88.6,140.7,81,151,75.8,155.6),t.bezierCurveTo(71.6,159.5,68.7,160.3,64.4,158.6),t.bezierCurveTo(60.6,156.5,59.2,154.3,56.7,142.9),t.bezierCurveTo(54.5,134.3,52.9,129.7,49.4,126.2),t.bezierCurveTo(40.5,116.4,25.1,115.2,13.2,122.8),t.bezierCurveTo(7.7,126.7,3.4,132.6,.9,139),t.bezierCurveTo(0,142.5,0,143.3,0,148),t.bezierCurveTo(0,154.3,.4,157.7,3.4,162.8),t.bezierCurveTo(7.7,171.4,16.6,178.2,26.9,180.8),t.bezierCurveTo(37.9,183.7,59.2,180.8,80.1,173.5),t.bezierCurveTo(82.7,172.7,84.4,172.3,84.4,172.3),t.bezierCurveTo(84.4,172.7,54.5,306.4,53.3,310.7),t.bezierCurveTo(53.3,311.6,53.7,312,55.4,312.8),t.bezierCurveTo(58,314.5,62.2,315.9,65.2,315.9),t.bezierCurveTo(68.2,315.9,72.4,314.5,75,312.8),t.bezierCurveTo(76.7,312,77.2,311.6,77.6,309.4),t.bezierCurveTo(77.6,308.2,100.1,196.1,127.9,60.2),t.bezierCurveTo(131.9,40.2,133.1,33.9,136.5,17),t.bezierCurveTo(137.7,11.1,139.7,0,132.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initThirtySecond:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.moveTo(154.4,0),t.bezierCurveTo(152.8,0,146,0,144.3,7.4),t.bezierCurveTo(141.2,20.7,140.5,22.5,138.9,25.3),t.bezierCurveTo(134.2,35.1,127.5,44.5,122.7,47.5),t.bezierCurveTo(120.2,49.2,118,49.2,115.1,47.9),t.bezierCurveTo(111.2,45.8,109.9,43.6,107.4,32.1),t.bezierCurveTo(105.2,23.6,103.6,18.9,100.1,15.5),t.bezierCurveTo(91.2,5.7,75.8,4.5,63.9,12.1),t.bezierCurveTo(58.4,15.9,54.1,21.9,51.6,28.3),t.bezierCurveTo(50.7,31.7,50.7,32.5,50.7,37.2),t.bezierCurveTo(50.7,43.6,51.1,47.1,54.1,52.2),t.bezierCurveTo(58.4,60.7,67.3,67.5,77.6,70),t.bezierCurveTo(82.3,71.4,94.2,71.4,102.3,70),t.bezierCurveTo(109.1,68.8,117.2,66.6,125.3,64.1),t.bezierCurveTo(129.1,62.8,131.7,61.9,132.1,61.9),t.bezierCurveTo(132.1,62.3,117.6,126.3,116.8,128.4),t.bezierCurveTo(114.2,133.9,107.4,144.6,102.3,150.1),t.bezierCurveTo(96.7,155.2,94.2,156.1,89.5,154.4),t.bezierCurveTo(85.7,152.3,84.4,150.1,81.9,138.6),t.bezierCurveTo(79.7,130.1,78,125.4,74.6,122.1),t.bezierCurveTo(65.6,112.2,50.3,111,38.3,118.6),t.bezierCurveTo(32.8,122.5,28.6,128.4,26,134.9),t.bezierCurveTo(25.1,138.2,25.1,139.1,25.1,143.8),t.bezierCurveTo(25.1,150.1,25.6,153.6,28.6,158.7),t.bezierCurveTo(32.8,167.2,41.8,174,52,176.5),t.bezierCurveTo(63.1,179.5,81.4,177,102.3,170.2),t.bezierCurveTo(105.2,168.9,108.2,168,108.2,168),t.bezierCurveTo(108.2,168.5,104.8,182.5,101,200),t.bezierCurveTo(94.6,229.8,94.2,232,92,235.7),t.bezierCurveTo(88.6,243,81,253.3,75.8,258),t.bezierCurveTo(71.6,261.8,68.7,262.6,64.4,260.9),t.bezierCurveTo(60.6,258.8,59.2,256.6,56.7,245.2),t.bezierCurveTo(54.5,236.7,52.9,232,49.4,228.5),t.bezierCurveTo(40.5,218.7,25.1,217.5,13.2,225.1),t.bezierCurveTo(7.7,229,3.4,234.9,.9,241.3),t.bezierCurveTo(0,244.8,0,245.6,0,250.3),t.bezierCurveTo(0,256.6,.4,260,3.4,265.1),t.bezierCurveTo(7.7,273.7,16.6,280.5,26.9,283.1),t.bezierCurveTo(37.9,286,59.2,283.1,80.1,275.8),t.bezierCurveTo(82.7,275,84.4,274.6,84.4,274.6),t.bezierCurveTo(84.4,275,54.5,408.7,53.3,413),t.bezierCurveTo(53.3,413.9,53.7,414.3,55.4,415.2),t.bezierCurveTo(58,416.8,62.2,418.2,65.2,418.2),t.bezierCurveTo(68.2,418.2,72.4,416.8,75,415.2),t.bezierCurveTo(76.7,414.3,77.2,413.9,77.6,411.7),t.bezierCurveTo(77.6,410.5,100.1,298.4,127.9,162.5),t.bezierCurveTo(141.5,94.4,151.4,44.8,158.6,8.7),t.bezierCurveTo(159.5,4.3,157.9,-0.1,154.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixtyFourth:function(e,t,n){var r=this.getRealHeight(n,!0),i=n*.125,s=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,s),t.scale(i,i),t.beginPath(),t.bezierCurveTo(89,2.9,80.5,10.6,76.7,21.2),t.bezierCurveTo(75.8,24.6,75.8,25.4,75.8,30.1),t.bezierCurveTo(75.8,34.8,75.8,36.5,76.7,39.1),t.bezierCurveTo(79.7,48.5,85.7,55.7,95,59.9),t.bezierCurveTo(101.8,63.4,104.4,63.8,113.8,63.8),t.bezierCurveTo(120.2,63.8,122.7,63.8,127.9,63),t.bezierCurveTo(134.6,61.7,144,59.1,151.3,56.6),t.lineTo(155.9,54.8),t.lineTo(155.5,56.6),t.bezierCurveTo(155.1,57.4,152.1,72.3,148.2,89.3),t.bezierCurveTo(141.5,119.2,141.1,120.9,138.9,124.7),t.bezierCurveTo(134.2,134.5,127.5,143.9,122.7,146.9),t.bezierCurveTo(120.2,148.6,118,148.6,115.1,147.3),t.bezierCurveTo(111.2,145.2,109.9,143,107.4,131.5),t.bezierCurveTo(105.2,123,103.6,118.3,100.1,114.9),t.bezierCurveTo(91.2,105.1,75.8,103.9,63.9,111.5),t.bezierCurveTo(58.4,115.3,54.1,121.3,51.6,127.7),t.bezierCurveTo(50.7,131.1,50.7,131.9,50.7,136.6),t.bezierCurveTo(50.7,143,51.1,146.5,54.1,151.6),t.bezierCurveTo(58.4,160.1,67.3,166.9,77.6,169.4),t.bezierCurveTo(82.3,170.8,94.2,170.8,102.3,169.4),t.bezierCurveTo(109.1,168.2,117.2,166,125.3,163.5),t.bezierCurveTo(129.1,162.3,131.7,161.3,132.1,161.3),t.bezierCurveTo(132.1,161.8,117.6,225.7,116.8,227.8),t.bezierCurveTo(114.2,233.3,107.4,244,102.3,249.5),t.bezierCurveTo(96.7,254.6,94.2,255.6,89.5,253.8),t.bezierCurveTo(85.7,251.7,84.4,249.5,81.9,238),t.bezierCurveTo(79.7,229.5,78,224.8,74.6,221.5),t.bezierCurveTo(65.6,211.6,50.3,210.4,38.3,218),t.bezierCurveTo(32.8,221.9,28.6,227.8,26,234.3),t.bezierCurveTo(25.1,237.6,25.1,238.5,25.1,243.2),t.bezierCurveTo(25.1,249.5,25.6,253,28.6,258.1),t.bezierCurveTo(32.8,266.6,41.8,273.4,52,275.9),t.bezierCurveTo(63.1,278.9,81.4,276.4,102.3,269.6),t.bezierCurveTo(105.2,268.3,108.2,267.4,108.2,267.4),t.bezierCurveTo(108.2,267.9,104.8,281.9,101,299.4),t.bezierCurveTo(94.6,329.2,94.2,331.4,92,335.1),t.bezierCurveTo(88.6,342.4,81,352.7,75.8,357.4),t.bezierCurveTo(71.6,361.2,68.7,362,64.4,360.3),t.bezierCurveTo(60.6,358.2,59.2,356,56.7,344.6),t.bezierCurveTo(54.5,336.1,52.9,331.4,49.4,328),t.bezierCurveTo(40.5,318.1,25.1,316.9,13.2,324.5),t.bezierCurveTo(7.7,328.4,3.4,334.3,.9,340.7),t.bezierCurveTo(0,344.2,0,345,0,349.7),t.bezierCurveTo(0,356,.4,359.4,3.4,364.5),t.bezierCurveTo(7.7,373.1,16.6,379.9,26.9,382.5),t.bezierCurveTo(37.9,385.4,59.2,382.5,80.1,375.2),t.bezierCurveTo(82.7,374.4,84.4,374,84.4,374),t.bezierCurveTo(84.4,374.4,54.5,508.1,53.3,512.4),t.bezierCurveTo(53.3,513.3,53.7,513.7,55.4,514.6),t.bezierCurveTo(58,516.2,62.2,517.6,65.2,517.6),t.bezierCurveTo(68.2,517.6,72.4,516.2,75,514.6),t.bezierCurveTo(76.7,513.7,77.2,513.3,77.6,511.1),t.bezierCurveTo(77.6,509.9,100.1,397.8,127.9,261.9),t.bezierCurveTo(171.7,42.9,177.2,14.8,176.8,13.9),t.bezierCurveTo(175.6,11.8,173.9,11,171.3,11),t.bezierCurveTo(167.5,11,166.6,11.8,162.8,19.1),t.bezierCurveTo(157.3,29.7,151.7,37.4,147.8,40.4),t.bezierCurveTo(145.7,42.1,143.6,42.1,140.2,40.8),t.bezierCurveTo(136.4,38.6,135.1,36.5,132.5,25),t.bezierCurveTo(130,13.5,126.9,8.4,120.6,4.1),t.bezierCurveTo(114.6,.3,107,-0.9,100.1,.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},simpleRestShape:function(e,t,n){return new Kinetic.Rect({x:e,y:t,width:this.getRealWidth(n),height:this.getRealHeight(n),fill:"black",strokeWidth:0})}}),e}();Euterpe.Row=function(){function e(t){e.super.call(this,"Euterpe.Row",t),this.type=Euterpe.getConfig(t,"type"),this.group=Euterpe.getConfig(t,"group",undefined),this.groupType=Euterpe.getConfig(t,"groupType",undefined),this.type==="measure"?(this.numberOfLines=5,this.realHeight=[0,57.3]):this.type==="tab"&&(this.numberOfLines=6,this.realHeight=[0,71.5]),this.prepared=[]}return Euterpe.extend(Euterpe.Container,e,{render:function(e,t,n){var r=[],i=0,s=e;for(var o=0;o<this.items.length;o++){var u=this.items[o];u.X=e+u.leftMargin*n,u.Y=t,r.push(u.render(u.X,u.Y,n));var a=u.getRealWidth(n);i+=a,e+=a}r.push(this.renderSelf(s,t,n,i));if(this.type==="measure"){var f=[];this.prepareLedgerLines(f,Euterpe.select("Euterpe.Note",this),t,n),r.push(this.renderLedgerLines(f,n))}return r},prepareLedgerLines:function(e,t,n,r){for(var i=0;i<t.length;i++){var s=t[i];if(typeof s.config.location=="number"){var o=s.headWidth*r,u;s.config.location>this.numberOfLines-1?(u=Math.floor(s.config.location),this.addLedgerLine(s,u,s.X,o,n,e,r)):s.config.location<0&&(u=Math.ceil(s.config.location),this.addLedgerLine(s,u,s.X,o,n,e,r))}}},addLedgerLine:function(e,t,n,r,i,s,o){var u;for(;;){if(t>0&&t<=4||t===0)break;u=!1;var a=Euterpe.getY(t,o,i);if(e.name==="Euterpe.Note"){for(var f=0;f<s.length;f++){var l=s[f];if(l[0]===n&&l[1]===a){u=!0;break}}u||s.push([n,a,r])}t+=t>0?-1:1}},renderLedgerLines:function(e,t){var n=[];for(var r=0;r<e.length;r++){var i=e[r][0],s=e[r][1],o=5*t,u=e[r][2]+o*2;n.push(new Kinetic.Line({points:[0,0,u,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:i-o,y:s}))}return n},renderSelf:function(e,t,n,r){var i=new Kinetic.Line({points:[0,0,r,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:e,y:t}),s=new Kinetic.Group({});s.add(i);for(var o=2;o<this.numberOfLines+1;o++){var u=Euterpe.getY(o-1,n,t),a=i.clone({y:u});s.add(a)}return s}}),e}();Euterpe.Score=function(){function e(t){this.layer=t.layer,this.lineMargin=Euterpe.getConfig(t,"lineMargin",0),this.titleMargin=Euterpe.getConfig(t,"titleMargin",0),this.musicByMargin=Euterpe.getConfig(t,"musicByMargin",0),this.tuningMargin=Euterpe.getConfig(t,"tuningMargin",0),this.title=Euterpe.getConfig(t,"title",undefined),this.musicBy=Euterpe.getConfig(t,"musicBy",undefined),this.tuning=Euterpe.getConfig(t,"tuning",undefined),this.titleHeight=0,this.musicByHeight=0,this.tuningHeight=0,typeof this.title!="undefined"&&(this.titleText=new Euterpe.Text({text:this.title,fontSize:40,fontFamily:"Serif"}),this.titleWidth=this.titleText.getRealWidth(1),this.titleHeight=this.titleText.getRealHeight(1)),typeof this.musicBy!="undefined"&&(this.musicByText=new Euterpe.Text({fontSize:20,text:"Music by "+this.musicBy,fontFamily:"Serif"}),this.musicByHeight=this.musicByText.getRealHeight(1)),typeof this.tuning!="undefined"&&(this.tuningText=new Euterpe.Text({fontSize:15,text:this.tuning,fontFamily:"Serif",fontStyle:"italic"}),this.tuningHeight=this.tuningText.getRealHeight(1)),e.super.call(this,"Euterpe.Score",t)}return Euterpe.extend(Euterpe.Container,e,{bracketExtraUp:5,bracketExtraDown:5,getRealHeight:function(e,t){var n=this.doGetRealHeight(this.items,e,t),r=0;return r+=this.titleHeight*e,r+=this.titleMargin*e,r+=this.musicByHeight*e,r+=this.musicByMargin*e,r+=this.tuningHeight*e,r+=this.tuningMargin*e,t?n[0]+=r:n+=r,n},render:function(e,t,n){var r=0,i=[],s,o=Euterpe.getGroups(this.items),u=0;for(s=0;s<o.length;s++){var a=o[s];a.groupType==="bracket"&&6>u&&(u=6)}e+=u*n;var f=0;t=this.renderMeta(e,t,n,i);for(s=0;s<this.items.length;s++){var l=this.items[s],c=this.doGetRealHeight([l],n,!0);r!==0&&(r+=c[0]);var h=t+r;l.Y=h,l.X=e,f<o.length&&o[f].first===l.id&&(i.push(this.renderBracket(e-u*n,h,n,o[f].items)),f++),r+=c[1],i.push(l.render(e,h,n))}return i},renderMeta:function(e,t,n,r){var i=this.getRealHeight(n,!0);t-=i[0];var s=(this.titleHeight+this.musicByHeight+this.tuningHeight+this.titleMargin+this.musicByMargin+this.tuningMargin)*n;return typeof this.title!="undefined"&&(t+=this.titleHeight*n/2,r.push(this.renderText(this.titleText,this.titleWidth,e,t,n,!0)),t+=this.titleHeight*n/2,t+=this.titleMargin*n),typeof this.musicBy!="undefined"&&(t+=this.musicByHeight*n/2,r.push(this.renderText(this.musicByText,0,e,t,n)),t+=this.musicByHeight*n/2,t+=this.musicByMargin*n),typeof this.tuning!="undefined"&&(t+=this.tuningHeight*n/2,r.push(this.renderText(this.tuningText,0,e,t,n)),t+=this.tuningHeight*n/2,t+=this.tuningMargin*n),t+=i[0]-s,t},renderText:function(e,t,n,r,i,s){var o=n;if(s){var u=this.items[0].getRealWidth(i);o=n+(u/2-t/2)}return e.render(o,r,i)},doGetRealHeight:function(e,t,n){var r,i=0,s=Euterpe.getGroups(this.items),o=function(e){return _.find(s,function(t){return t.first===e.id})},u=function(e){return _.find(s,function(t){return t.last===e.id})};for(var a=0;a<e.length;a++){var f=e[a],l=f.getRealHeight(t,!0);o(f)&&(l[0]+=this.bracketExtraUp*t),u(f)&&(l[1]+=this.bracketExtraDown*t);var c=l[1]+l[0];typeof r=="undefined"&&(r=l[0]+i),i+=c+this.lineMargin*t}return n?[r,i-r]:i},renderBracket:function(e,t,n,r){var i=this.bracketExtraUp*n,s=this.bracketExtraDown*n,o=this.doGetRealHeight(r,n,!0),u=o[0]-i,a=o[1]-s-this.lineMargin*n;return new Kinetic.Shape({sceneFunc:function(r){r.beginPath();var o=10*n;r.moveTo(e+o,t-u-i),r.lineTo(e,t-u),r.lineTo(e,t+a),r.lineTo(e+o,t+a+s),r.lineTo(e+o/5,t+a),r.lineTo(e+o/5,t-u),r.lineTo(e+o,t-u-i),r.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})}}),e}();Euterpe.Sharp=function(){function e(t){e.super.call(this,"Euterpe.Sharp",t),this.realWidth=9,this.realHeight=[11,11]}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=this.realHeight[0]+this.realHeight[1];this.startY=t-r*n/2-n;var i=this.realWidth*n,s=r*n,o=1.5*n,u=new Kinetic.Rect({x:this.X+i/3.6-o/2,y:this.startY+2*n,width:o,height:s,fill:"black",strokeWidth:0}),a=u.clone({x:this.X+i-i/3.6-o/2,y:this.startY}),f=4.5*n,l=this.startY+s/4+3*n;o=3*n;var c=new Kinetic.Line({points:[this.X,l,this.X,l+o,this.X+i,l+o-f,this.X+i,l-f],fill:"black",strokeWidth:0,closed:!0});l=this.startY+s-s/4;var h=c.clone({points:[this.X,l,this.X,l+o,this.X+i,l+o-f,this.X+i,l-f]}),p=[u,a,c,h];return Euterpe.bind(this,p),p}}),e}();Euterpe.StringNumber=function(){function e(t){this.string=Euterpe.getConfig(t,"string"),this.fontSize=10,this.fontFamily="Arial";if(typeof this.string!="number"||this.string<0||this.string>6)throw"Invalid string value";this.string=this.string.toString(),this.textWidth=5,this.textHeight=7.6,this.realWidth=21.3,this.realHeight=[10.65,10.65],e.super.call(this,"Euterpe.StringNumber",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=[],i=e+this.realWidth*n/2;return r.push(new Kinetic.Circle({x:i,y:t,radius:10*n,fill:"white",stroke:"black",strokeWidth:n})),r.push(new Kinetic.Text({x:i-this.textWidth*n/2,y:t-this.textHeight*n/2,text:this.string,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fill:"black"})),Euterpe.bind(this,r),r}}),e}();Euterpe.Text=function(){function e(t){this.text=Euterpe.getConfig(t,"text"),this.color=Euterpe.getConfig(t,"color","black"),this.fontFamily=Euterpe.getConfig(t,"fontFamily","Arial"),this.fontSize=Euterpe.getConfig(t,"fontSize",10),this.fontStyle=Euterpe.getConfig(t,"fontStyle","normal");var n=1,r=new Kinetic.Text({x:0,y:0,text:this.text,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fontStyle:this.fontStyle}),i=r.height()/n;this.realWidth=r.width()/n,this.realHeight=[i/2,i/2],e.super.call(this,"Euterpe.Text",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=[new Kinetic.Text({x:e,y:t-(this.realHeight[0]*n+this.realHeight[1]*n)/2,text:this.text,fontSize:this.fontSize*n,fontFamily:this.fontFamily,fontStyle:this.fontStyle,fill:this.color})];return Euterpe.bind(this,r),r}}),e}();Euterpe.TimeSignature=function(){function e(t){this.numerator=Euterpe.getConfig(t,"numerator",4),this.denominator=Euterpe.getConfig(t,"denominator",4),e.super.call(this,t),this.add(new Euterpe.TimeSignatureShape(this.numerator,0)),this.add(new Euterpe.TimeSignatureShape(this.denominator,2))}return Euterpe.extend(Euterpe.Column,e,{name:"Euterpe.TimeSignature"}),e}();Euterpe.TimeSignatureShape=function(){function e(t,n){this.yoffset=2;var r={4:[0,24+this.yoffset]};this.digit=t.toString(),this.realWidth=22.4,this.realHeight=r[t],e.super.call(this,"Euterpe.TimeSignatureShape",{location:n})}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,n){var r=this;this.scale=n,this.startX=e,this.startY=t+this.yoffset*n;var i=[];return this.digit==="4"&&i.push(new Kinetic.Shape({sceneFunc:function(e){var t=r.startX+17.6*n,i=r.startY;e.beginPath(),e.moveTo(t,i),e.lineTo(t-10*r.scale,i),e.bezierCurveTo(t-8.8*r.scale,i+6.8*r.scale,t-10.54*r.scale,i+10.66*r.scale,t-17.6*r.scale,i+16*r.scale),e.lineTo(t-17.6*r.scale,i+17*r.scale),e.lineTo(t-3.6*r.scale,i+17*r.scale),e.lineTo(t-3.6*r.scale,i+22.4*r.scale),e.lineTo(t-5.6*r.scale,i+22.4*r.scale),e.lineTo(t-5.6*r.scale,i+23.4*r.scale),e.lineTo(t-5.6*r.scale,i+23.4*r.scale),e.lineTo(t+4.4*r.scale,i+23.4*r.scale),e.lineTo(t+4.4*r.scale,i+22.4*r.scale),e.lineTo(t+2.4*r.scale,i+22.4*r.scale),e.lineTo(t+2.4*r.scale,i+17*r.scale),e.lineTo(t+4.4*r.scale,i+17*r.scale),e.lineTo(t+4.4*r.scale,i+16*r.scale),e.lineTo(t+2.4*r.scale,i+16*r.scale),e.lineTo(t+2.4*r.scale,i+1.4*r.scale),e.lineTo(t-3.6*r.scale,i+7.2*r.scale),e.lineTo(t-3.6*r.scale,i+16*r.scale),e.lineTo(t-16.6*r.scale,i+16*r.scale),e.lineTo(t,i),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})),Euterpe.bind(this,i),i}}),e}();