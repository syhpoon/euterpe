/**
 * @license
 * Euterpe.js version 0.1
 *
 * @author Max E. Kuznetsov <mek@mek.uz.ua>
 * @copyright MuzMates 2014
 */
function Euterpe(){}Euterpe.const={LOG_DEBUG:1,LOG_INFO:2,LOG_WARNING:3,LOG_ERROR:4},Euterpe.global={loglevel:Euterpe.const.LOG_INFO},Euterpe.plugins={plugins:[],add:function(){var e=this;_.each(arguments,function(t){e.plugins.push(t)})},fold:function(e,t,i){return _.reduce(this.plugins,function(e,r){return r.process(e,t,i)},e)}},Euterpe.getConfig=function(e,t,i){return"undefined"==typeof e?i:"undefined"==typeof e[t]?i:e[t]},Euterpe.getY=function(e,t,i){var r;if("number"==typeof e)r=e;else{if("undefined"==typeof e.config||"undefined"==typeof e.config.location)return i;r=e.config.location}if("function"==typeof r)return r(t,i);var n,o,u,a=Euterpe.global.linePadding/2+Euterpe.global.lineWidth/2;return r>=0?(o=Math.floor(r),u=Math.ceil(r)>r?a:0,n=Euterpe.global.linePadding*o+Euterpe.global.lineWidth*o,i+n+u):0>r?(o=Math.ceil(r),u=Math.floor(r)<r?a:0,n=Euterpe.global.linePadding*-o+Euterpe.global.lineWidth*-o,i+-1*n-u):i},Euterpe.initNode=function(e,t){e.isNode=!0,e.nodeName=t},Euterpe.extend=function(e,t,i){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t,t.super=e,"object"==typeof i&&_.extend(t.prototype,i)},Euterpe.render=function(e,t,i,r,n,o){Euterpe.initLog(),Euterpe.global.root=e,Euterpe.global.background=new Kinetic.Layer({}),Euterpe.global.foreground=new Kinetic.Layer({}),Euterpe.global.linePadding=13*n,Euterpe.global.lineWidth=n;var u=[],a=Euterpe.plugins.fold(e,n,u),s=a.getRealHeight(n,!0);i+=s[0];var h=i+s[1];Euterpe.stage=new Kinetic.Stage({container:o,width:r,height:h}),Euterpe.stage.add(Euterpe.global.foreground),Euterpe.stage.add(Euterpe.global.background);for(var l=_.flatten(a.render(t+e.leftMargin*n,i,n)),c=0;c<l.length;c++)"background"===l[c].layer2draw?Euterpe.global.background.add(l[c]):Euterpe.global.foreground.add(l[c]);for(var g=0;g<u.length;g++){var p=u[g],f=p(a,n);"undefined"!=typeof f&&("background"===f.layer2draw?Euterpe.global.background.add(f):Euterpe.global.foreground.add(f))}return Euterpe.stage},Euterpe.getMargins=function(e,t){return e.leftMargin*t+e.rightMargin*t},Euterpe.randomString=function(e){return new Array(e+1).join((Math.random().toString(36)+"00000000000000000").slice(2,18)).slice(0,e)},Euterpe.select=function(e,t){var i=function(t){return"#"===e[0]?t.id===e.slice(1,e.length):t.name===e};t=t||Euterpe.global.root;var r=[];if(t.isNode&&i(t))r.push(t);else if(t.isContainer)for(var n=0;n<t.items.length;n++){var o=t.items[n];i(o)&&r.push(o),o.isContainer&&r.push(Euterpe.select(e,o))}return _.flatten(r)},Euterpe.replace=function(e,t,i){for(var r=0;r<e.items.length;r++){var n=e.items[r];if(n.id==t)return i.parentContainer=e,e.items[r]=i,!0;if(n.isContainer&&Euterpe.replace(n,t,i))break}return!1},Euterpe.initLog=function(){var e=window.console||{},t=function(){};Euterpe.log={debug:t,info:t,warn:t,error:t},Euterpe.const.LOG_DEBUG>=Euterpe.global.loglevel&&e.log&&(Euterpe.log.debug=e.debug.bind(e)),Euterpe.const.LOG_INFO>=Euterpe.global.loglevel&&e.info&&(Euterpe.log.info=e.info.bind(e)),Euterpe.const.LOG_WARNING>=Euterpe.global.loglevel&&e.warn&&(Euterpe.log.warn=e.warn.bind(e)),Euterpe.const.LOG_ERROR>=Euterpe.global.loglevel&&e.error&&(Euterpe.log.error=e.error.bind(e))},Euterpe.getDistance=function(e,t,i){for(var r=0,n=0;n<e.items.length;n++){var o=e.items[n];if(o.id===t.id)break;if(o.isContainer&&Euterpe.select("#"+t.id,o).length>0){r+=o.leftMargin*i,r+=Euterpe.getDistance(o,t,i);break}r+=o.getRealWidth(i)}return r},Euterpe.getRealHeight=function(e,t,i,r){var n,o,u,a,s,h=0;"undefined"!=typeof e.realHeight&&(s=Euterpe.getY(e,i,h),n=e.realHeight[0]*i,o=e.realHeight[1]*i);for(var l=0;l<t.length;l++){var c=t[l],g=c.getRealHeight(i,!0);s=Euterpe.getY(c,i,h),u=s-g[0],a=s+g[1],("undefined"==typeof n||n>u)&&(n=u),("undefined"==typeof o||a>o)&&(o=a)}return r?[-1*n,o]:o-n},Euterpe.baseRender=function(e,t,i,r){var n,o,u=[];for(o=0;o<e.length;o++)n=e[o],n.X=t,n.Y=Euterpe.getY(n,r,i),u.push(n.render(n.X,n.Y,r)),t+=n.getRealWidth(r);return u},Euterpe.getGroups=function(e){for(var t=[],i=null,r=null,n=null,o=[],u=null,a=0;a<e.length;a++){var s=e[a];"undefined"!=typeof s.group?(i!==s.group&&(null!==i&&t.push({first:n,last:u,groupType:r,items:_.clone(o)}),n=s.id,i=s.group,r=s.groupType,o.length=0),o.push(s)):t.push({first:void 0,last:void 0,groupType:void 0,items:[s]}),u=s.id}return o.length>0&&t.push({first:n,last:u,groupType:r,items:o}),t},Euterpe.bind=function(e,t){if("undefined"!=typeof e.config.on){t=_.isArray(t)?_.flatten(t):[t];for(var i={},r=function(r,n){return function(){n.call(r,e,t,i)}},n=_.keys(e.config.on),o=0;o<n.length;o++){var u=n[o];_.each(t,function(t){t.on(u,r(t,e.config.on[u]))})}}},Euterpe.ContainerDepth=0,Euterpe.Container=function(){var e=function(e,t){if(this.id=Euterpe.randomString(20),this.items=[],this.name=this.name||e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=[],this.rightItems=[],"undefined"!=typeof t&&_.isArray(t.items))for(var i=0;i<t.items.length;i++)this.add(t.items[i])};return e.prototype={getRealWidth:function(e,t){for(var i=t?0:Euterpe.getMargins(this,e),r=0;r<this.items.length;r++)i+=this.items[r].getRealWidth(e,t);return i},getRealHeight:function(e,t){return Euterpe.getRealHeight(this,this.items,e,t)},isContainer:!0,getLeftWidth:function(e){var t=_.map(this.items,function(t){return t.getLeftWidth(e)});return _.max(t)},getRightWidth:function(e){var t=_.map(this.items,function(t){return t.getRightWidth(e)});return _.max(t)},clear:function(){this.items.length=0},size:function(){return this.items.length},add:function(e){var t=this;return _.isArray(e)?_.each(e,function(e){t.add(e)}):(e.parent=this,void this.items.push(e))},prepend:function(e){e.parentContainer=this,this.items.unshift(e)},insertBefore:function(e,t){for(var i=0;i<this.items.length;i++){var r=this.items[i];if(r.id===e)return this.items.splice(i,0,t)}},baseRender:function(e,t,i,r,n){Euterpe.ContainerDepth+=1;var o=[],u=function(e,t,i,r,n){var o=Euterpe.getY(e,r,i);return e.Y=o,e.render(t,o,r,n)};r=r||u,n=n||u;for(var a=0;a<this.items.length;a++){var s=this.items[a],h=0;Euterpe.log.debug(new Array(Euterpe.ContainerDepth).join("  "),s),s.isContainer?(s.parentContainer=this,h=s.getRealWidth(i),s.X=e+s.leftMargin*i,s.Y=t,o.push(n(s,s.X,s.Y,i,a)),e+=h):(s.parentContainer=this,h=s.getRealWidth(i),s.X=e+s.leftMargin*i,s.Y=t,o.push(r(s,s.X,s.Y,i,a)),e+=h)}return Euterpe.ContainerDepth-=1,o},render:function(e,t,i){return Euterpe.baseRender(this.items,e,t,i)}},e}(),Euterpe.Node=function(){var e=function(e,t){this.id=Euterpe.randomString(20),this.name=e,this.config=t||{},this.leftMargin=Euterpe.getConfig(t,"leftMargin",0),this.rightMargin=Euterpe.getConfig(t,"rightMargin",0),this.leftItems=Euterpe.getConfig(t,"leftItems",[]),this.rightItems=Euterpe.getConfig(t,"rightItems",[])};return e.prototype.isNode=!0,e.prototype.getLeftWidth=function(e){return this.reduceWidth(this.leftItems,e)},e.prototype.getRightWidth=function(e){return this.reduceWidth(this.rightItems,e)},e.prototype.getRealWidth=function(e,t){var i=Euterpe.getMargins(this,e);return this.realWidth*e+(t?0:i)},e.prototype.getRealHeight=function(e,t){return"undefined"==typeof this.realHeight?t?[0,0]:0:t?[this.realHeight[0]*e,this.realHeight[1]*e]:this.realHeight[0]*e+this.realHeight[1]*e},e.prototype.clone=function(){var e=new this.constructor(this.config);return e.parentContainer=this.parentContainer,e},e.prototype.reduceWidth=function(e,t){return _.reduce(e,function(e,i){return e+i.getRealWidth(t)},0)},e}(),Euterpe.Row=function(){function e(t){e.super.call(this,"Euterpe.Row",t),this.type=Euterpe.getConfig(t,"type"),this.group=Euterpe.getConfig(t,"group",void 0),this.groupType=Euterpe.getConfig(t,"groupType",void 0),"measure"===this.type?(this.numberOfLines=5,this.realHeight=[0,57.3]):"tab"===this.type&&(this.numberOfLines=6,this.realHeight=[0,71.5]),this.prepared=[]}return Euterpe.extend(Euterpe.Container,e,{render:function(e,t,i){for(var r=[],n=0,o=e,u=0;u<this.items.length;u++){var a=this.items[u];a.X=e+a.leftMargin*i,a.Y=t,r.push(a.render(a.X,a.Y,i));var s=a.getRealWidth(i);n+=s,e+=s}if(r.push(this.renderSelf(o,t,i,n)),"measure"===this.type){var h=[];this.prepareLedgerLines(h,Euterpe.select("Euterpe.Note",this),t,i),r.push(this.renderLedgerLines(h,i))}return r},prepareLedgerLines:function(e,t,i,r){for(var n=0;n<t.length;n++){var o=t[n];if("number"==typeof o.config.location){var u,a=o.headWidth*r;o.config.location>this.numberOfLines-1?(u=Math.floor(o.config.location),this.addLedgerLine(o,u,o.X,a,i,e,r)):o.config.location<0&&(u=Math.ceil(o.config.location),this.addLedgerLine(o,u,o.X,a,i,e,r))}}},addLedgerLine:function(e,t,i,r,n,o,u){for(var a;;){if(t>0&&4>=t||0===t)break;a=!1;var s=Euterpe.getY(t,u,n);if("Euterpe.Note"===e.name){for(var h=0;h<o.length;h++){var l=o[h];if(l[0]===i&&l[1]===s){a=!0;break}}a||o.push([i,s,r])}t+=t>0?-1:1}},renderLedgerLines:function(e,t){for(var i=[],r=0;r<e.length;r++){var n=e[r][0],o=e[r][1],u=5*t,a=e[r][2]+2*u;i.push(new Kinetic.Line({points:[0,0,a,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:n-u,y:o}))}return i},renderSelf:function(e,t,i,r){var n=new Kinetic.Line({points:[0,0,r,0],stroke:"black",strokeWidth:Euterpe.global.lineWidth,x:e,y:t}),o=new Kinetic.Group({});o.add(n);for(var u=2;u<this.numberOfLines+1;u++){var a=Euterpe.getY(u-1,i,t),s=n.clone({y:a});o.add(s)}return o}}),e}(),Euterpe.Column=function(){function e(t){e.super.call(this,"Euterpe.Column",t)}return Euterpe.extend(Euterpe.Container,e,{getRealWidth:function(e,t){var i=Euterpe.getMargins(this,e),r=this.collectItems(),n=_.max(_.map(r,function(i){var r=0,n=0;return i.isNode&&(r=i.getLeftWidth(e),n=i.getRightWidth(e)),i.getRealWidth(e,t)+(t?0:r+n)}));return n+(t?0:i)},getRealHeight:function(e,t){var i=this.collectItems();return Euterpe.getRealHeight(this,i,e,t)},collectItems:function(){var e=this.items;return _.isArray(this.config.aboveItems)&&(e=this.config.aboveItems.concat(this.items)),_.isArray(this.config.belowItems)&&(e=e.concat(this.config.belowItems)),e},render:function(e,t,i){var r,n,o=[],u=0,a=this.collectItems(),s=this.renderSideItems(a,i,o,e,t,!0);for(e+=s,n=0;n<a.length;n++)r=a[n],r.X=e,r.Y=Euterpe.getY(r,i,t),o.push(r.render(r.X,r.Y,i)),s=r.getRealWidth(i),s>u&&(u=s);return this.renderSideItems(this.items,i,o,e+u,t,!1),o},renderSideItems:function(e,t,i,r,n,o){var u=[],a=0,s=0;if(o)for(h=0;h<e.length;h++)e[h].isNode?(c=e[h].getLeftWidth(t),u.push(c),c>a&&(a=c)):u.push(0);for(var h=0;h<e.length;h++){var l=e[h],c=0,g=0;"undefined"!=typeof u[h]&&u[h]!==a&&(g=a-u[h]);for(var p=o?l.leftItems:l.rightItems,f=0;f<p.length;f++){var d=p[f];"undefined"==typeof d.config.location&&(d.config.location=l.config.location),d.X=r+d.leftMargin*t+g+c,d.Y=Euterpe.getY(d,t,n),i.push(d.render(d.X,d.Y,t)),c+=d.getRealWidth(t)}c>s&&(s=c)}return s},reduceWidth:function(e,t){return _.reduce(e,function(e,i){return e+i.getRealWidth(t)},0)}}),e}(),Euterpe.Bar=function(){function e(t){this.leftType=Euterpe.getConfig(t,"leftType","none"),this.rightType=Euterpe.getConfig(t,"rightType","none"),this.number=Euterpe.getConfig(t,"number",void 0),this.numberOffset=0,this.numberHeight=[0,0],"undefined"!=typeof this.number&&(this.numberItem=new Euterpe.Text({text:this.number.toString()}),this.numberOffset=3,this.numberHeight=this.numberItem.getRealHeight(1,!0)),this.leftWidth=this.widths[this.leftType],this.rightWidth=this.widths[this.rightType],this.realWidth=this.leftWidth+this.rightWidth,e.super.call(this,"Euterpe.Bar",t)}return Euterpe.extend(Euterpe.Node,e,{widths:{none:0,single:2,"double":7,"double bold":13,repeat:24},getRealHeight:function(e,t){return"undefined"==typeof this.realHeight&&(this.realHeight=_.clone(this.parent.realHeight),this.realHeight[0]+=this.numberHeight[0]+this.numberHeight[1],this.realHeight[0]+=this.numberOffset),Euterpe.Node.prototype.getRealHeight.call(this,e,t)},render:function(e,t,i){var r=[],n=Euterpe.getY(0,i,t),o=n-Euterpe.global.lineWidth/2;return this.leftWidth>0&&r.push(this.initBar(this.leftType,e,o,i,!1)),this.rightWidth>0&&r.push(this.initBar(this.rightType,e+this.leftWidth*i,o,i,!0)),"undefined"!=typeof this.number&&r.push(this.renderNumber(e,t,i)),r},renderNumber:function(e,t,i){return this.numberItem.render(e+this.leftWidth*i,t-this.numberOffset*i-this.numberHeight[1]*i,i)},initBar:function(e,t,i,r,n){var o,u,a=this.parent.numberOfLines,s=new Kinetic.Group({}),h=2*r,l=6*r,c=5*r,g=t,p=Euterpe.global.linePadding,f=Euterpe.global.lineWidth,d=p*(a-1)+f*a-f/2+f/2;if("single"===e){g=t+h/2;var v=new Kinetic.Line({points:[0,0,0,d],stroke:"black",strokeWidth:h,x:g,y:i});s.add(v)}else if("double"===e)g=t+h/2,o=new Kinetic.Line({points:[0,0,0,d],stroke:"black",strokeWidth:h,x:g,y:i}),u=o.clone({x:g+c}),s.add(o),s.add(u);else if("double bold"===e||"repeat"===e){var b,T,C,E,m,y,z=3*h,k=function(e,t){return new Kinetic.Line({points:[0,0,0,d],stroke:"black",strokeWidth:e,x:t,y:i})},W=function(e){var t=Euterpe.getY(1,r,i),n=Euterpe.getY(2,r,i),o=new Kinetic.Group,u=new Kinetic.Circle({x:e,y:t+7*r,radius:l/2,fill:"black",strokeWidth:0});return o.add(u),o.add(u.clone({y:n+7*r})),o},x=[];n?(E=z,m=h,y=l,b=t+E/2,T=t+E+c+m/2,C=t+E+c+m+c+y/2,x.push(k(E,b)),x.push(k(m,T)),"repeat"===e&&x.push(W(C))):"repeat"==e?(E=l,m=h,y=z,b=t+E/2,T=t+E+c+m/2,C=t+E+c+m+c+y/2,x.push(W(b)),x.push(k(m,T)),x.push(k(y,C))):(E=h,m=z,b=t+E/2,T=t+E+c+m/2,x.push(k(E,b)),x.push(k(m,T))),_.each(x,function(e){s.add(e)})}return s}}),e}(),Euterpe.Text=function(){function e(t){this.text=Euterpe.getConfig(t,"text"),this.color=Euterpe.getConfig(t,"color","black"),this.fontFamily=Euterpe.getConfig(t,"fontFamily","Arial"),this.fontSize=Euterpe.getConfig(t,"fontSize",10),this.fontStyle=Euterpe.getConfig(t,"fontStyle","normal");var i=1,r=new Kinetic.Text({x:0,y:0,text:this.text,fontSize:this.fontSize*i,fontFamily:this.fontFamily,fontStyle:this.fontStyle}),n=r.height()/i;this.realWidth=r.width()/i,this.realHeight=[n/2,n/2],e.super.call(this,"Euterpe.Text",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,i){var r=[new Kinetic.Text({x:e,y:t-(this.realHeight[0]*i+this.realHeight[1]*i)/2,text:this.text,fontSize:this.fontSize*i,fontFamily:this.fontFamily,fontStyle:this.fontStyle,fill:this.color})];return Euterpe.bind(this,r),r}}),e}(),Euterpe.Rest=function(){function e(t){switch(this.type=Euterpe.getConfig(t,"type","long"),e.super.call(this,"Euterpe.Rest",t),this.basicWidth=7,this.type){case"long":this.realWidth=this.basicWidth,this.realHeight=[0,28];break;case"double_whole":this.realWidth=this.basicWidth,this.realHeight=[0,14.5];break;case"whole":this.realWidth=20,this.realHeight=[0,8];break;case"half":this.realWidth=20,this.realHeight=[6,0];break;case"quarter":this.realWidth=20,this.realHeight=[16.75,22.25];break;case"eighth":this.realWidth=20,this.realHeight=[9.5,16.25];break;case"sixteenth":this.realWidth=20,this.realHeight=[9.5,30.25];break;case"thirty-second":this.realWidth=25,this.realHeight=[9.5,43.25];break;case"sixty-fourth":this.realWidth=30,this.realHeight=[9.5,55.75]}}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,i){var r=e+this.getRealWidth(i)/2,n=[];switch(this.type){case"half":n.push(this.initHalf(r,t,i));break;case"quarter":n.push(this.initQuarter(r,t,i));break;case"eighth":n.push(this.initEighth(r,t,i));break;case"sixteenth":n.push(this.initSixteen(r,t,i));break;case"thirty-second":n.push(this.initThirtySecond(r,t,i));break;case"sixty-fourth":n.push(this.initSixtyFourth(r,t,i));break;default:n.push(this.simpleRestShape(r,t,i))}return Euterpe.bind(this,n),n},initHalf:function(e,t,i){var r=this.getRealHeight(i,!0);return this.simpleRestShape(e,t-r[0],i)},initQuarter:function(e,t,i){var r=.125*i,n=this.getRealHeight(i,!0),o=t-n[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,o),t.scale(r,r),t.beginPath(),t.moveTo(100.2,80.7),t.bezierCurveTo(100.2,100.2,61.1,129.6,61.1,168.7),t.bezierCurveTo(61.1,183.4,90.4,227.5,110,251.9),t.bezierCurveTo(100.2,247,90.4,242.1,75.8,242.1),t.bezierCurveTo(46.4,242.1,36.6,266.6,36.6,281.3),t.bezierCurveTo(36.6,291.1,46.4,300.9,51.3,310.7),t.bezierCurveTo(21.9,291.1,2.4,271.5,2.4,251.9),t.bezierCurveTo(2.4,203,35.8,220.1,60.2,210.3),t.bezierCurveTo(35.8,185.9,12.1,149.2,12.1,134.5),t.bezierCurveTo(12.1,124.7,41.5,90.4,51.3,66),t.lineTo(51.3,51.3),t.bezierCurveTo(51.3,36.6,41.5,17,36.6,2.4),t.bezierCurveTo(56.2,26.8,100.2,70.9,100.2,80.7),t.lineTo(100.2,80.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initEighth:function(e,t,i){var r=.125*i,n=this.getRealHeight(i,!0),o=t-n[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,o),t.scale(r,r),t.beginPath(),t.moveTo(92.9,5.2),t.bezierCurveTo(90.4,14.4,88.4,21.5,88.1,21.9),t.bezierCurveTo(84.9,28.7,78.5,37.2,73.6,42.1),t.bezierCurveTo(68.4,47.3,65.5,48.2,61.1,46.5),t.bezierCurveTo(57.4,44.5,56.2,42.4,53.8,31.5),t.bezierCurveTo(51.7,23.4,50.2,19,46.9,15.8),t.bezierCurveTo(38.4,6.5,23.8,5.3,12.6,12.6),t.bezierCurveTo(7.3,16.2,3.3,21.9,.9,28),t.bezierCurveTo(0,31.1,0,32,0,36.4),t.bezierCurveTo(0,40.9,0,42.4,.9,44.9),t.bezierCurveTo(3.6,53.8,9.3,60.7,18.2,64.7),t.bezierCurveTo(24.7,68,27.1,68.4,36,68.4),t.bezierCurveTo(42.5,68.4,44.5,68.4,49.8,67.5),t.bezierCurveTo(57.1,66.3,64.7,63.9,73.2,61.5),t.lineTo(78.5,59.4),t.lineTo(78.5,60.7),t.bezierCurveTo(78,62.3,44.1,190,43.7,190.8),t.bezierCurveTo(43.3,192.4,50.6,195.6,55,195.6),t.bezierCurveTo(59.4,195.6,65.9,192.8,66.3,190.8),t.bezierCurveTo(66.7,190.4,86.1,106.8,110.3,5.1),t.bezierCurveTo(107.1,-2.6,98.1,-.8,92.9,5.2),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixteen:function(e,t,i){var r=this.getRealHeight(i,!0),n=.125*i,o=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,o),t.scale(n,n),t.beginPath(),t.moveTo(132.4,0),t.bezierCurveTo(126.7,0,121.8,4.5,120.8,9.5),t.bezierCurveTo(118,21.7,117.1,25.3,116.8,26.1),t.bezierCurveTo(114.2,31.6,107.4,42.3,102.3,47.8),t.bezierCurveTo(96.7,52.9,94.2,53.8,89.5,52.1),t.bezierCurveTo(85.7,50,84.4,47.8,81.9,36.3),t.bezierCurveTo(79.7,27.8,78,23.1,74.6,19.8),t.bezierCurveTo(65.6,9.9,50.3,8.6,38.3,16.3),t.bezierCurveTo(32.8,20.2,28.6,26.1,26,32.6),t.bezierCurveTo(25.1,35.9,25.1,36.8,25.1,41.5),t.bezierCurveTo(25.1,47.8,25.6,51.3,28.6,56.3),t.bezierCurveTo(32.8,64.9,41.8,71.7,52,74.2),t.bezierCurveTo(63.1,77.2,81.4,74.7,102.3,67.9),t.bezierCurveTo(105.2,66.6,108.2,65.7,108.2,65.7),t.bezierCurveTo(108.2,66.2,104.8,80.2,101,97.7),t.bezierCurveTo(94.6,127.5,94.2,129.7,92,133.4),t.bezierCurveTo(88.6,140.7,81,151,75.8,155.6),t.bezierCurveTo(71.6,159.5,68.7,160.3,64.4,158.6),t.bezierCurveTo(60.6,156.5,59.2,154.3,56.7,142.9),t.bezierCurveTo(54.5,134.3,52.9,129.7,49.4,126.2),t.bezierCurveTo(40.5,116.4,25.1,115.2,13.2,122.8),t.bezierCurveTo(7.7,126.7,3.4,132.6,.9,139),t.bezierCurveTo(0,142.5,0,143.3,0,148),t.bezierCurveTo(0,154.3,.4,157.7,3.4,162.8),t.bezierCurveTo(7.7,171.4,16.6,178.2,26.9,180.8),t.bezierCurveTo(37.9,183.7,59.2,180.8,80.1,173.5),t.bezierCurveTo(82.7,172.7,84.4,172.3,84.4,172.3),t.bezierCurveTo(84.4,172.7,54.5,306.4,53.3,310.7),t.bezierCurveTo(53.3,311.6,53.7,312,55.4,312.8),t.bezierCurveTo(58,314.5,62.2,315.9,65.2,315.9),t.bezierCurveTo(68.2,315.9,72.4,314.5,75,312.8),t.bezierCurveTo(76.7,312,77.2,311.6,77.6,309.4),t.bezierCurveTo(77.6,308.2,100.1,196.1,127.9,60.2),t.bezierCurveTo(131.9,40.2,133.1,33.9,136.5,17),t.bezierCurveTo(137.7,11.1,139.7,0,132.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initThirtySecond:function(e,t,i){var r=this.getRealHeight(i,!0),n=.125*i,o=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,o),t.scale(n,n),t.beginPath(),t.moveTo(154.4,0),t.bezierCurveTo(152.8,0,146,-0,144.3,7.4),t.bezierCurveTo(141.2,20.7,140.5,22.5,138.9,25.3),t.bezierCurveTo(134.2,35.1,127.5,44.5,122.7,47.5),t.bezierCurveTo(120.2,49.2,118,49.2,115.1,47.9),t.bezierCurveTo(111.2,45.8,109.9,43.6,107.4,32.1),t.bezierCurveTo(105.2,23.6,103.6,18.9,100.1,15.5),t.bezierCurveTo(91.2,5.7,75.8,4.5,63.9,12.1),t.bezierCurveTo(58.4,15.9,54.1,21.9,51.6,28.3),t.bezierCurveTo(50.7,31.7,50.7,32.5,50.7,37.2),t.bezierCurveTo(50.7,43.6,51.1,47.1,54.1,52.2),t.bezierCurveTo(58.4,60.7,67.3,67.5,77.6,70),t.bezierCurveTo(82.3,71.4,94.2,71.4,102.3,70),t.bezierCurveTo(109.1,68.8,117.2,66.6,125.3,64.1),t.bezierCurveTo(129.1,62.8,131.7,61.9,132.1,61.9),t.bezierCurveTo(132.1,62.3,117.6,126.3,116.8,128.4),t.bezierCurveTo(114.2,133.9,107.4,144.6,102.3,150.1),t.bezierCurveTo(96.7,155.2,94.2,156.1,89.5,154.4),t.bezierCurveTo(85.7,152.3,84.4,150.1,81.9,138.6),t.bezierCurveTo(79.7,130.1,78,125.4,74.6,122.1),t.bezierCurveTo(65.6,112.2,50.3,111,38.3,118.6),t.bezierCurveTo(32.8,122.5,28.6,128.4,26,134.9),t.bezierCurveTo(25.1,138.2,25.1,139.1,25.1,143.8),t.bezierCurveTo(25.1,150.1,25.6,153.6,28.6,158.7),t.bezierCurveTo(32.8,167.2,41.8,174,52,176.5),t.bezierCurveTo(63.1,179.5,81.4,177,102.3,170.2),t.bezierCurveTo(105.2,168.9,108.2,168,108.2,168),t.bezierCurveTo(108.2,168.5,104.8,182.5,101,200),t.bezierCurveTo(94.6,229.8,94.2,232,92,235.7),t.bezierCurveTo(88.6,243,81,253.3,75.8,258),t.bezierCurveTo(71.6,261.8,68.7,262.6,64.4,260.9),t.bezierCurveTo(60.6,258.8,59.2,256.6,56.7,245.2),t.bezierCurveTo(54.5,236.7,52.9,232,49.4,228.5),t.bezierCurveTo(40.5,218.7,25.1,217.5,13.2,225.1),t.bezierCurveTo(7.7,229,3.4,234.9,.9,241.3),t.bezierCurveTo(0,244.8,0,245.6,0,250.3),t.bezierCurveTo(0,256.6,.4,260,3.4,265.1),t.bezierCurveTo(7.7,273.7,16.6,280.5,26.9,283.1),t.bezierCurveTo(37.9,286,59.2,283.1,80.1,275.8),t.bezierCurveTo(82.7,275,84.4,274.6,84.4,274.6),t.bezierCurveTo(84.4,275,54.5,408.7,53.3,413),t.bezierCurveTo(53.3,413.9,53.7,414.3,55.4,415.2),t.bezierCurveTo(58,416.8,62.2,418.2,65.2,418.2),t.bezierCurveTo(68.2,418.2,72.4,416.8,75,415.2),t.bezierCurveTo(76.7,414.3,77.2,413.9,77.6,411.7),t.bezierCurveTo(77.6,410.5,100.1,298.4,127.9,162.5),t.bezierCurveTo(141.5,94.4,151.4,44.8,158.6,8.7),t.bezierCurveTo(159.5,4.3,157.9,-.1,154.4,0),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},initSixtyFourth:function(e,t,i){var r=this.getRealHeight(i,!0),n=.125*i,o=t-r[0];return new Kinetic.Shape({sceneFunc:function(t){t.translate(e,o),t.scale(n,n),t.beginPath(),t.bezierCurveTo(89,2.9,80.5,10.6,76.7,21.2),t.bezierCurveTo(75.8,24.6,75.8,25.4,75.8,30.1),t.bezierCurveTo(75.8,34.8,75.8,36.5,76.7,39.1),t.bezierCurveTo(79.7,48.5,85.7,55.7,95,59.9),t.bezierCurveTo(101.8,63.4,104.4,63.8,113.8,63.8),t.bezierCurveTo(120.2,63.8,122.7,63.8,127.9,63),t.bezierCurveTo(134.6,61.7,144,59.1,151.3,56.6),t.lineTo(155.9,54.8),t.lineTo(155.5,56.6),t.bezierCurveTo(155.1,57.4,152.1,72.3,148.2,89.3),t.bezierCurveTo(141.5,119.2,141.1,120.9,138.9,124.7),t.bezierCurveTo(134.2,134.5,127.5,143.9,122.7,146.9),t.bezierCurveTo(120.2,148.6,118,148.6,115.1,147.3),t.bezierCurveTo(111.2,145.2,109.9,143,107.4,131.5),t.bezierCurveTo(105.2,123,103.6,118.3,100.1,114.9),t.bezierCurveTo(91.2,105.1,75.8,103.9,63.9,111.5),t.bezierCurveTo(58.4,115.3,54.1,121.3,51.6,127.7),t.bezierCurveTo(50.7,131.1,50.7,131.9,50.7,136.6),t.bezierCurveTo(50.7,143,51.1,146.5,54.1,151.6),t.bezierCurveTo(58.4,160.1,67.3,166.9,77.6,169.4),t.bezierCurveTo(82.3,170.8,94.2,170.8,102.3,169.4),t.bezierCurveTo(109.1,168.2,117.2,166,125.3,163.5),t.bezierCurveTo(129.1,162.3,131.7,161.3,132.1,161.3),t.bezierCurveTo(132.1,161.8,117.6,225.7,116.8,227.8),t.bezierCurveTo(114.2,233.3,107.4,244,102.3,249.5),t.bezierCurveTo(96.7,254.6,94.2,255.6,89.5,253.8),t.bezierCurveTo(85.7,251.7,84.4,249.5,81.9,238),t.bezierCurveTo(79.7,229.5,78,224.8,74.6,221.5),t.bezierCurveTo(65.6,211.6,50.3,210.4,38.3,218),t.bezierCurveTo(32.8,221.9,28.6,227.8,26,234.3),t.bezierCurveTo(25.1,237.6,25.1,238.5,25.1,243.2),t.bezierCurveTo(25.1,249.5,25.6,253,28.6,258.1),t.bezierCurveTo(32.8,266.6,41.8,273.4,52,275.9),t.bezierCurveTo(63.1,278.9,81.4,276.4,102.3,269.6),t.bezierCurveTo(105.2,268.3,108.2,267.4,108.2,267.4),t.bezierCurveTo(108.2,267.9,104.8,281.9,101,299.4),t.bezierCurveTo(94.6,329.2,94.2,331.4,92,335.1),t.bezierCurveTo(88.6,342.4,81,352.7,75.8,357.4),t.bezierCurveTo(71.6,361.2,68.7,362,64.4,360.3),t.bezierCurveTo(60.6,358.2,59.2,356,56.7,344.6),t.bezierCurveTo(54.5,336.1,52.9,331.4,49.4,328),t.bezierCurveTo(40.5,318.1,25.1,316.9,13.2,324.5),t.bezierCurveTo(7.7,328.4,3.4,334.3,.9,340.7),t.bezierCurveTo(0,344.2,0,345,0,349.7),t.bezierCurveTo(0,356,.4,359.4,3.4,364.5),t.bezierCurveTo(7.7,373.1,16.6,379.9,26.9,382.5),t.bezierCurveTo(37.9,385.4,59.2,382.5,80.1,375.2),t.bezierCurveTo(82.7,374.4,84.4,374,84.4,374),t.bezierCurveTo(84.4,374.4,54.5,508.1,53.3,512.4),t.bezierCurveTo(53.3,513.3,53.7,513.7,55.4,514.6),t.bezierCurveTo(58,516.2,62.2,517.6,65.2,517.6),t.bezierCurveTo(68.2,517.6,72.4,516.2,75,514.6),t.bezierCurveTo(76.7,513.7,77.2,513.3,77.6,511.1),t.bezierCurveTo(77.6,509.9,100.1,397.8,127.9,261.9),t.bezierCurveTo(171.7,42.9,177.2,14.8,176.8,13.9),t.bezierCurveTo(175.6,11.8,173.9,11,171.3,11),t.bezierCurveTo(167.5,11,166.6,11.8,162.8,19.1),t.bezierCurveTo(157.3,29.7,151.7,37.4,147.8,40.4),t.bezierCurveTo(145.7,42.1,143.6,42.1,140.2,40.8),t.bezierCurveTo(136.4,38.6,135.1,36.5,132.5,25),t.bezierCurveTo(130,13.5,126.9,8.4,120.6,4.1),t.bezierCurveTo(114.6,.3,107,-.9,100.1,.7),t.closePath(),t.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})},simpleRestShape:function(e,t,i){return new Kinetic.Rect({x:e,y:t,width:this.getRealWidth(i),height:this.getRealHeight(i),fill:"black",strokeWidth:0})}}),e}(),Euterpe.StringNumber=function(){function e(t){if(this.string=Euterpe.getConfig(t,"string"),this.fontSize=10,this.fontFamily="Arial","number"!=typeof this.string||this.string<0||this.string>6)throw"Invalid string value";this.string=this.string.toString(),this.textWidth=5,this.textHeight=7.6,this.realWidth=21.3,this.realHeight=[10.65,10.65],e.super.call(this,"Euterpe.StringNumber",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,i){var r=[],n=e+this.realWidth*i/2;return r.push(new Kinetic.Circle({x:n,y:t,radius:10*i,fill:"white",stroke:"black",strokeWidth:i})),r.push(new Kinetic.Text({x:n-this.textWidth*i/2,y:t-this.textHeight*i/2,text:this.string,fontSize:this.fontSize*i,fontFamily:this.fontFamily,fill:"black"})),Euterpe.bind(this,r),r}}),e}(),Euterpe.KeySignature=function(){function e(t){if(this.type=Euterpe.getConfig(t,"type"),this.amount=Euterpe.getConfig(t,"amount"),"sharp"!==this.type&&"flat"!==this.type)throw"Invalid type argument";if("number"!=typeof this.amount||this.amount<1||this.amount>7)throw"amount should be >= 1 and <= 7";e.super.call(this,t);for(var i={sharp:[0,1.5,-.5,1,2.5,.5,2],flat:[2,.5,2.5,1,3,1.5,3.5]},r=0;r<this.amount;r++){var n={location:i[this.type][r]};this.add("sharp"===this.type?new Euterpe.Sharp(n):new Euterpe.Flat(n))}}return Euterpe.extend(Euterpe.Container,e),e}(),Euterpe.Plugin=function(){var e=function(e,t){this.name=e,this.config=t||{}};return e.prototype.isPlugin=!0,e.prototype.process=function(e){return e},e}(),Euterpe.PluginNoteBar=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteBar",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t,i){for(var r=Euterpe.select("Euterpe.Column",e),n=[],o=[],u=1,a={},s=0;s<r.length;s++)for(var h=r[s],l=0;l<h.items.length;l++){var c=h.items[l],g=c.config||{};("begin"===g.bar||"cont"===g.bar||"end"===g.bar)&&(u="down"===g.beamDirection?-1:1,a[n.length]=u,c.flags=0,o.push(c.id),"end"===g.bar&&(this.adjustBeamHeight(o,u),n.push(_.clone(o)),o.length=0))}for(var p=0;p<n.length;p++)i.push(this.bind(n[p],a[p]));return e},getTopTwo:function(e,t){var i=_.clone(e);return i.sort(function(e,i){return 1===t?e.config.location-i.config.location:i.config.location-e.config.location}),i.length>2?[i[0],i[1]]:i},adjustBeamHeight:function(e,t){if(e=_.map(e,function(e){return Euterpe.select("#"+e)[0]}),e.length>2)for(var i=this.getTopTwo(e,t),r=function(e,i){return Euterpe.getY(e,scale,i)-e.beamRealHeight*scale*t},n=i[0],o=i[1],u=n.parent.parent,a=Euterpe.getDistance(u,n,scale),s=Euterpe.getDistance(u,o,scale),h=0;h<e.length;h++){var l=Math.abs(Euterpe.getY(e[h],scale,0)),c=r(n,l),g=r(o,l),p=(g-c)/(s-a),f=Euterpe.getDistance(u,e[h],scale),d=r(e[h],l),v=p*(f-a)+c,b=d-v;0!==b&&(e[h].beamRealHeight+=b*t/scale,e[h].calculateSize())}},bind:function(e,t){return function(i,r){var n=Euterpe.select("#"+e[0])[0],o=Euterpe.select("#"+e[e.length-1])[0],u=n.beam.x(),a=n.beam.y()-n.beamHeight*t,s=o.beam.x(),h=o.beam.y()-o.beamHeight*t,l=4*r,c=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(u,a),e.lineTo(s,h),e.lineTo(s,h+l*t),e.lineTo(u,a+l*t),e.moveTo(u,a),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0});return c}}}),e}(),Euterpe.PluginNoteText=function(){var e=function(t){e.super.call(this,"Euterpe.PluginNoteText",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){for(var t=Euterpe.select("Euterpe.Note",e),i=0;i<t.length;i++){var r=t[i];if("undefined"!=typeof r.config.text){var n=new Euterpe.Text({text:r.config.text});r.leftItems.push(n)}}return e}}),e}(),Euterpe.PluginAccidentals=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAccidentals",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){for(var t=Euterpe.select("Euterpe.Note",e),i=0;i<t.length;i++){var r=t[i];if("undefined"!=typeof r.config.sharp||"undefined"!=typeof r.config.flat)for(var n=r.config.sharp||r.config.flat,o=0;n>o;o++)"undefined"!=typeof r.config.sharp?r.leftItems.push(new Euterpe.Sharp({})):"undefined"!=typeof r.config.flat&&r.leftItems.push(new Euterpe.Flat({}))}return e}}),e}(),Euterpe.PluginAboveBelow=function(){var e=function(t){e.super.call(this,"Euterpe.PluginAboveBelow",t)};return Euterpe.extend(Euterpe.Plugin,e,{roundLine:function(e){var t,i;return 0>e?(t=e-Math.ceil(e),i=0===t?e:t>=-.5?Math.ceil(e)-.5:Math.floor(e)):(t=e-Math.floor(e),i=0===t?e:.5>=t?Math.floor(e)+.5:Math.ceil(e))},place:function(e,t,i,r){var n,o,u,a,s=0;"number"==typeof r?n=r:"above"===i?n=0:"below"===i&&(n=4);for(var h=0;h<e.length;h++){var l=e[h];o=l.getRealHeight(t,!0),u=o[0]/this.lineH,a=o[1]/this.lineH,"above"===i?(s=n-this.roundLine(a),n=s-this.roundLine(u)):"below"===i&&(s=n+this.roundLine(a),n=s+this.roundLine(u)),l.config.location=s}},process:function(e,t){this.lineH=Euterpe.global.linePadding+Euterpe.global.lineWidth;for(var i=Euterpe.select("Euterpe.Column",e),r=0;r<i.length;r++){var n=i[r],o=n.config,u=n.getRealHeight(t,!0),a=this.roundLine(u[0]/this.lineH*-1),s=this.roundLine(u[1]/this.lineH);4>s&&(s=4),_.isArray(o.aboveItems)&&this.place(o.aboveItems,t,"above",a),_.isArray(o.belowItems)&&this.place(o.belowItems,t,"below",s)}return e}}),e}(),Euterpe.PluginTab=function(){var e=function(t){e.super.call(this,"Euterpe.PluginTab",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e){for(var t=0;t<e.items.length;t++){for(var i=e.items[t],r=new Euterpe.Row({type:"tab"}),n=0;n<i.items.length;n++){var o=i.items[n];if("Euterpe.Bar"!=o.name){for(var u=new Euterpe.Column({}),a=Euterpe.select("Euterpe.Note",o),s=0;s<a.length;s++){var h=a[s];"number"==typeof h.config.tab_location&&"string"==typeof h.config.tab_text&&(i.group=t.toString(),i.groupType="bracket",r.group=i.group,r.groupType=i.groupType,u.add(new Euterpe.Text({text:h.config.tab_text,location:h.config.tab_location})))}null!==r&&u.items.length>0&&r.add(u)}else r.add(o.clone())}"undefined"!=typeof r.group&&e.items.splice(t+1,0,r)}return e}}),e}(),Euterpe.PluginAlign=function(){var e=function(t){this.totalWidth=Euterpe.getConfig(t,"totalWidth"),this.nodeMargin=Euterpe.getConfig(t,"nodeMargin",5),this.sideMargin=Euterpe.getConfig(t,"sideMargin",3),e.super.call(this,"Euterpe.PluginAlign",t)};return Euterpe.extend(Euterpe.Plugin,e,{process:function(e,t){var i,r;for(i=0;i<e.items.length;i++){r=e.items[i];var n,o=this.collectNodes(r);for(n=0;n<o.length;n++)o[n].leftMargin=this.nodeMargin;this.alignSideItems(r)}var u=Euterpe.getGroups(e.items);for(i=0;i<u.length;i++)this.processGroup(u[i],t);return e},alignSideItems:function(e){for(var t=Euterpe.select("Euterpe.Column",e),i=0;i<t.length;i++)for(var r=t[i],n=0;n<r.items.length;n++){var o,u=r.items[n];
for(o=0;o<u.leftItems.length;o++)u.leftItems[o].rightMargin=this.sideMargin;for(o=0;o<u.rightItems.length;o++)u.rightItems[o].leftMargin=this.sideMargin}},getColsBars:function(e){for(var t=[],i=1;i<e.items.length;i++){var r=e.items[i];("Euterpe.Column"===r.name||"Euterpe.Bar"===r.name)&&t.push(r)}return t},stretchAlign:function(e,t){for(var i=e.getRealWidth(t),r=this.getColsBars(e),n=this.totalWidth-i,o=n/r.length/t,u=0;u<r.length;u++)r[u].leftMargin+=o},getCols:function(e,t){return _.map(e,function(e){return e[t]})},cleanGroup:function(e){for(var t=[],i=0;i<e.items.length;i++)t[i]=this.getColsBars(e.items[i]);return t},processGroup:function(e,t){var i,r,n,o,u=this.cleanGroup(e),a=_.max(_.map(u,function(e){return e.length}));for(i=0;a>i;i++){o=this.getCols(u,i);var s={},h={},l={};for(r=0;r<o.length;r++)n=o[r],"undefined"!=typeof n&&(s[n.id]=Euterpe.getDistance(n.parent,n,t)+n.leftMargin*t+n.getLeftWidth(t),h[n.id]=n.getRealWidth(t,!0),l[n.id]=n.getRightWidth(t));var c=_.max(_.values(s)),g=_.max(_.values(h)),p=_.max(_.values(l));for(r=0;r<o.length;r++)if(n=o[r],"undefined"!=typeof n){var f=s[n.id],d=h[n.id],v=l[n.id];c>f&&(n.leftMargin+=(c-f)/t),g>d&&(n.rightMargin+=(g-d)/t),p>v&&(n.rightMargin+=(p-v)/t)}}var b=this;_.each(e.items,function(e){b.stretchAlign(e,t)})},collectNodes:function(e){return _.filter(e.items,function(e){return"Euterpe.Bar"!==e.name&&"Euterpe.Column"!==e.name})}}),e}(),Euterpe.Score=function(){function e(t){this.layer=t.layer,this.lineMargin=Euterpe.getConfig(t,"lineMargin",0),this.titleMargin=Euterpe.getConfig(t,"titleMargin",0),this.musicByMargin=Euterpe.getConfig(t,"musicByMargin",0),this.tuningMargin=Euterpe.getConfig(t,"tuningMargin",0),this.title=Euterpe.getConfig(t,"title",void 0),this.musicBy=Euterpe.getConfig(t,"musicBy",void 0),this.tuning=Euterpe.getConfig(t,"tuning",void 0),this.titleHeight=0,this.musicByHeight=0,this.tuningHeight=0,"undefined"!=typeof this.title&&(this.titleText=new Euterpe.Text({text:this.title,fontSize:40,fontFamily:"Serif"}),this.titleWidth=this.titleText.getRealWidth(1),this.titleHeight=this.titleText.getRealHeight(1)),"undefined"!=typeof this.musicBy&&(this.musicByText=new Euterpe.Text({fontSize:20,text:"Music by "+this.musicBy,fontFamily:"Serif"}),this.musicByHeight=this.musicByText.getRealHeight(1)),"undefined"!=typeof this.tuning&&(this.tuningText=new Euterpe.Text({fontSize:15,text:this.tuning,fontFamily:"Serif",fontStyle:"italic"}),this.tuningHeight=this.tuningText.getRealHeight(1)),e.super.call(this,"Euterpe.Score",t)}return Euterpe.extend(Euterpe.Container,e,{bracketExtraUp:5,bracketExtraDown:5,getRealHeight:function(e,t){var i=this.doGetRealHeight(this.items,e,t),r=0;return r+=this.titleHeight*e,r+=this.titleMargin*e,r+=this.musicByHeight*e,r+=this.musicByMargin*e,r+=this.tuningHeight*e,r+=this.tuningMargin*e,t?i[0]+=r:i+=r,i},render:function(e,t,i){var r,n=0,o=[],u=Euterpe.getGroups(this.items),a=0;for(r=0;r<u.length;r++){var s=u[r];"bracket"===s.groupType&&6>a&&(a=6)}e+=a*i;var h=0;for(t=this.renderMeta(e,t,i,o),r=0;r<this.items.length;r++){var l=this.items[r],c=this.doGetRealHeight([l],i,!0);0!==n&&(n+=c[0]);var g=t+n;l.Y=g,l.X=e,h<u.length&&u[h].first===l.id&&(o.push(this.renderBracket(e-a*i,g,i,u[h].items)),h++),n+=c[1],o.push(l.render(e,g,i))}return o},renderMeta:function(e,t,i,r){var n=this.getRealHeight(i,!0);t-=n[0];var o=(this.titleHeight+this.musicByHeight+this.tuningHeight+this.titleMargin+this.musicByMargin+this.tuningMargin)*i;return"undefined"!=typeof this.title&&(t+=this.titleHeight*i/2,r.push(this.renderText(this.titleText,this.titleWidth,e,t,i,!0)),t+=this.titleHeight*i/2,t+=this.titleMargin*i),"undefined"!=typeof this.musicBy&&(t+=this.musicByHeight*i/2,r.push(this.renderText(this.musicByText,0,e,t,i)),t+=this.musicByHeight*i/2,t+=this.musicByMargin*i),"undefined"!=typeof this.tuning&&(t+=this.tuningHeight*i/2,r.push(this.renderText(this.tuningText,0,e,t,i)),t+=this.tuningHeight*i/2,t+=this.tuningMargin*i),t+=n[0]-o},renderText:function(e,t,i,r,n,o){var u=i;if(o){var a=this.items[0].getRealWidth(n);u=i+(a/2-t/2)}return e.render(u,r,n)},doGetRealHeight:function(e,t,i){for(var r,n=0,o=Euterpe.getGroups(this.items),u=function(e){return _.find(o,function(t){return t.first===e.id})},a=function(e){return _.find(o,function(t){return t.last===e.id})},s=0;s<e.length;s++){var h=e[s],l=h.getRealHeight(t,!0);u(h)&&(l[0]+=this.bracketExtraUp*t),a(h)&&(l[1]+=this.bracketExtraDown*t);var c=l[1]+l[0];"undefined"==typeof r&&(r=l[0]+n),n+=c+this.lineMargin*t}return i?[r,n-r]:n},renderBracket:function(e,t,i,r){var n=this.bracketExtraUp*i,o=this.bracketExtraDown*i,u=this.doGetRealHeight(r,i,!0),a=u[0]-n,s=u[1]-o-this.lineMargin*i;return new Kinetic.Shape({sceneFunc:function(r){r.beginPath();var u=10*i;r.moveTo(e+u,t-a-n),r.lineTo(e,t-a),r.lineTo(e,t+s),r.lineTo(e+u,t+s+o),r.lineTo(e+u/5,t+s),r.lineTo(e+u/5,t-a),r.lineTo(e+u,t-a-n),r.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})}}),e}(),Euterpe.Note=function(){function e(t){this.type=Euterpe.getConfig(t,"type","quarter"),this.beamDir=Euterpe.getConfig(t,"beamDirection",void 0),this.flags=Euterpe.getConfig(t,"flags",0),this.dots=Euterpe.getConfig(t,"dots",0),this.beam=void 0,e.super.call(this,"Euterpe.Note",t),this.headHeight=13.3,this.realHeight=[this.headHeight/2,this.headHeight/2],this.realWidth=this.headWidth="whole"===this.type?21.2:13.6,this.dotWidth=4.5,this.dotMargin=2.5,this.calculateSize()}return Euterpe.extend(Euterpe.Node,e,{beamRealHeight:35,calculateSize:function(){"up"===this.beamDir?this.realHeight=[this.beamRealHeight,this.headHeight/2]:"down"===this.beamDir&&(this.realHeight=[this.headHeight/2,this.beamRealHeight]),this.realWidth+=(this.dotMargin+this.dotWidth)*this.dots,this.flags>0&&(this.realWidth+=13.3)},render:function(e,t,i){this.beamWidth=1.3*i,this.beamHeight=this.beamRealHeight*i,this.scale=i,this.startX=e+this.headWidth*i/2,this.startY=t;var r=[];switch(this.type){case"whole":r=this.initWhole();break;default:r=this.initHalfQuarter()}if(this.dots>0){var n=0,o=this.location;o%1===0&&(n=3*i);for(var u=e+this.headWidth*i,a=this.dots;a>0;a--)u+=this.dotMargin*i+this.dotWidth*i/2,r.push(new Kinetic.Ellipse({x:u,y:this.Y-n,radius:{x:2*this.scale,y:2*this.scale},fill:"black"})),u+=this.dotWidth*i/2}return Euterpe.bind(this,r),r},initWhole:function(){var e=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:10.5*this.scale,y:6.5*this.scale},fill:"black"}),t=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:5.5*this.scale,y:4*this.scale},fill:"white"});return t.rotation(45),[e,t]},initHalfQuarter:function(){var e=[],t=this,i=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:7.6*this.scale,y:5.6*this.scale},fill:"black"});if(i.rotation(140),e.push(i),"half"===this.type){var r=new Kinetic.Ellipse({x:this.startX,y:this.startY,radius:{x:6.6*this.scale,y:2.5*this.scale},fill:"white"});r.rotation(140),e.push(r)}var n,o;if("string"==typeof this.beamDir&&("up"===this.beamDir?(n=i.x()+i.width()/2-this.beamWidth-this.beamWidth/3,o=i.y(),this.beam=new Kinetic.Line({points:[0,0,0,-this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:n,y:o}),e.push(this.beam)):"down"===this.beamDir&&(n=i.x()-i.width()/2+this.beamWidth+this.beamWidth/3,o=i.y(),this.beam=new Kinetic.Line({points:[0,0,0,this.beamHeight],stroke:"black",strokeWidth:this.beamWidth,x:n,y:o}),e.push(this.beam)),1==this.flags)){var u=this.beam.x(),a=this.beam.y()-this.beamHeight,s=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(u,a),e.bezierCurveTo(u+6.2*t.scale,a+11.8*t.scale,u+21.4*t.scale,a+10.4*t.scale,u+10*t.scale,a+26.4*t.scale),e.bezierCurveTo(u+19.6*t.scale,a+12.4*t.scale,u+5.4*t.scale,a+10.4*t.scale,u-.2*t.scale,a+7.4*t.scale),e.closePath(),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:1});e.push(s)}return Euterpe.bind(this,e),e}}),e}(),Euterpe.TrebleClef=function(){function e(t){this.realWidth=36.8,t.location=0,e.super.call(this,"Euterpe.TrebleClef",t)}return Euterpe.extend(Euterpe.Node,e,{realHeight:[26.3,82],render:function(e,t,i){this.startX=e,this.startY=t-27*i,this.scale=.125*i;var r=this,n=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(159,3),e.quadraticCurveTo(129,50,117,93),e.quadraticCurveTo(107,126,102,167),e.quadraticCurveTo(101,192,102,210),e.quadraticCurveTo(107,255,116,297),e.quadraticCurveTo(63,351,44,375),e.quadraticCurveTo(24,401,15,429),e.quadraticCurveTo(2,464,3,503),e.quadraticCurveTo(5,540,20,575),e.quadraticCurveTo(29,596,48,615),e.quadraticCurveTo(62,630,87,645),e.quadraticCurveTo(113,660,150,666),e.quadraticCurveTo(177,668,194,665),e.quadraticCurveTo(204,720,213,776),e.quadraticCurveTo(216,795,216,813),e.quadraticCurveTo(203,849,158,857),e.quadraticCurveTo(132,857,120,842),e.quadraticCurveTo(152,845,166,813),e.quadraticCurveTo(165,821,168,802),e.quadraticCurveTo(166,775,151,765),e.quadraticCurveTo(132,750,107,758),e.quadraticCurveTo(86,768,78,789),e.quadraticCurveTo(71,818,90,840),e.quadraticCurveTo(105,857,129,865),e.quadraticCurveTo(149,872,177,865),e.quadraticCurveTo(194,860,209,846),e.quadraticCurveTo(231,828,230,803),e.quadraticCurveTo(221,735,207,662),e.quadraticCurveTo(248,650,267,626),e.quadraticCurveTo(293,599,296,566),e.quadraticCurveTo(300,527,285,494),e.quadraticCurveTo(270,462,234,444),e.quadraticCurveTo(215,435,189,435),e.quadraticCurveTo(177,435,164,438),e.quadraticCurveTo(155,396,146,354),e.quadraticCurveTo(183,315,203,275),e.quadraticCurveTo(219,243,222,210),e.quadraticCurveTo(227,167,221,137),e.quadraticCurveTo(213,93,192,51),e.quadraticCurveTo(180,29,159,3),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),o=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(191,93),e.quadraticCurveTo(179,83,171,93),e.quadraticCurveTo(126,162,131,281),e.quadraticCurveTo(188,239,203,188),e.quadraticCurveTo(209,162,204,135),e.quadraticCurveTo(200,111,191,93),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),u=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(171,473),e.quadraticCurveTo(188,555,206,648),e.quadraticCurveTo(237,639,255,620),e.quadraticCurveTo(283,588,283,558),e.quadraticCurveTo(285,525,269,501),e.quadraticCurveTo(252,476,216,470),e.quadraticCurveTo(194,465,171,473),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,446),e.quadraticCurveTo(141,411,132,369),e.quadraticCurveTo(90,401,68,435),e.quadraticCurveTo(45,467,39,503),e.quadraticCurveTo(30,540,45,576),e.quadraticCurveTo(60,612,92,633),e.quadraticCurveTo(123,651,161,654),e.quadraticCurveTo(174,654,188,653),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),s=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.translate(r.startX,r.startY),e.scale(r.scale,r.scale),e.moveTo(147,444),e.quadraticCurveTo(120,456,101,480),e.quadraticCurveTo(83,504,84,536),e.quadraticCurveTo(86,567,107,588),e.quadraticCurveTo(114,597,126,605),e.quadraticCurveTo(116,593,107,581),e.quadraticCurveTo(95,560,99,537),e.quadraticCurveTo(105,509,132,491),e.quadraticCurveTo(143,482,164,476),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),h=[n,o,u,a,s];return Euterpe.bind(this,h),h}}),e}(),Euterpe.Sharp=function(){function e(t){e.super.call(this,"Euterpe.Sharp",t),this.realWidth=9,this.realHeight=[11,11]}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,i){var r=this.realHeight[0]+this.realHeight[1];this.startY=t-r*i/2-i;var n=this.realWidth*i,o=r*i,u=1.5*i,a=new Kinetic.Rect({x:this.X+n/3.6-u/2,y:this.startY+2*i,width:u,height:o,fill:"black",strokeWidth:0}),s=a.clone({x:this.X+n-n/3.6-u/2,y:this.startY}),h=4.5*i,l=this.startY+o/4+3*i;u=3*i;var c=new Kinetic.Line({points:[this.X,l,this.X,l+u,this.X+n,l+u-h,this.X+n,l-h],fill:"black",strokeWidth:0,closed:!0});l=this.startY+o-o/4;var g=c.clone({points:[this.X,l,this.X,l+u,this.X+n,l+u-h,this.X+n,l-h]}),p=[a,s,c,g];return Euterpe.bind(this,p),p}}),e}(),Euterpe.Flat=function(){function e(t){this.realWidth=12.25,this.realHeight=[16.3,9],e.super.call(this,"Euterpe.Flat",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,i){var r=(this.realHeight[0]+this.realHeight[1])*i;this.barWidth=1.5*i,t-=16.25*i;var n=new Kinetic.Line({points:[0,0,0,r],stroke:"black",strokeWidth:this.barWidth,x:e,y:t}),o=t+r,u=e+this.barWidth/2,a=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(u,o),e.lineTo(u+7*i,o-5.25*i),e.bezierCurveTo(u+12*i,o-8.75*i,u+12.5*i,o-19.75*i,u,o-13.75*i),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0}),s=new Kinetic.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(u,o-1.25*i),e.bezierCurveTo(u+9.75*i,o-6.75*i,u+8.25*i,o-17.25*i,u,o-12.75*i),e.fillStrokeShape(this)},fill:"white",stroke:"white",strokeWidth:0}),h=[n,a,s];return Euterpe.bind(this,h),h}}),e}(),Euterpe.Natural=function(){function e(t){this.realWidth=11.5,this.realHeight=[20.5,21.5],e.super.call(this,"Euterpe.Natural",t)}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,i){var r=1.5*i,n=28*i,o=10*i,u=2.5*i,a=1.5*i;t-=n/2+n/4;var s,h,l=new Kinetic.Rect({width:r,height:n,fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1,x:e,y:t}),c=l.clone({x:e+o,y:t+n/2}),g=new Kinetic.Shape({sceneFunc:function(i){s=e,h=t+n/2,i.beginPath(),i.moveTo(s,h),i.lineTo(s+o+r,h-a),i.lineTo(s+o+r,h+u),i.lineTo(s,h+u+a),i.lineTo(s,h),i.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0,strokeEnabled:!1}),p=g.clone({sceneFunc:function(i){s=e,h=t+n-u,i.beginPath(),i.moveTo(s,h),i.lineTo(s+o+r,h-a),i.lineTo(s+o+r,h+u),i.lineTo(s,h+u+a),i.lineTo(s,h),i.fillStrokeShape(this)}}),f=[l,c,g,p];return Euterpe.bind(this,f),f}}),e}(),Euterpe.TimeSignature=function(){function e(t){this.numerator=Euterpe.getConfig(t,"numerator",4),this.denominator=Euterpe.getConfig(t,"denominator",4),e.super.call(this,t),this.add(new Euterpe.TimeSignatureShape(this.numerator,0)),this.add(new Euterpe.TimeSignatureShape(this.denominator,2))}return Euterpe.extend(Euterpe.Column,e,{name:"Euterpe.TimeSignature"}),e}(),Euterpe.TimeSignatureShape=function(){function e(t,i){this.yoffset=2;var r={4:[0,24+this.yoffset]};this.digit=t.toString(),this.realWidth=22.4,this.realHeight=r[t],e.super.call(this,"Euterpe.TimeSignatureShape",{location:i})}return Euterpe.extend(Euterpe.Node,e,{render:function(e,t,i){var r=this;this.scale=i,this.startX=e,this.startY=t+this.yoffset*i;var n=[];return"4"===this.digit&&n.push(new Kinetic.Shape({sceneFunc:function(e){var t=r.startX+17.6*i,n=r.startY;e.beginPath(),e.moveTo(t,n),e.lineTo(t-10*r.scale,n),e.bezierCurveTo(t-8.8*r.scale,n+6.8*r.scale,t-10.54*r.scale,n+10.66*r.scale,t-17.6*r.scale,n+16*r.scale),e.lineTo(t-17.6*r.scale,n+17*r.scale),e.lineTo(t-3.6*r.scale,n+17*r.scale),e.lineTo(t-3.6*r.scale,n+22.4*r.scale),e.lineTo(t-5.6*r.scale,n+22.4*r.scale),e.lineTo(t-5.6*r.scale,n+23.4*r.scale),e.lineTo(t-5.6*r.scale,n+23.4*r.scale),e.lineTo(t+4.4*r.scale,n+23.4*r.scale),e.lineTo(t+4.4*r.scale,n+22.4*r.scale),e.lineTo(t+2.4*r.scale,n+22.4*r.scale),e.lineTo(t+2.4*r.scale,n+17*r.scale),e.lineTo(t+4.4*r.scale,n+17*r.scale),e.lineTo(t+4.4*r.scale,n+16*r.scale),e.lineTo(t+2.4*r.scale,n+16*r.scale),e.lineTo(t+2.4*r.scale,n+1.4*r.scale),e.lineTo(t-3.6*r.scale,n+7.2*r.scale),e.lineTo(t-3.6*r.scale,n+16*r.scale),e.lineTo(t-16.6*r.scale,n+16*r.scale),e.lineTo(t,n),e.fillStrokeShape(this)},fill:"black",stroke:"black",strokeWidth:0})),Euterpe.bind(this,n),n}}),e}();